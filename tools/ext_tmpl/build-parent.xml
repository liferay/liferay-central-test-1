<?xml version="1.0"?>

<project name="ext-parent">
	<import file="build-common.xml" />

	<target name="clean">
		<ant dir="ext-service" target="clean" inheritAll="false" />
		<ant dir="ext-ear" target="clean" inheritAll="false" />
		<ant dir="ext-impl" target="clean" inheritAll="false" />
		<ant dir="ext-web" target="clean" inheritAll="false" />

		<delete includeemptydirs="true" failonerror="false">
			<fileset dir="${app.server.bin.dir}" includes="*.log*,ActiveMQ/**,alf_data/**,console.out" />
		</delete>

		<if>
			<equals arg1="${app.server.type}" arg2="glassfish" />
			<then>
				<delete failonerror="false">
					<fileset
						dir="${app.server.dir}/domains/domain1/config"
						includes="${database.name}.*"
					/>
				</delete>
			</then>
			<elseif>
				<or>
					<equals arg1="${app.server.type}" arg2="jonas-jetty" />
					<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
				</or>
				<then>
					<delete failonerror="false">
						<fileset
							dir="${app.server.bin.dir}/nt"
							includes="${database.name}.*"
						/>
					</delete>
					<delete failonerror="false">
						<fileset
							dir="${app.server.bin.dir}/unix"
							includes="${database.name}.*"
						/>
					</delete>
				</then>
			</elseif>
			<else>
				<delete failonerror="false">
					<fileset
						dir="${app.server.bin.dir}"
						includes="${database.name}.*"
					/>
				</delete>
			</else>
		</if>

		<delete failonerror="false">
			<fileset
				dir="${app.server.classes.portal.dir}"
				includes="*-ext.properties"
			/>
		</delete>

		<delete includeemptydirs="true" failonerror="false">
			<fileset
				dir="${app.server.deploy.dir}"
				includes="cms-web*/**,laszlo-web*/**,sample*/**,tunnel-web*/**"
			/>
		</delete>

		<delete failonerror="false">
			<fileset
				dir="${app.server.lib.global.dir}"
				excludes="${jdbc.drivers}"
			/>
		</delete>

		<delete failonerror="false">
			<fileset
				dir="${app.server.lib.portal.dir}"
				excludes="${jdbc.drivers}"
			/>
		</delete>

		<if>
			<equals arg1="${clean.log.dir}" arg2="true" />
			<then>
				<delete dir="${app.server.log.dir}" />
			</then>
		</if>

		<delete dir="${app.server.portal.dir}" />
		<delete file="${app.server.portal.dir}" />

		<if>
			<equals arg1="${clean.temp.dir}" arg2="true" />
			<then>
				<delete dir="${app.server.temp.dir}" />
			</then>
		</if>

		<if>
			<equals arg1="${clean.work.dir}" arg2="true" />
			<then>
				<delete dir="${app.server.work.dir}" />
			</then>
		</if>
	</target>

	<target name="java2html">
		<delete dir="api" />

		<ant dir="ext-impl" target="java2html" inheritAll="false" />
	</target>

	<target name="javadoc">
		<ant dir="ext-impl" target="javadoc" inheritAll="false" />
	</target>

	<target name="deploy">
		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="glassfish" />
				<equals arg1="${app.server.type}" arg2="pramati" />
			</or>
			<then>
				<delete dir="${app.server.portal.dir}" />
				<delete file="${app.server.portal.dir}" />
			</then>
		</if>

		<ant dir="ext-service" target="deploy" inheritAll="false" />
		<ant dir="ext-ear" target="deploy" inheritAll="false" />
		<ant dir="ext-impl" target="deploy" inheritAll="false" />
		<ant dir="ext-web" target="deploy" inheritAll="false" />

		<ant dir="layouttpl" target="deploy" inheritAll="false" />
		<ant dir="portlets" target="deploy" inheritAll="false" />
		<ant dir="themes" target="deploy" inheritAll="false" />

		<if>
			<equals arg1="${app.server.type}" arg2="glassfish" />
			<then>
				<copy todir="${app.server.dir}/domains/domain1/config">
					<fileset dir="sql">
						<include name="${database.name}.properties" />
						<include name="${database.name}.script" />
					</fileset>
				</copy>
			</then>
			<elseif>
				<or>
					<equals arg1="${app.server.type}" arg2="jonas-jetty" />
					<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
				</or>
				<then>
					<copy todir="${app.server.bin.dir}/nt">
						<fileset dir="sql">
							<include name="${database.name}.properties" />
							<include name="${database.name}.script" />
						</fileset>
					</copy>
					<copy todir="${app.server.bin.dir}/unix">
						<fileset dir="sql">
							<include name="${database.name}.properties" />
							<include name="${database.name}.script" />
						</fileset>
					</copy>
				</then>
			</elseif>
			<else>
				<copy todir="${app.server.bin.dir}">
					<fileset dir="sql">
						<include name="${database.name}.properties" />
						<include name="${database.name}.script" />
					</fileset>
				</copy>
			</else>
		</if>

		<antcall target="deploy-properties" />

		<copy todir="${app.server.lib.global.dir}">
			<fileset dir="ext-lib/global" />
			<fileset dir="lib/development" includes="hsql.jar" />
			<fileset dir="lib/global" />
		</copy>

		<copy todir="${app.server.lib.portal.dir}">
			<fileset dir="ext-lib/portal" />
			<fileset dir="lib/portal" />
		</copy>


		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="jboss-jetty" />
				<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
			</or>
			<then>
				<delete>
					<fileset
						dir="${app.server.lib.portal.dir}"
						includes="log4j.jar"
					/>
				</delete>
			</then>
		</if>

		<if>
			<equals arg1="${app.server.type}" arg2="jetty" />
			<then>
				<copy todir="${app.server.lib.portal.dir}">
					<fileset
						dir="lib/development"
						includes="jms.jar,jta.jar"
					/>
				</copy>

				<delete>
					<fileset
						dir="${app.server.lib.portal.dir}"
						includes="jmx-remote.jar,jmx-ri.jar,xercesImpl.jar,xml-apis.jar"
					/>
				</delete>
			</then>
			<elseif>
				<equals arg1="${app.server.type}" arg2="resin" />
				<then>

					<!--
					Resin 3.0.19 needs Commons Logging and Log4J in the common
					class loader or else Resin will break when Commons Logging
					from one WAR tries to load Log4J from another WAR.
					-->

					<copy todir="${app.server.lib.global.dir}">
						<fileset
							dir="lib/portal"
							includes="commons-logging.jar,log4j.jar"
						/>
					</copy>

					<copy todir="${app.server.lib.global.dir}">
						<fileset
							dir="lib/development"
							includes="activation.jar,mail.jar"
						/>
					</copy>

					<copy todir="${app.server.dir}/lib">
						<fileset
							dir="lib/portal"
							includes="xercesImpl.jar,xml-apis.jar"
						/>
					</copy>
				</then>
			</elseif>
			<elseif>
				<equals arg1="${app.server.type}" arg2="tomcat" />
				<then>
					<copy todir="${app.server.dir}/server/lib">
						<fileset
							dir="lib/development"
							includes="support-tomcat.jar"
						/>
					</copy>

					<copy todir="${app.server.dir}/common/endorsed" flatten="true">
						<fileset
							dir="lib"
							includes="${endorsed.libraries}"
						/>
					</copy>

					<copy todir="${app.server.lib.global.dir}">
						<fileset
							dir="lib/development"
							includes="activation.jar,jms.jar,jta.jar,mail.jar"
						/>
					</copy>

					<move todir="${app.server.dir}/common/endorsed">
						<fileset
							dir="${app.server.lib.portal.dir}"
							includes="xercesImpl.jar"
						/>
					</move>
				</then>
			</elseif>
		</if>

		<mkdir dir="${app.server.log.dir}" />
		<mkdir dir="${app.server.temp.dir}" />
		<mkdir dir="${app.server.work.dir}" />

		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="jboss-jetty" />
				<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
			</or>
			<then>

				<!--
				JBoss 4.0.5 defaults to different versions of dom4j, Commons
				Collections, Commons HttpClient, and Hibernate.
				-->

				<copy todir="${app.server.dir}/lib" overwrite="yes">
					<fileset
						dir="lib/portal"
						includes="commons-codec.jar,commons-httpclient.jar,dom4j.jar,jaxen.jar"
					/>
				</copy>

				<copy todir="${app.server.instance.dir}/lib" overwrite="yes">
					<fileset
						dir="lib/portal"
						includes="commons-codec.jar,commons-collections.jar,commons-httpclient.jar"
					/>
				</copy>

				<delete>
					<fileset
						dir="${app.server.instance.dir}/lib"
						includes="hibernate3.jar,jboss-hibernate.jar"
					/>
				</delete>
			</then>
			<elseif>
				<equals arg1="${app.server.type}" arg2="jetty" />
				<then>

					<!--
					Jetty 5.1.10 defaults to a different version of Commons
					Logging and Hypersonic.
					-->

					<copy todir="${app.server.dir}/ext" overwrite="yes">
						<fileset
							dir="lib/portal"
							includes="commons-logging.jar"
						/>
					</copy>

					<delete file="${app.server.dir}/extra/ext/hsqldb.jar" />
				</then>
			</elseif>
		</if>


		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="glassfish" />
				<equals arg1="${app.server.type}" arg2="pramati" />
			</or>
			<then>
				<tstamp>
					<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
				</tstamp>

				<jar
					basedir="${app.server.portal.dir}"
					jarfile="${tstamp.value}"
				/>

				<delete dir="${app.server.portal.dir}" />

				<move file="${tstamp.value}" tofile="${app.server.portal.dir}" />
			</then>
		</if>
	</target>

	<target name="deploy-properties">
		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="glassfish" />
				<equals arg1="${app.server.type}" arg2="pramati" />
			</or>
			<then>
				<tstamp>
					<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
				</tstamp>

				<mkdir dir="${tstamp.value}" />

				<copy todir="${tstamp.value}" overwrite="yes">
					<fileset dir="ext-impl/classes">
						<include name="*-ext.properties" />
					</fileset>
				</copy>

				<if>
					<not>
						<available file="${tstamp.value}/portal-ext.properties" />
					</not>
					<then>
						<echo file="${tstamp.value}/portal-ext.properties" append="false">portal.release=enterprise

portal.ctx=/

auto.deploy.dest.dir=../webapps</echo>
					</then>
				</if>

				<if>
					<equals arg1="${app.server.type}" arg2="glassfish" />
					<then>
						<replace file="${tstamp.value}/portal-ext.properties">
							<replacetoken>auto.deploy.dest.dir=../webapps</replacetoken>
							<replacevalue>auto.deploy.dest.dir=../domains/domain1/autodeploy</replacevalue>
						</replace>
					</then>
					<elseif>
						<equals arg1="${app.server.type}" arg2="pramati" />
						<then>
							<replace file="${tstamp.value}/portal-ext.properties">
								<replacetoken>auto.deploy.dest.dir=../webapps</replacetoken>
								<replacevalue>auto.deploy.dest.dir=../nodes/liferay/archives/autodeploy</replacevalue>
							</replace>
						</then>
					</elseif>
				</if>

				<jar
					basedir="${tstamp.value}"
					destfile="${app.server.portal.dir}/portal-impl.jar"
					update="yes"
				/>

				<delete dir="${tstamp.value}" />
			</then>
			<else>
				<copy todir="${app.server.classes.portal.dir}" overwrite="yes">
					<fileset dir="ext-impl/classes">
						<include name="*-ext.properties" />
					</fileset>
				</copy>

				<if>
					<or>
						<equals arg1="${app.server.type}" arg2="jboss-jetty" />
						<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
						<equals arg1="${app.server.type}" arg2="jetty" />
						<equals arg1="${app.server.type}" arg2="oc4j" />
						<equals arg1="${app.server.type}" arg2="resin" />
						<equals arg1="${app.server.type}" arg2="tomcat" />
					</or>
					<then>
						<replace file="${app.server.classes.portal.dir}/portal-ext.properties">
							<replacetoken>portal.release=enterprise</replacetoken>
							<replacevalue>portal.release=professional</replacevalue>
						</replace>
					</then>
				</if>

				<if>
					<or>
						<equals arg1="${app.server.type}" arg2="jboss-jetty" />
						<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
					</or>
					<then>
						<replace file="${app.server.classes.portal.dir}/portal-ext.properties">
							<replacetoken>auto.deploy.dest.dir=../webapps</replacetoken>
							<replacevalue>auto.deploy.dest.dir=../server/default/deploy</replacevalue>
						</replace>
					</then>
					<elseif>
						<or>
							<equals arg1="${app.server.type}" arg2="jonas-jetty" />
							<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
						</or>
						<then>
							<replace file="${app.server.classes.portal.dir}/portal-ext.properties">
								<replacetoken>auto.deploy.dest.dir=../webapps</replacetoken>
								<replacevalue>auto.deploy.dest.dir=../../webapps/autoload</replacevalue>
							</replace>
						</then>
					</elseif>
					<elseif>
						<equals arg1="${app.server.type}" arg2="resin" />
						<then>
							<replace file="${app.server.classes.portal.dir}/portal-ext.properties">
								<replacetoken>auto.deploy.dest.dir=../webapps</replacetoken>
								<replacevalue>auto.deploy.dest.dir=webapps</replacevalue>
							</replace>
						</then>
					</elseif>
				</if>
			</else>
		</if>
	</target>
</project>