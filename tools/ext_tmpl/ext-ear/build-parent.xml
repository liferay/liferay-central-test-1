<?xml version="1.0"?>

<project name="ext-ear-parent">
	<import file="../build-common.xml" />

	<target name="clean">
		<delete>
			<fileset dir="." includes="*.ear,*.jar,*.war" />
		</delete>
	</target>

	<target name="deploy">
		<antcall target="deploy-ejb-jar">
			<param name="jar.file" value="counter-ejb" />
		</antcall>

		<antcall target="deploy-ejb-jar">
			<param name="jar.file" value="documentlibrary-ejb" />
		</antcall>

		<antcall target="deploy-ejb-jar">
			<param name="jar.file" value="lock-ejb" />
		</antcall>

		<antcall target="deploy-ejb-jar">
			<param name="jar.file" value="mail-ejb" />
		</antcall>

		<antcall target="deploy-ejb-jar">
			<param name="jar.file" value="portal-ejb" />
		</antcall>

		<antcall target="deploy-war">
			<param name="war.file" value="cms-web" />
		</antcall>

		<antcall target="deploy-war">
			<param name="war.file" value="laszlo-web" />
		</antcall>

		<antcall target="deploy-war">
			<param name="war.file" value="tunnel-web" />
		</antcall>
	</target>

	<target name="deploy-ejb-jar">
		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="jboss-jetty" />
				<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
			</or>
			<then>
				<unjar src="modules/${jar.file}.jar" dest="${app.server.portal.dir}/${jar.file}.jar" />
			</then>
			<elseif>
				<or>
					<equals arg1="${app.server.type}" arg2="jonas-jetty" />
					<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
				</or>
				<then>
					<copy file="modules/${jar.file}.jar" todir="${app.server.portal.dir}" />

					<jar
						basedir="."
						destfile="${app.server.portal.dir}/${jar.file}.jar"
						manifest="classes/META-INF/MANIFEST.MF.JOnAS"
						update="yes"
					/>
				</then>
			</elseif>
			<elseif>
				<equals arg1="${app.server.type}" arg2="orion" />
				<then>
					<copy file="modules/${jar.file}.jar" todir="${app.server.deploy.dir}" />
				</then>
			</elseif>
			<else>
				<copy file="modules/${jar.file}.jar" todir="${app.server.lib.portal.dir}" />
			</else>
		</if>		
	</target>

	<target name="deploy-war">
		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="jboss-jetty" />
				<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
				<equals arg1="${app.server.type}" arg2="jonas-jetty" />
				<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
			</or>
			<then>
				<property name="war.file.dest" value="${app.server.portal.dir}/${war.file}.war" />
			</then>
			<else>
				<property name="war.file.dest" value="${app.server.deploy.dir}/${war.file}" />
			</else>
		</if>

		<if>
			<equals arg1="${app.server.type}" arg2="orion" />
			<then>
				<copy file="modules/${war.file}.war" todir="${app.server.deploy.dir}" />
			</then>
			<else>
				<unwar src="modules/${war.file}.war" dest="${war.file.dest}" />
			</else>
		</if>

		<if>
			<equals arg1="${app.server.type}" arg2="jonas-jetty" />
			<then>
				<move
					file="${war.file.dest}/WEB-INF/web-jetty.xml.JOnAS_Jetty"
					tofile="${war.file.dest}/WEB-INF/web-jetty.xml"
				/>
			</then>
			<elseif>
				<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
				<then>
					<delete file="${war.file.dest}/META-INF/context.xml" />
				</then>
			</elseif>
		</if>
	</target>
</project>