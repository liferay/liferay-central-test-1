<?xml version="1.0"?>

<project name="ext-common">
	<property name="project.dir" value=".." />

	<property environment="env" />
	<property name="env.COMPUTERNAME" value="${env.HOSTNAME}"/>

	<property file="${project.dir}/app.server.${user.name}.properties" />
	<property file="${project.dir}/app.server.${env.COMPUTERNAME}.properties" />
	<property file="${project.dir}/app.server.ext.properties" />
	<property file="${project.dir}/app.server.properties" />

	<property file="${project.dir}/build.${user.name}.properties" />
	<property file="${project.dir}/build.${env.COMPUTERNAME}.properties" />
	<property file="${project.dir}/build.ext.properties" />
	<property file="${project.dir}/build.properties" />

	<property file="${project.dir}/sql/sql.${user.name}.properties" />
	<property file="${project.dir}/sql/sql.${env.COMPUTERNAME}.properties" />
	<property file="${project.dir}/sql/sql.ext.properties" />
	<property file="${project.dir}/sql/sql.properties" />

	<path id="lib.classpath">
		<fileset dir="${project.dir}/ext-lib/development" includes="*.jar" />
		<fileset dir="${project.dir}/ext-lib/global" includes="*.jar" />
		<fileset dir="${project.dir}/ext-lib/portal" includes="*.jar" />
		<fileset dir="${project.dir}/lib/development" includes="*.jar" />
		<fileset dir="${project.dir}/lib/global" includes="*.jar" />
		<fileset dir="${project.dir}/lib/portal" includes="*.jar" />
	</path>

	<path id="project.classpath">
		<pathelement path="${classpath}" />
		<path refid="lib.classpath" />
	</path>

	<path id="web.classpath">
		<pathelement location="${project.dir}/ext-service/classes" />
		<fileset dir="${project.dir}/lib/development" includes="ejb.jar,mail.jar,servlet.jar" />
		<fileset dir="${project.dir}/lib/global" includes="*.jar" />
		<path refid="web-lib.classpath" />
	</path>

	<taskdef classpathref="lib.classpath" resource="net/sf/antcontrib/antcontrib.properties" />
	<taskdef classpathref="lib.classpath" resource="axis-tasks.properties" />

	<property name="java2html.dir" value="${project.dir}/api/${ant.project.name}" />
	<property name="javadoc.dir" value="${project.dir}/api/${ant.project.name}" />

	<propertycopy name="app.server.dir" from="app.server.${app.server.type}.dir" />
	<propertycopy name="app.server.bin.dir" from="app.server.${app.server.type}.bin.dir" />
	<propertycopy name="app.server.classes.global.dir" from="app.server.${app.server.type}.classes.global.dir" />
	<propertycopy name="app.server.classes.portal.dir" from="app.server.${app.server.type}.classes.portal.dir" />
	<propertycopy name="app.server.deploy.archive.unpack" from="app.server.${app.server.type}.deploy.archive.unpack" silent="true" />
	<propertycopy name="app.server.deploy.archive.type" from="app.server.${app.server.type}.deploy.archive.type" silent="true" />
	<propertycopy name="app.server.deploy.dir" from="app.server.${app.server.type}.deploy.dir" />
	<propertycopy name="app.server.ejbgen.compile" from="app.server.${app.server.type}.ejbgen.compile" silent="true" />
	<propertycopy name="app.server.ejbgen.protocols" from="app.server.${app.server.type}.ejbgen.protocols" silent="true" />
	<propertycopy name="app.server.ejbgen.version" from="app.server.${app.server.type}.ejbgen.version" silent="true" />
	<propertycopy name="app.server.lib.global.dir" from="app.server.${app.server.type}.lib.global.dir" />
	<propertycopy name="app.server.lib.portal.dir" from="app.server.${app.server.type}.lib.portal.dir" />
	<propertycopy name="app.server.portal.dir" from="app.server.${app.server.type}.portal.dir" />
	<propertycopy name="app.server.log.dir" from="app.server.${app.server.type}.log.dir" />
	<propertycopy name="app.server.temp.dir" from="app.server.${app.server.type}.temp.dir" />
	<propertycopy name="app.server.work.dir" from="app.server.${app.server.type}.work.dir" />

	<target name="setproxy" if="setproxy.proxy.host">
		<setproxy proxyhost="${setproxy.proxy.host}" proxyport="${setproxy.proxy.port}" />
	</target>

	<target name="deploy-ejb-jar">
		<if>
			<and>
				<or>
					<equals arg1="${app.server.type}" arg2="jboss-jetty" />
					<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
				</or>
				<and>
					<equals arg1="${app.server.deploy.archive.unpack}" arg2="true" />
					<equals arg1="${app.server.deploy.archive.type}" arg2="ear" />
				</and>
			</and>
			<then>
				<unjar src="${modules.dir}${jar.file}.jar" dest="${app.server.portal.dir}/${jar.file}.jar" />
			</then>
			<elseif>
				<or>
					<equals arg1="${app.server.type}" arg2="jonas-jetty" />
					<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
				</or>
				<then>
					<unjar src="${modules.dir}${jar.file}.jar" dest="${app.server.portal.dir}/${jar.file}.jar" />

					<copy
						file="${app.server.portal.dir}/${jar.file}.jar/META-INF/MANIFEST.MF.JOnAS"
						tofile="${app.server.portal.dir}/${jar.file}.jar/META-INF/MANIFEST.MF"
						overwrite="yes"
					/>
				</then>
			</elseif>
			<elseif>
				<or>
					<equals arg1="${app.server.type}" arg2="glassfish" />
					<and>
						<or>
							<equals arg1="${app.server.type}" arg2="jboss-jetty" />
							<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
						</or>
						<and>
							<equals arg1="${app.server.deploy.archive.unpack}" arg2="false" />
							<equals arg1="${app.server.deploy.archive.type}" arg2="ear" />
						</and>
					</and>
					<equals arg1="${app.server.type}" arg2="pramati" />
				</or>
				<then>
					<copy file="${modules.dir}${jar.file}.jar" todir="${app.server.portal.dir}" />
				</then>
			</elseif>
			<elseif>
				<equals arg1="${app.server.type}" arg2="orion" />
				<then>
					<copy file="${modules.dir}${jar.file}.jar" todir="${app.server.deploy.dir}" />
				</then>
			</elseif>
			<else>
				<copy file="${modules.dir}${jar.file}.jar" todir="${app.server.lib.portal.dir}" />
			</else>
		</if>		
	</target>

	<target name="deploy-war">
		<if>
			<or>
				<and>
					<or>
						<equals arg1="${app.server.type}" arg2="jboss-jetty" />
						<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
					</or>
					<equals arg1="${app.server.deploy.archive.type}" arg2="ear" />
				</and>
				<equals arg1="${app.server.type}" arg2="jonas-jetty" />
				<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
			</or>
			<then>
				<if>
					<equals arg1="${war.file}" arg2="ext-web" />
					<then>
						<property name="war.file.dest" value="${app.server.portal.dir}/portal-web.war" />
					</then>
					<else>
						<property name="war.file.dest" value="${app.server.portal.dir}/${war.file}.war" />
					</else>
				</if>
			</then>
			<else>
				<if>
					<equals arg1="${war.file}" arg2="ext-web" />
					<then>
						<if>
							<equals arg1="${app.server.type}" arg2="jetty" />
							<then>
								<property name="war.file.dest" value="${app.server.deploy.dir}/root" />
							</then>
							<elseif>
								<or>
									<equals arg1="${app.server.type}" arg2="resin" />
									<equals arg1="${app.server.type}" arg2="tomcat" />
								</or>
								<then>
									<property name="war.file.dest" value="${app.server.deploy.dir}/ROOT" />
								</then>
							</elseif>
							<else>
								<property name="war.file.dest" value="${app.server.portal.dir}" />
							</else>
						</if>
					</then>
					<else>
						<if>
							<and>
								<or>
									<equals arg1="${app.server.type}" arg2="jboss-jetty" />
									<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
								</or>
								<equals arg1="${app.server.deploy.archive.type}" arg2="war" />
							</and>
							<then>
								<property name="war.file.dest" value="${app.server.deploy.dir}/${war.file}.war" />
							</then>
							<else>
								<property name="war.file.dest" value="${app.server.deploy.dir}/${war.file}" />
							</else>
						</if>
					</else>
				</if>
			</else>
		</if>

		<if>
			<equals arg1="${app.server.type}" arg2="orion" />
			<then>
				<copy file="${modules.dir}${war.file}.war" todir="${app.server.deploy.dir}" />
			</then>
			<elseif>
				<or>
					<equals arg1="${app.server.type}" arg2="glassfish" />
					<and>
						<or>
							<equals arg1="${app.server.type}" arg2="jboss-jetty" />
							<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
						</or>
						<and>
							<equals arg1="${app.server.deploy.archive.unpack}" arg2="false" />
							<equals arg1="${app.server.deploy.archive.type}" arg2="ear" />
						</and>
					</and>
					<equals arg1="${app.server.type}" arg2="pramati" />
				</or>
				<then>
					<if>
						<equals arg1="${war.file}" arg2="ext-web" />
						<then>
							<copy file="${modules.dir}${war.file}.war" tofile="${app.server.portal.dir}/portal-web.war" />

							<war
								basedir="${project.dir}/web-sites/liferay.com-web/docroot"
								destfile="${app.server.portal.dir}/portal-web.war"
								excludes="WEB-INF/web.xml"
								webxml="${project.dir}/web-sites/liferay.com-web/docroot/WEB-INF/web.xml"
								update="yes"
							/>
						</then>
						<else>
							<copy file="${modules.dir}${war.file}.war" todir="${app.server.portal.dir}" />
						</else>
					</if>
				</then>
			</elseif>
			<else>
				<if>
					<available file="${war.file.dest}" type="file" />
					<then>
						<delete file="${war.file.dest}" />
					</then>
				</if>

				<unwar src="${modules.dir}${war.file}.war" dest="${war.file.dest}" />

				<if>
					<equals arg1="${war.file}" arg2="ext-web" />
					<then>
						<copy todir="${war.file.dest}" overwrite="yes">
							<fileset dir="${project.dir}/web-sites/liferay.com-web/docroot" />
						</copy>
					</then>
				</if>
			</else>
		</if>

		<if>
			<or>
				<and>
					<or>
						<equals arg1="${app.server.type}" arg2="jboss-jetty" />
						<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
					</or>
					<equals arg1="${app.server.deploy.archive.type}" arg2="war" />
				</and>
				<equals arg1="${app.server.type}" arg2="jetty" />
				<equals arg1="${app.server.type}" arg2="resin" />
				<equals arg1="${app.server.type}" arg2="tomcat" />
			</or>
			<then>
				<java
					classname="com.liferay.portal.tools.WebXMLStripper"
					classpathref="project.classpath"
					fork="true"
					newenvironment="true"
				>
					<arg value="${war.file.dest}/WEB-INF/web.xml" />
				</java>
			</then>
		</if>

		<if>
			<equals arg1="${app.server.type}" arg2="jonas-jetty" />
			<then>
				<copy
					file="${war.file.dest}/WEB-INF/web-jetty.xml.jonas-jetty"
					tofile="${war.file.dest}/WEB-INF/web-jetty.xml"
					overwrite="yes"
					failonerror="false"
				/>
			</then>
			<elseif>
				<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
				<then>
					<delete file="${war.file.dest}/META-INF/context.xml" />
				</then>
			</elseif>
		</if>

		<if>
			<equals arg1="${war.file}" arg2="tunnel-web" />
			<then>
				<if>
					<or>
						<equals arg1="${app.server.type}" arg2="glassfish" />
						<equals arg1="${app.server.type}" arg2="pramati" />
					</or>
					<then>
						<tstamp>
							<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
						</tstamp>

						<mkdir dir="${tstamp.value}" />

						<unjar
							src="${modules.dir}${war.file}.war"
							dest="${tstamp.value}"
						>
							<patternset>
								<include name="**/server-config.wsdd" />
							</patternset>
						</unjar>

						<java
							classname="com.liferay.portal.tools.WSDDMerger"
							classpathref="project.classpath"
							fork="true"
							maxmemory="256m"
							newenvironment="true"
						>
							<arg value="${project.dir}/ext-web/docroot/WEB-INF/server-config.wsdd" />
							<arg value="${tstamp.value}/WEB-INF/server-config.wsdd" />
						</java>

						<jar
							basedir="${tstamp.value}"
							destfile="${app.server.portal.dir}/${war.file}.war"
							update="yes"
						/>

						<delete dir="${tstamp.value}" />
					</then>
					<else>
						<java
							classname="com.liferay.portal.tools.WSDDMerger"
							classpathref="project.classpath"
							fork="true"
							maxmemory="256m"
							newenvironment="true"
						>
							<arg value="${project.dir}/ext-web/docroot/WEB-INF/server-config.wsdd" />
							<arg value="${war.file.dest}/WEB-INF/server-config.wsdd" />
						</java>
					</else>
				</if>
			</then>
		</if>

		<if>
			<and>
				<or>
					<equals arg1="${app.server.type}" arg2="jboss-jetty" />
					<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
				</or>
				<and>
					<equals arg1="${app.server.deploy.archive.unpack}" arg2="false" />
					<equals arg1="${app.server.deploy.archive.type}" arg2="war" />
				</and>
			</and>
			<then>
				<if>
					<not>
						<equals arg1="${war.file}" arg2="ext-web" />
					</not>
					<then>
						<tstamp>
							<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
						</tstamp>

						<jar
							basedir="${war.file.dest}"
							jarfile="${tstamp.value}"
						/>

						<delete dir="${war.file.dest}" />

						<move file="${tstamp.value}" tofile="${war.file.dest}" />
					</then>
				</if>
			</then>
		</if>
	</target>
</project>