<?xml version="1.0"?>

<project name="portal-test-db-sql-server" basedir="." default="test" xmlns:antelope="antlib:ise.antelope.tasks">
	<import file="build-test.xml" />

	<target name="prepare-db-sql-server-common">
		<echo file="test.${user.name}.properties">db.type=sql-server</echo>

		<antcall target="prepare-portal-ext-properties" inheritAll="false" />

		<ant dir="portal-impl" target="deploy-properties" inheritAll="false" />

		<if>
			<isset property="sql.version" />
			<then>
				<property name="sql.dir" value="sql\legacy\${sql.version}\create\" />
				<property name="sql.file" value="create-sql-server.sql" />
			</then>
		</if>

		<antcall target="rebuild-database" inheritAll="false">
			<param name="sql.dir" value="${sql.dir}" />
			<param name="sql.file" value="${sql.file}" />
		</antcall>
	</target>

	<target name="run-latest-upgrade-test">
		<ant antfile="build-test-tomcat.xml" target="run-selenium-tomcat" inheritAll="false">
			<property name="skip.rebuild-database" value="true" />
		</ant>

		<antcall target="clean-up-bundles" />
	</target>

	<target name="run-smoke-test">
		<ant antfile="build-test-tomcat.xml" target="run-selenium-tomcat" inheritAll="false">
			<property name="skip.rebuild-database" value="true" />
			<property name="test.name" value="SmokeTestSuite" />
		</ant>
	</target>

	<target name="run-versioned-upgrade-test">
		<ant antfile="build-test-tomcat.xml" target="run-selenium-versioned-tomcat" inheritAll="false">
			<property name="skip.rebuild-database" value="true" />
		</ant>

		<antcall target="clean-up-bundles" />
	</target>

	<target name="test-db-sql-server-5.1.0-data-upgrade-test">
		<antcall target="prepare-db-sql-server-common">
			<param name="skip.prepare-bundle" value="true" />
			<param name="sql.version" value="5.1.0" />
		</antcall>

		<antcall target="run-versioned-upgrade-test">
			<param name="file.name" value="liferay-portal-tomcat-6.0-5.1.0.zip" />
			<param name="legacy.config" value="true" />
			<param name="legacy.theme.ids" value="classic" />
			<param name="license.type" value="ce" />
			<param name="lp.version" value="5.1.0" />
			<param name="test.name" value="SampleData510TestSuite" />
			<param name="tomcat.folder.dir" value="liferay-portal-tomcat-6.0-5.1.0" />
		</antcall>

		<antcall target="prepare-db-sql-server-common">
			<param name="custom.properties" value="permissions.user.check.algorithm=5" />
			<param name="skip.prepare-bundle" value="true" />
			<param name="skip.rebuild-database" value="true" />
			<param name="sql.version" value="5.1.0" />
		</antcall>

		<antcall target="run-latest-upgrade-test">
			<param name="custom.properties" value="permissions.user.check.algorithm=5" />
			<param name="portlet.plugins.includes" value="web-form-portlet" />
			<param name="test.name" value="ViewSampleData510LatestTestSuite" />
		</antcall>
	</target>

	<target name="test-db-sql-server-5.1.0-smoke-test">
		<antcall target="prepare-db-sql-server-common">
			<param name="skip.prepare-bundle" value="true" />
			<param name="sql.version" value="5.1.0" />
		</antcall>

		<antcall target="run-smoke-test">
			<param name="build.app.server" value="false" />
		</antcall>
	</target>

	<target name="test-db-sql-server-5.1.1-data-upgrade-test">
		<antcall target="prepare-db-sql-server-common">
			<param name="skip.prepare-bundle" value="true" />
			<param name="sql.version" value="5.1.1" />
		</antcall>

		<antcall target="run-versioned-upgrade-test">
			<param name="file.name" value="liferay-portal-tomcat-6.0-5.1.1.zip" />
			<param name="legacy.config" value="true" />
			<param name="legacy.theme.ids" value="classic" />
			<param name="license.type" value="ce" />
			<param name="lp.version" value="5.1.1" />
			<param name="test.name" value="SampleData511TestSuite" />
			<param name="tomcat.folder.dir" value="liferay-portal-tomcat-6.0-5.1.1" />
		</antcall>

		<antcall target="prepare-db-sql-server-common">
			<param name="custom.properties" value="permissions.user.check.algorithm=5" />
			<param name="skip.prepare-bundle" value="true" />
			<param name="skip.rebuild-database" value="true" />
			<param name="sql.version" value="5.1.1" />
		</antcall>

		<antcall target="run-latest-upgrade-test">
			<param name="custom.properties" value="permissions.user.check.algorithm=5" />
			<param name="portlet.plugins.includes" value="web-form-portlet" />
			<param name="test.name" value="ViewSampleData511LatestTestSuite" />
		</antcall>
	</target>

	<target name="test-db-sql-server-5.1.1-smoke-test">
		<antcall target="prepare-db-sql-server-common">
			<param name="skip.prepare-bundle" value="true" />
			<param name="sql.version" value="5.1.1" />
		</antcall>

		<antcall target="run-smoke-test">
			<param name="build.app.server" value="false" />
		</antcall>
	</target>

	<target name="test-db-sql-server-5.1.2-data-upgrade-test">
		<antcall target="prepare-db-sql-server-common">
			<param name="skip.prepare-bundle" value="true" />
			<param name="sql.version" value="5.1.2" />
		</antcall>

		<antcall target="run-versioned-upgrade-test">
			<param name="file.name" value="liferay-portal-tomcat-6.0-5.1.2.zip" />
			<param name="legacy.config" value="true" />
			<param name="legacy.theme.ids" value="classic" />
			<param name="license.type" value="ce" />
			<param name="lp.version" value="5.1.2" />
			<param name="test.name" value="SampleData512TestSuite" />
			<param name="tomcat.folder.dir" value="liferay-portal-tomcat-6.0-5.1.2" />
		</antcall>

		<antcall target="prepare-db-sql-server-common">
			<param name="custom.properties" value="permissions.user.check.algorithm=5" />
			<param name="skip.prepare-bundle" value="true" />
			<param name="skip.rebuild-database" value="true" />
			<param name="sql.version" value="5.1.2" />
		</antcall>

		<antcall target="run-latest-upgrade-test">
			<param name="custom.properties" value="permissions.user.check.algorithm=5" />
			<param name="portlet.plugins.includes" value="web-form-portlet" />
			<param name="test.name" value="ViewSampleData512LatestTestSuite" />
		</antcall>
	</target>

	<target name="test-db-sql-server-5.1.2-smoke-test">
		<antcall target="prepare-db-sql-server-common">
			<param name="skip.prepare-bundle" value="true" />
			<param name="sql.version" value="5.1.2" />
		</antcall>

		<antcall target="run-smoke-test">
			<param name="build.app.server" value="false" />
		</antcall>
	</target>

	<target name="test-db-sql-server-5.2.0-data-upgrade-test">
		<antcall target="prepare-db-sql-server-common">
			<param name="skip.prepare-bundle" value="true" />
			<param name="sql.version" value="5.2.0" />
		</antcall>

		<antcall target="run-versioned-upgrade-test">
			<param name="file.name" value="liferay-portal-tomcat-6.0-5.2.0.zip" />
			<param name="legacy.theme.ids" value="classic,controlpanel" />
			<param name="license.type" value="ce" />
			<param name="lp.version" value="5.2.0" />
			<param name="test.name" value="SampleData520TestSuite" />
			<param name="tomcat.folder.dir" value="liferay-portal-5.2.0/tomcat-6.0.18" />
		</antcall>

		<antcall target="prepare-db-sql-server-common">
			<param name="custom.properties" value="permissions.user.check.algorithm=5" />
			<param name="skip.prepare-bundle" value="true" />
			<param name="skip.rebuild-database" value="true" />
			<param name="sql.version" value="5.2.0" />
		</antcall>

		<antcall target="run-latest-upgrade-test">
			<param name="custom.properties" value="permissions.user.check.algorithm=5" />
			<param name="test.name" value="ViewSampleData520LatestTestSuite" />
		</antcall>
	</target>

	<target name="test-db-sql-server-5.2.0-smoke-test">
		<antcall target="prepare-db-sql-server-common">
			<param name="skip.prepare-bundle" value="true" />
			<param name="sql.version" value="5.2.0" />
		</antcall>

		<antcall target="run-smoke-test">
			<param name="build.app.server" value="false" />
		</antcall>
	</target>

	<target name="test-db-sql-server-5.2.1-data-upgrade-test">
		<antcall target="prepare-db-sql-server-common">
			<param name="skip.prepare-bundle" value="true" />
			<param name="sql.version" value="5.2.1" />
		</antcall>

		<antcall target="run-versioned-upgrade-test">
			<param name="deploy.versioned.plugins" value="true" />
			<param name="file.name" value="liferay-portal-tomcat-6.0-5.2.1.zip" />
			<param name="legacy.theme.ids" value="classic,controlpanel" />
			<param name="license.type" value="ce" />
			<param name="lp.version" value="5.2.1" />
			<param name="test.name" value="SampleData521TestSuite" />
			<param name="tomcat.folder.dir" value="liferay-portal-5.2.1/tomcat-6.0.18" />
		</antcall>

		<antcall target="prepare-db-sql-server-common">
			<param name="custom.properties" value="permissions.user.check.algorithm=5" />
			<param name="skip.prepare-bundle" value="true" />
			<param name="skip.rebuild-database" value="true" />
			<param name="sql.version" value="5.2.1" />
		</antcall>

		<antcall target="run-latest-upgrade-test">
			<param name="custom.properties" value="permissions.user.check.algorithm=5" />
			<param name="portlet.plugins.includes" value="web-form-portlet" />
			<param name="test.name" value="ViewSampleData521LatestTestSuite" />
		</antcall>
	</target>

	<target name="test-db-sql-server-5.2.1-smoke-test">
		<antcall target="prepare-db-sql-server-common">
			<param name="skip.prepare-bundle" value="true" />
			<param name="sql.version" value="5.2.1" />
		</antcall>

		<antcall target="run-smoke-test">
			<param name="build.app.server" value="false" />
		</antcall>
	</target>

	<target name="test-db-sql-server-5.2.2-data-upgrade-test">
		<antcall target="prepare-db-sql-server-common">
			<param name="skip.prepare-bundle" value="true" />
			<param name="sql.version" value="5.2.2" />
		</antcall>

		<antcall target="run-versioned-upgrade-test">
			<param name="deploy.versioned.plugins" value="true" />
			<param name="file.name" value="liferay-portal-tomcat-6.0-5.2.2.zip" />
			<param name="legacy.theme.ids" value="classic,controlpanel" />
			<param name="license.type" value="ce" />
			<param name="lp.version" value="5.2.2" />
			<param name="test.name" value="SampleData522TestSuite" />
			<param name="tomcat.folder.dir" value="liferay-portal-5.2.2/tomcat-6.0.18" />
		</antcall>

		<antcall target="prepare-db-sql-server-common">
			<param name="custom.properties" value="permissions.user.check.algorithm=5" />
			<param name="skip.prepare-bundle" value="true" />
			<param name="skip.rebuild-database" value="true" />
			<param name="sql.version" value="5.2.2" />
		</antcall>

		<antcall target="run-latest-upgrade-test">
			<param name="custom.properties" value="permissions.user.check.algorithm=5" />
			<param name="portlet.plugins.includes" value="web-form-portlet" />
			<param name="test.name" value="ViewSampleData522LatestTestSuite" />
		</antcall>
	</target>

	<target name="test-db-sql-server-5.2.2-smoke-test">
		<antcall target="prepare-db-sql-server-common">
			<param name="skip.prepare-bundle" value="true" />
			<param name="sql.version" value="5.2.2" />
		</antcall>

		<antcall target="run-smoke-test">
			<param name="build.app.server" value="false" />
		</antcall>
	</target>

	<target name="test-db-sql-server-5.2.3-data-upgrade-test">
		<antcall target="prepare-db-sql-server-common">
			<param name="skip.prepare-bundle" value="true" />
			<param name="sql.version" value="5.2.3" />
		</antcall>

		<antcall target="run-versioned-upgrade-test">
			<param name="file.name" value="liferay-portal-tomcat-6.0-5.2.3.zip" />
			<param name="legacy.theme.ids" value="classic,controlpanel" />
			<param name="license.type" value="ce" />
			<param name="lp.version" value="5.2.3" />
			<param name="test.name" value="SampleData523TestSuite" />
			<param name="tomcat.folder.dir" value="liferay-portal-5.2.3/tomcat-6.0.18" />
		</antcall>

		<antcall target="prepare-db-sql-server-common">
			<param name="custom.properties" value="permissions.user.check.algorithm=5" />
			<param name="skip.prepare-bundle" value="true" />
			<param name="skip.rebuild-database" value="true" />
			<param name="sql.version" value="5.2.3" />
		</antcall>

		<antcall target="run-latest-upgrade-test">
			<param name="custom.properties" value="permissions.user.check.algorithm=5" />
			<param name="test.name" value="ViewSampleData523LatestTestSuite" />
		</antcall>
	</target>

	<target name="test-db-sql-server-5.2.3-smoke-test">
		<antcall target="prepare-db-sql-server-common">
			<param name="skip.prepare-bundle" value="true" />
			<param name="sql.version" value="5.2.3" />
		</antcall>

		<antcall target="run-smoke-test">
			<param name="build.app.server" value="false" />
		</antcall>
	</target>

	<target name="test-db-sql-server-5.2.7-data-upgrade-test">
		<antcall target="prepare-db-sql-server-common">
			<param name="skip.prepare-bundle" value="true" />
			<param name="sql.version" value="5.2.7" />
		</antcall>

		<antcall target="run-versioned-upgrade-test">
			<param name="deploy.versioned.plugins" value="true" />
			<param name="ee.deploy.dir" value="liferay-portal-5.2-ee-sp3/deploy" />
			<param name="ee.license.dir" value="liferay-portal-5.2-ee-sp3/ee" />
			<param name="file.name" value="liferay-portal-tomcat-6.0-5.2-ee-sp3.zip" />
			<param name="legacy.theme.ids" value="classic,controlpanel" />
			<param name="license.type" value="ee" />
			<param name="lp.version" value="5.2.7" />
			<param name="test.name" value="SampleData527TestSuite" />
			<param name="tomcat.folder.dir" value="liferay-portal-5.2-ee-sp3/tomcat-6.0.18" />
		</antcall>

		<antcall target="prepare-db-sql-server-common">
			<param name="custom.properties" value="upgrade.processes=com.liferay.portal.upgrade.UpgradeProcess_5_2_7_to_6_0_0${line.separator}com.liferay.portal.upgrade.UpgradeProcess_6_0_1${line.separator}com.liferay.portal.upgrade.UpgradeProcess_6_0_2${line.separator}permissions.user.check.algorithm=5${line.separator}image.hook.impl=com.liferay.portal.image.DatabaseHook" />
			<param name="skip.prepare-bundle" value="true" />
			<param name="skip.rebuild-database" value="true" />
			<param name="sql.version" value="5.2.7" />
		</antcall>

		<antcall target="run-latest-upgrade-test">
			<param name="custom.properties" value="upgrade.processes=com.liferay.portal.upgrade.UpgradeProcess_5_2_7_to_6_0_0${line.separator}com.liferay.portal.upgrade.UpgradeProcess_6_0_1${line.separator}permissions.user.check.algorithm=5" />
			<param name="portlet.plugins.includes" value="web-form-portlet" />
			<param name="test.name" value="ViewSampleData527LatestTestSuite" />
		</antcall>
	</target>

	<target name="test-db-sql-server-5.2.7-smoke-test">
		<antcall target="prepare-db-sql-server-common">
			<param name="skip.prepare-bundle" value="true" />
			<param name="sql.version" value="5.2.7" />
		</antcall>

		<antcall target="run-smoke-test">
			<param name="custom.properties" value="upgrade.processes=com.liferay.portal.upgrade.UpgradeProcess_5_2_7_to_6_0_0${line.separator}com.liferay.portal.upgrade.UpgradeProcess_6_0_1${line.separator}com.liferay.portal.upgrade.UpgradeProcess_6_0_2" />
			<param name="build.app.server" value="false" />
		</antcall>
	</target>

	<target name="test-db-sql-server-6.0.0-data-upgrade-test">
		<antcall target="prepare-db-sql-server-common">
			<param name="skip.prepare-bundle" value="true" />
			<param name="sql.version" value="6.0.0" />
		</antcall>

		<antcall target="run-versioned-upgrade-test">
			<param name="deploy.versioned.plugins" value="true" />
			<param name="ee.deploy.dir" value="liferay-portal-6.0.0/deploy" />
			<param name="file.name" value="liferay-portal-tomcat-6.0.0.zip" />
			<param name="license.type" value="ce" />
			<param name="lp.version" value="6.0.0" />
			<param name="test.name" value="SampleData600TestSuite" />
			<param name="tomcat.folder.dir" value="liferay-portal-6.0.0/tomcat-6.0.26" />
		</antcall>

		<antcall target="run-latest-upgrade-test">
			<param name="portlet.plugins.includes" value="web-form-portlet" />
			<param name="test.name" value="ViewSampleData600LatestTestSuite" />
		</antcall>
	</target>

	<target name="test-db-sql-server-6.0.0-smoke-test">
		<antcall target="prepare-db-sql-server-common">
			<param name="skip.prepare-bundle" value="true" />
			<param name="sql.version" value="6.0.0" />
		</antcall>

		<antcall target="run-smoke-test">
			<param name="build.app.server" value="false" />
		</antcall>
	</target>

	<target name="test-db-sql-server-latest-smoke-test">
		<echo file="create-${db.sql-server.schema}.sql">drop database lportal;
create database lportal;</echo>

		<antcall target="prepare-db-sql-server-common">
			<param name="skip.prepare-bundle" value="true" />
			<param name="sql.dir" value="" />
			<param name="sql.file" value="create-${db.sql-server.schema}.sql" />
		</antcall>

		<antcall target="run-smoke-test">
			<param name="build.app.server" value="false" />
		</antcall>
	</target>

	<target name="test-db-sql-server-smoke-test">
		<antcall target="prepare-sql-server" />

		<ant antfile="build-dist.xml" target="build-dist-tomcat" />

		<antcall target="test-db-sql-server-latest-smoke-test" />
		<antcall target="test-db-sql-server-5.1.0-smoke-test" />
		<antcall target="test-db-sql-server-5.1.1-smoke-test" />
		<antcall target="test-db-sql-server-5.1.2-smoke-test" />
		<antcall target="test-db-sql-server-5.2.0-smoke-test" />
		<antcall target="test-db-sql-server-5.2.1-smoke-test" />
		<antcall target="test-db-sql-server-5.2.2-smoke-test" />
		<antcall target="test-db-sql-server-5.2.3-smoke-test" />
	</target>
</project>