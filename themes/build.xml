<?xml version="1.0"?>

<project name="themes" basedir="." default="deploy" xmlns:antelope="antlib:ise.antelope.tasks">
	<import file="../build-common.xml" />

	<target name="clean">
		<antcall target="loop-modules">
			<param name="loop.modules.cmd" value="clean-module" />
		</antcall>
	</target>

	<target name="clean-module">
		<delete includeemptydirs="true" quiet="true" failonerror="false">
			<fileset
				dir="${module.name}.war"
				excludes="_diffs/**,WEB-INF/**"
			/>
		</delete>
	</target>

	<target name="compile">
		<antcall target="loop-modules">
			<param name="loop.modules.cmd" value="compile-module" />
		</antcall>
	</target>

	<target name="compile-module">
		<copy todir="${module.name}.war">
			<fileset
				dir="${project.dir}/portal-web/docroot/html/themes/_common"
				excludes="templates/init.vm"
			/>
		</copy>

		<if>
			<available file="${module.name}.war/_diffs" />
			<then>
				<copy todir="${module.name}.war" overwrite="yes">
					<fileset
						dir="${module.name}.war/_diffs"
					/>
				</copy>
			</then>
		</if>
	</target>

	<target name="war" depends="compile">
		<antcall target="loop-modules">
			<param name="loop.modules.cmd" value="war-module" />
		</antcall>
	</target>

	<target name="war-module">
		<jar
			basedir="${module.name}.war"
			destfile="${project.dir}/${module.name}-${lp.version.file.name}.war"
		/>
	</target>

	<target name="deploy" depends="compile">
		<antcall target="loop-modules">
			<param name="loop.modules.cmd" value="deploy-module" />
		</antcall>
	</target>

	<target name="deploy-module">
		<tstamp>
			<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
		</tstamp>

		<jar
			basedir="${module.name}.war"
			destfile="${tstamp.value}"
			excludes="_diffs/**"
		/>

		<move file="${tstamp.value}" tofile="${auto.deploy.dir}/${module.name}.war" />
	</target>

	<target name="loop-modules">
		<for param="module.name">
			<path>
				<dirset dir="." excludes="${deploy.wars.excludes}" includes="${deploy.wars.includes}" />
			</path>
			<sequential>
				<antelope:grep in="@{module.name}" regex="(.*\\)(.*)(\.war)" group="2" property="module.name" />

				<antcall target="${loop.modules.cmd}" />
			</sequential>
		</for>
	</target>
</project>