<?xml version="1.0"?>

<project name="themes" basedir="." default="deploy" xmlns:antelope="antlib:ise.antelope.tasks">
	<import file="../build-common.xml" />

	<target name="clean">
		<antcall target="loop-modules">
			<param name="loop.modules.cmd" value="clean" />
		</antcall>
	</target>

	<target name="clean-module">
		<delete includeemptydirs="true" quiet="true" failonerror="false">
			<fileset
				dir="${module.name}.war"
				excludes="_diffs/**,WEB-INF/**"
			/>
		</delete>
	</target>

	<target name="war" depends="merge">
		<antcall target="loop-modules">
			<param name="loop.modules.cmd" value="war" />
		</antcall>
	</target>

	<target name="war-module">
		<jar
			basedir="${module.name}.war"
			destfile="${project.dir}/${module.name}-${lp.version.file.name}.war"
		/>
	</target>

	<target name="deploy" depends="merge">
		<antcall target="loop-modules">
			<param name="loop.modules.cmd" value="deploy" />
		</antcall>
	</target>

	<target name="deploy-module">
		<tstamp>
			<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
		</tstamp>

		<jar
			basedir="${module.name}.war"
			destfile="${tstamp.value}"
			excludes="_diffs/**"
		/>

		<move file="${tstamp.value}" tofile="${auto.deploy.dir}/${module.name}.war" />
	</target>

	<target name="loop-modules">
		<for param="module.name">
			<path>
				<dirset dir="." includes="*.war" />
			</path>
			<sequential>
				<antelope:stringutil string="@{module.name}" property="module.name.beginindex">
					<lastindexof string="${file.separator}" />
				</antelope:stringutil>

				<math
					datatype="int"
					operand1="${module.name.beginindex}"
					operand2="1"
					operation="+"
					result="module.name.beginindex"
				/>

				<antelope:stringutil string="@{module.name}" property="module.name.endindex">
					<lastindexof string=".war" />
				</antelope:stringutil>

				<antelope:stringutil string="@{module.name}" property="module.name">
					<substring beginindex="${module.name.beginindex}" endindex="${module.name.endindex}" />
				</antelope:stringutil>

				<if>
					<or>
						<equals arg1="${deploy.specific.wars}" arg2="" />
						<antelope:contains string="${deploy.specific.wars}" substring="${module.name}" />
					</or>
					<then>
						<if>
							<equals arg1="${loop.modules.cmd}" arg2="clean" />
							<then>
								<antcall target="clean-module" />
							</then>
							<elseif>
								<equals arg1="${loop.modules.cmd}" arg2="war" />
								<then>
									<antcall target="war-module" />
								</then>
							</elseif>
							<elseif>
								<equals arg1="${loop.modules.cmd}" arg2="deploy" />
								<then>
									<antcall target="deploy-module" />
								</then>
							</elseif>
							<elseif>
								<equals arg1="${loop.modules.cmd}" arg2="merge" />
								<then>
									<antcall target="merge-module" />
								</then>
							</elseif>
						</if>
					</then>
				</if>
			</sequential>
		</for>
	</target>

	<target name="merge">
		<antcall target="loop-modules">
			<param name="loop.modules.cmd" value="merge" />
		</antcall>
	</target>

	<target name="merge-module">
		<copy todir="${module.name}.war">
			<fileset
				dir="${project.dir}/portal-web/docroot/html/themes/_common"
				excludes="templates/init.vm"
			/>
		</copy>

		<if>
			<available file="${module.name}.war/_diffs" />
			<then>
				<copy todir="${module.name}.war" overwrite="yes">
					<fileset
						dir="${module.name}.war/_diffs"
					/>
				</copy>
			</then>
		</if>
	</target>
</project>