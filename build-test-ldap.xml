<?xml version="1.0"?>

<project name="portal-test-ldap" basedir="." default="test" xmlns:antelope="antlib:ise.antelope.tasks">
	<import file="build-test-cluster.xml" />

	<target name="prepare-ldap-apache">
		<if>
			<or>
				<equals arg1="${apache.directory.win32.dir}" arg2="$${apache.directory.win32.dir}" />
				<equals arg1="${apache.directory.win32.install}" arg2="$${apache.directory.win32.install}" />
			</or>
			<then>
				<fail>
.

Please set "apache.directory.win32.dir" and "apache.directory.win32.install" in
test.properties to point to an ApacheDS installation file.
				</fail>
			</then>
		</if>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} ${apache.directory.win32.dir}${apache.directory.win32.install} ${vm.username}@${vm.host}:/" />
		</exec>

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host} C:\${apache.directory.win32.install} /silent" />
		</exec>

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host} sc start apacheds" />
		</exec>

		<tstamp>
			<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
		</tstamp>

		<echo file="${tstamp.value}">version: 1
dn: dc=example,dc=com
objectClass: domain
objectClass: extensibleObject
objectClass: top
dc: example

dn: cn=janesmith,dc=example,dc=com
objectClass: organizationalPerson
objectClass: person
objectClass: inetOrgPerson
objectClass: top
cn: janesmith
givenname: Jane
mail: janesmith@liferay.com
sn: Smith
userpassword:: e1NIQX1xVXFQNWN5eG02WWNUQWh6MDVIcGg1Z3Z1OU09

dn: cn=lukeskywalker,dc=example,dc=com
objectClass: organizationalPerson
objectClass: person
objectClass: inetOrgPerson
objectClass: top
cn: lukeskywalker
givenname: Luke
mail: lukeskywalker@liferay.com
sn: Skywalker
userpassword:: e1NIQX1xVXFQNWN5eG02WWNUQWh6MDVIcGg1Z3Z1OU09

dn: cn=martinluther,dc=example,dc=com
objectClass: organizationalPerson
objectClass: person
objectClass: inetOrgPerson
objectClass: top
cn: martinluther
givenname: Martin
mail: martinluther@liferay.com
sn: Luther
userpassword:: e1NIQX1xVXFQNWN5eG02WWNUQWh6MDVIcGg1Z3Z1OU09</echo>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} ${tstamp.value} ${vm.username}@${vm.host}:/" />
		</exec>

		<delete file="${tstamp.value}" />

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host} C:\Java\jdk1.6.0_14\bin\java.exe -jar C:\Progra~1\apacheds-1.0.2\bin\apacheds-tools.jar import -e -f C:/${tstamp.value}" />
		</exec>
	</target>

	<target name="prepare-ldap-tomcat">
		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} dist/liferay-portal-tomcat-6.0-${lp.version}.zip ${vm.username}@${vm.host}:/" />
		</exec>

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c C:\Progra~1\7-Zip\7z.exe x C:\liferay-portal-tomcat-6.0-${lp.version}.zip -oC:\" />
		</exec>

		<antcall target="replace-remote-file">
			<param name="remote.host" value="${vm.host}" />
			<param name="remote.file" value="/liferay-portal-${lp.version}/tomcat-6.0.18/bin/startup.bat" />
			<param name="remote.replace.token" value="set CATALINA_HOME=%cd%" />
			<param name="remote.replace.value" value="set CATALINA_HOME=C:\liferay-portal-${lp.version}\tomcat-6.0.18" />
		</antcall>
	</target>

	<target name="prepare-ldap-vm">
		<echo>Copying ${vm.drive}\${vm.host}\${vm.host}.vmdk.${vm.vmdk.suffix} to ${vm.drive}\${vm.host}\${vm.host}.vmdk</echo>

		<exec executable="cmd">
			<arg line="/c copy /y ${vm.drive}\${vm.host}\${vm.host}.vmdk.${vm.vmdk.suffix} ${vm.drive}\${vm.host}\${vm.host}.vmdk" />
		</exec>

		<exec dir="${vm.drive}/${vm.host}" executable="${vmware-cmd.executable}">
			<arg line="${vm.drive}\${vm.host}\${vm.host}.vmx start" />
		</exec>

		<sleep seconds="60" />
	</target>

	<target name="test-ldap">
		<antcall target="prepare-tomcat-6.0-mysql-5.0" />

		<mkdir dir="dist" />

		<ant antfile="build-dist.xml" target="zip-tomcat-6.0" />

		<antcall target="prepare-ldap-vm">
			<param name="vm.vmdk.suffix" value="ldap" />
		 </antcall>

		<antcall target="prepare-ldap-apache" />

		<antcall target="prepare-ldap-tomcat" />

		<antcall target="rebuild-database" inheritAll="false" />

		<antcall target="revert-test-properties" />

		<replace
			file="portal-impl/test/test-portal-impl.properties"
			token="localhost:8080"
			value="${vm.host}:8080"
		/>

		<replace
			file="portal-web/test/test-portal-web.properties"
			token="localhost:8080"
			value="${vm.host}:8080"
		/>

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c C:\liferay-portal-${lp.version}\tomcat-6.0.18\bin\startup.bat" />
		</exec>

		<sleep seconds="30" />

		<antcall target="start-selenium" />

		<antcall target="run-selenium-test">
			<param name="test.class" value="LDAPTestSuite" />
		</antcall>

		<antcall target="stop-selenium" />

		<exec dir="${vm.drive}/${vm.host}" executable="${vmware-cmd.executable}">
			<arg line="${vm.drive}\${vm.host}\${vm.host}.vmx stop hard" />
		</exec>
	</target>
</project>