<?xml version="1.0"?>

<project name="database" basedir="." default="all">
	<import file="../build-common.xml" />

	<target name="all" depends="clean, build, deploy, start"/>

	<target name="build" depends="init" unless="databaseBuild.notRequired">
		<java
			classname="com.liferay.portal.tools.samplesqlbuilder.SampleSQLBuilder"
			classpathref="project.classpath"
		>
			<arg value="-Dexternal-properties=com/liferay/portal/tools/dependencies/portal-tools.properties" />
			<arg value="sample.sql.output.dir=${sample.sql.output.dir}" />
			<arg value="sample.sql.db.type=${sample.sql.db.type}" />
			<arg value="sample.sql.blogs.entry.comment.count=${sample.sql.blogs.entry.comment.count}" />
			<arg value="sample.sql.blogs.entry.count=${sample.sql.blogs.entry.count}" />
			<arg value="sample.sql.group.count=${sample.sql.group.count}" />
			<arg value="sample.sql.mb.category.count=${sample.sql.mb.category.count}" />
			<arg value="sample.sql.mb.message.count=${sample.sql.mb.message.count}" />
			<arg value="sample.sql.mb.thread.count=${sample.sql.mb.thread.count}" />
			<arg value="sample.sql.user.count=${sample.sql.user.count}" />
			<arg value="sample.sql.user.to.group.count=${sample.sql.user.to.group.count}" />
			<arg value="sample.sql.wiki.node.count=${sample.sql.wiki.node.count}" />
			<arg value="sample.sql.wiki.page.comment.count=${sample.sql.wiki.page.comment.count}" />
			<arg value="sample.sql.wiki.page.count=${sample.sql.wiki.page.count}" />
			<arg value="sample.sql.security.enabled=${sample.sql.security.enabled}" />
		</java>
		<concat destfile="build/database/database.sql">drop database if exists ${database.name};
create database ${database.name} character set utf8;
use ${database.name};
		</concat>
		<concat destfile="build/database/database.sql" append="true">
			<filelist dir="../sql/portal-minimal/" files="portal-minimal-mysql.sql"/>
			<filelist dir="../sql/indexes/" files="indexes-mysql.sql"/>
			<filelist dir="build/database" files="sample-${sample.sql.db.type}.sql"/>
		</concat>
		<zip basedir="build/database" destfile="dist/database/database.zip">
			<include name="database.sql"/>
			<include name="*.csv"/>
		</zip>
	</target>
	
	<target name="clean">
		<delete dir="build/database"/>
		<delete dir="dist/database"/>
	</target>

	<target name="deploy" unless="databaseBuild.notRequired">
		<sshexec host="${database.ip}" username="${database.username}" password="${database.password}" trust="true" command="rm -rf ~/database-workdir" failonerror="false"/>
		<sshexec host="${database.ip}" username="${database.username}" password="${database.password}" trust="true" command="mkdir ~/database-workdir" failonerror="false"/>
		<scp file="dist/database/database.zip" todir="${database.username}:${database.password}@${database.ip}:~/database-workdir" trust="true"/>
		<scp file="remote-database.xml" todir="${database.username}:${database.password}@${database.ip}:~/database-workdir" trust="true"/>
		<sshexec host="${database.ip}" username="${database.username}" password="${database.password}" trust="true" command="ant -buildfile database-workdir/remote-database.xml extract"/>
	</target>

	<target name="init">
		<mkdir dir="build/database"/>
		<mkdir dir="dist/database"/>
		<uptodate property="databaseBuild.notRequired" targetfile="dist/database/database.zip" >
			<srcfiles dir= "../sql/portal-minimal" includes="portal-tables.sql"/>
			<srcfiles dir="../sql/indexes/" includes="indexes-mysql.sql"/>
		</uptodate>
	</target>
	
	<target name="start" unless="databaseBuild.notRequired">
		<sshexec host="${database.ip}" username="${database.username}" password="${database.password}" trust="true" command="ant -Ddatabase.dbms.password=${database.dbms.password} -buildfile database-workdir/remote-database.xml rebuild-database"/>
	</target>
</project>