<?xml version="1.0"?>

<project name="portal" basedir="." default="all">
	<import file="../build-common.xml" />
	
	<target name="all" depends="clean, build, stop, deploy, start"/>

	<target name="build" depends="init">
		<ant antfile="${project.dir}/build.xml" inheritall="false" target="all"/>
		<copy todir="build/portal">
			<fileset dir="${app.server.tomcat.dir}"/>
		</copy>
		<filter token="localhost/lportal" value="${database.ip}:3306/${database.name}"/>
		<filter token="portal.username" value="${portal.username}"/>
		<copy todir="build/portal" overwrite="true" filtering="true">
			<fileset dir="tomcat"/>
		</copy>
		<tar destfile="dist/portal/portal-tomcat.tar" basedir="build/portal"/>
	</target>
	
	<target name="clean">
		<delete dir="build/portal" quiet="true"/>
		<delete dir="dist/portal" quiet="true"/>
	</target>
	
	<target name="deploy" depends="stop">
		<sshexec host="${portal.ip}" username="${portal.username}" password="${portal.password}" trust="true" command="rm -rf ~/portal-workdir" failonerror="false"/>
		<sshexec host="${portal.ip}" username="${portal.username}" password="${portal.password}" trust="true" command="mkdir ~/portal-workdir" failonerror="false"/>
		<scp file="dist/portal/portal-tomcat.tar" todir="${portal.username}:${portal.password}@${portal.ip}:~/portal-workdir" trust="true"/>
		<scp file="lib/liferay-lib.jar" todir="${portal.username}:${portal.password}@${portal.ip}:~/portal-workdir" trust="true"/>
		<scp file="remote-portal.xml" todir="${portal.username}:${portal.password}@${portal.ip}:~/portal-workdir" trust="true"/>
		<sshexec host="${portal.ip}" username="${portal.username}" password="${portal.password}" trust="true" command="ant -buildfile portal-workdir/remote-portal.xml extract"/>
	</target>
	
	<target name="init">
		<mkdir dir="build/portal"/>
		<mkdir dir="dist/portal"/>
	</target>
	
	<target name="start">
		<parallel>
			<daemons>
				<sshexec host="${portal.ip}" username="${portal.username}" password="${portal.password}" trust="true" command="ant -buildfile portal-workdir/remote-portal.xml start-portal"/>
			</daemons>
			<waitfor>
				<http url="http://${portal.ip}:${portal.port}"/>
			</waitfor>
		</parallel>
	</target>
	
	<target name="stop">
		<sshexec host="${portal.ip}" username="${portal.username}" password="${portal.password}" trust="true" command="ant -buildfile portal-workdir/remote-portal.xml stop-portal" failonerror="false"/>
	</target>
</project>