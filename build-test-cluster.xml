<?xml version="1.0"?>

<project name="portal-test-cluster" basedir="." default="test" xmlns:antelope="antlib:ise.antelope.tasks">
	<import file="build-test.xml" />

	<target name="prepare-cluster-apache-node-1">
		<if>
			<or>
				<equals arg1="${apache.win32.dir}" arg2="$${apache.win32.dir}" />
				<equals arg1="${apache.win32.install}" arg2="$${apache.win32.install}" />
				<equals arg1="${apache.win32.modjk}" arg2="$${apache.win32.modjk}" />
			</or>
			<then>
				<fail>
.

Please set "apache.win32.dir", "apache.win32.install", and "apache.win32.modjk"
in test.properties to point to an Apache installation file.
				</fail>
			</then>
		</if>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} ${apache.win32.dir}${apache.win32.install} ${vm.username}@${vm.host.cluster-node-1}:/" />
		</exec>

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host.cluster-node-1} cmd.exe /c msiexec /i C:\${apache.win32.install} /quiet" />
		</exec>

		<property name="remote.host" value="${vm.host.cluster-node-1}" />
		<property name="remote.file" value="/Progra~1/Apache~1/Apache2.2/conf/httpd.conf" />

		<tstamp>
			<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
		</tstamp>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${remote.host}:${remote.file} ${tstamp.value}" />
		</exec>

		<replace file="${tstamp.value}">
			<replacetoken><![CDATA[ServerAdmin 
]]></replacetoken>
			<replacevalue><![CDATA[ServerAdmin admin@localhost
]]></replacevalue>
		</replace>

		<echo file="${tstamp.value}" append="true">${line.separator}Include conf.d/*.conf</echo>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} ${tstamp.value} ${vm.username}@${remote.host}:${remote.file}" />
		</exec>

		<delete file="${tstamp.value}" />

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} ${apache.win32.dir}${apache.win32.modjk} ${vm.username}@${vm.host.cluster-node-1}:/Progra~1/Apache~1/Apache2.2/modules" />
		</exec>

		<tstamp>
			<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
		</tstamp>

		<mkdir dir="${tstamp.value}/conf" />
		<mkdir dir="${tstamp.value}/conf.d" />

		<echo file="${tstamp.value}/conf/workers.properties">worker.list=node-1,node-2,loadbalancer

worker.node-1.port=8009
worker.node-1.host=${vm.host.cluster-node-1}
worker.node-1.type=ajp13
worker.node-1.connection_pool_size=10

worker.node-2.port=8009
worker.node-2.host=${vm.host.cluster-node-2}
worker.node-2.type=ajp13
worker.node-2.connection_pool_size=10

worker.loadbalancer.type=lb
worker.loadbalancer.balance_workers=node-1,node-2
worker.loadbalancer.sticky_session=1</echo>

		<echo file="${tstamp.value}/conf.d/mod_jk.conf">LoadModule jk_module modules/${apache.win32.modjk}

JkWorkersFile conf/workers.properties
JkLogFile logs/mod_jk.log
JkLogStampFormat "[%a %b %d %H:%M:%S %Y] "
JkLogLevel info
JkShmFile logs/jk-runtime-status</echo>

		<echo file="${tstamp.value}/conf.d/virtual_host.conf"><![CDATA[NameVirtualHost *:80

<VirtualHost *:80>
	JkMount /* loadbalancer
</VirtualHost>]]></echo>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} -r ${tstamp.value}/conf ${vm.username}@${vm.host.cluster-node-1}:/Progra~1/Apache~1/Apache2.2" />
		</exec>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} -r ${tstamp.value}/conf.d ${vm.username}@${vm.host.cluster-node-1}:/Progra~1/Apache~1/Apache2.2" />
		</exec>

		<delete dir="${tstamp.value}" />

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host.cluster-node-1} C:\Progra~1\Apache~1\Apache2.2\bin\httpd.exe -k install -n Apache2.2 -f C:\Progra~1\Apache~1\Apache2.2\conf\httpd.conf" />
		</exec>
	</target>

	<target name="prepare-cluster-tomcat-node">
		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} dist/liferay-portal-tomcat-6.0-${lp.version}.zip ${vm.username}@${cluster-node.host}:/" />
		</exec>

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${cluster-node.host} cmd.exe /c C:\Progra~1\7-Zip\7z.exe x C:\liferay-portal-tomcat-6.0-5.3.0.zip -oC:\" />
		</exec>

		<antcall target="replace-remote-file">
			<param name="remote.host" value="${cluster-node.host}" />
			<param name="remote.file" value="/liferay-portal-${lp.version}/tomcat-6.0.18/bin/startup.bat" />
			<param name="remote.replace.token" value="set CATALINA_HOME=%cd%" />
			<param name="remote.replace.value" value="set CATALINA_HOME=C:\liferay-portal-${lp.version}\tomcat-6.0.18" />
		</antcall>

		<antcall target="replace-remote-file">
			<param name="remote.host" value="${cluster-node.host}" />
			<param name="remote.file" value="/liferay-portal-${lp.version}/tomcat-6.0.18/bin/shutdown.bat" />
			<param name="remote.replace.token" value="set CATALINA_HOME=%cd%" />
			<param name="remote.replace.value" value="set CATALINA_HOME=C:\liferay-portal-${lp.version}\tomcat-6.0.18" />
		</antcall>

		<antcall target="replace-remote-file">
			<param name="remote.host" value="${cluster-node.host}" />
			<param name="remote.file" value="/liferay-portal-${lp.version}/tomcat-6.0.18/conf/server.xml" />
			<param name="remote.replace.token" value="&lt;Engine name=&quot;Catalina&quot; defaultHost=&quot;localhost&quot;&gt;" />
			<param name="remote.replace.value" value="&lt;Engine name=&quot;Catalina&quot; defaultHost=&quot;localhost&quot; jvmRoute=&quot;${cluster-node.value}&quot;&gt;" />
		</antcall>

		<antcall target="prepare-portal-ext-properties" inheritAll="false" />

		<echo file="portal-impl/src/portal-ext.properties" append="true">

net.sf.ehcache.configurationResourceName=/ehcache/hibernate-clustered.xml

ehcache.multi.vm.config.location=/ehcache/liferay-multi-vm-clustered.xml

comm.link.properties=UDP(bind_addr=127.0.0.1;mcast_addr=231.12.21.102;mcast_port=45566;ip_ttl=32;mcast_send_buf_size=150000;mcast_recv_buf_size=80000):PING(timeout=2000;num_initial_members=3):MERGE2(min_interval=5000;max_interval=10000):FD_SOCK:VERIFY_SUSPECT(timeout=1500):pbcast.NAKACK(gc_lag=50;retransmit_timeout=300,600,1200,2400,4800;max_xmit_size=8192):UNICAST(timeout=300,600,1200,2400):pbcast.STABLE(desired_avg_gossip=20000):FRAG(frag_size=8096;down_thread=false;up_thread=false):pbcast.GMS(join_timeout=5000;join_retry_timeout=2000;shun=false;print_local_addr=true)

web.server.display.node=true</echo>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} portal-impl/src/portal-ext.properties ${vm.username}@${cluster-node.host}:/liferay-portal-${lp.version}/tomcat-6.0.18/webapps/ROOT/WEB-INF/classes" />
		</exec>

		<delete file="portal-impl/src/portal-ext.properties" />
	</target>

	<target name="prepare-cluster-tomcat-node-1">
		<antcall target="prepare-cluster-tomcat-node">
			<param name="cluster-node.host" value="${vm.host.cluster-node-1}" />
			<param name="cluster-node.value" value="node-1" />
		</antcall>
	</target>

	<target name="prepare-cluster-tomcat-node-2">
		<antcall target="prepare-cluster-tomcat-node">
			<param name="cluster-node.host" value="${vm.host.cluster-node-2}" />
			<param name="cluster-node.value" value="node-2" />
		</antcall>
	</target>

	<target name="prepare-cluster-tomcats">
		<antcall target="prepare-cluster-tomcat-node-1" />
		<antcall target="prepare-cluster-tomcat-node-2" />
	</target>

	<target name="prepare-cluster-vm-node">
		<echo>Copying ${vm.drive}\${cluster-node.host}\${cluster-node.host}.vmdk.cluster-${cluster-node.value} to ${vm.drive}\${cluster-node.host}\${cluster-node.host}.vmdk</echo>

		<exec executable="cmd">
			<arg line="/c copy /y ${vm.drive}\${cluster-node.host}\${cluster-node.host}.vmdk.cluster-${cluster-node.value} ${vm.drive}\${cluster-node.host}\${cluster-node.host}.vmdk" />
		</exec>

		<exec dir="${vm.drive}/${cluster-node.host}" executable="${vmware-cmd.executable}">
			<arg line="${vm.drive}\${cluster-node.host}\${cluster-node.host}.vmx start" />
		</exec>

		<sleep seconds="30" />
	</target>

	<target name="prepare-cluster-vm-node-1">
		<antcall target="prepare-cluster-vm-node">
			<param name="cluster-node.host" value="${vm.host.cluster-node-1}" />
			<param name="cluster-node.value" value="node-1" />
		</antcall>
	</target>

	<target name="prepare-cluster-vm-node-2">
		<antcall target="prepare-cluster-vm-node">
			<param name="cluster-node.host" value="${vm.host.cluster-node-2}" />
			<param name="cluster-node.value" value="node-2" />
		</antcall>
	</target>

	<target name="prepare-cluster-vms">
		<antcall target="prepare-cluster-vm-node-1" />
		<antcall target="prepare-cluster-vm-node-2" />
	</target>

	<target name="replace-remote-file">
		<tstamp>
			<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
		</tstamp>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${remote.host}:${remote.file} ${tstamp.value}" />
		</exec>

		<replace
			file="${tstamp.value}"
			token="${remote.replace.token}"
			value="${remote.replace.value}"
		/>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} ${tstamp.value} ${vm.username}@${remote.host}:${remote.file}" />
		</exec>

		<delete file="${tstamp.value}" />
	</target>

	<target name="test-cluster">
		<antcall target="prepare-tomcat-6.0-mysql-5.0" />

		<mkdir dir="dist" />

		<ant antfile="build-dist.xml" target="zip-tomcat-6.0" />

		<antcall target="prepare-cluster-vms" />

		<antcall target="prepare-cluster-apache-node-1" />

		<antcall target="prepare-cluster-tomcats" />

		<antcall target="rebuild-database" inheritAll="false" />

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host.cluster-node-1} cmd.exe /c net start Apache2.2" />
		</exec>

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host.cluster-node-1} cmd.exe /c C:\liferay-portal-${lp.version}\tomcat-6.0.18\bin\startup.bat" />
		</exec>

		<sleep seconds="60" />

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host.cluster-node-2} cmd.exe /c C:\liferay-portal-${lp.version}\tomcat-6.0.18\bin\startup.bat" />
		</exec>

		<sleep seconds="60" />

		<antcall target="revert-test-properties" />

		<replace
			file="portal-web/test/test-portal-web.properties"
			token="localhost:8080"
			value="${vm.host.cluster-node-1}"
		/>

		<echo file="portal-web/test/test-portal-web.properties" append="true">${line.separator}${line.separator}cluster.node1=${vm.host.cluster-node-1}${line.separator}cluster.node2=${vm.host.cluster-node-2}</echo>

		<antcall target="start-selenium" />

		<antcall target="run-selenium-test">
			<param name="test.class" value="Cluster1TestSuite" />
		</antcall>

		<antcall target="stop-selenium" />

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host.cluster-node-2} cmd.exe /c C:\liferay-portal-${lp.version}\tomcat-6.0.18\bin\shutdown.bat" />
		</exec>

		<sleep seconds="30" />

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host.cluster-node-2} TASKKILL /f /im java.exe" />
		</exec>

		<antcall target="start-selenium" />

		<antcall target="run-selenium-test">
			<param name="test.class" value="Cluster2TestSuite" />
		</antcall>

		<antcall target="stop-selenium" />

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host.cluster-node-2} cmd.exe /c C:\liferay-portal-${lp.version}\tomcat-6.0.18\bin\startup.bat" />
		</exec>

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host.cluster-node-1} cmd.exe /c C:\liferay-portal-${lp.version}\tomcat-6.0.18\bin\shutdown.bat" />
		</exec>

		<sleep seconds="30" />

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host.cluster-node-1} TASKKILL /f /im java.exe" />
		</exec>

		<sleep seconds="30" />

		<antcall target="start-selenium" />

		<antcall target="run-selenium-test">
			<param name="test.class" value="Cluster3TestSuite" />
		</antcall>

		<antcall target="stop-selenium" />

		<exec dir="${vm.drive}/${vm.host.cluster-node-1}" executable="${vmware-cmd.executable}">
			<arg line="${vm.drive}\${vm.host.cluster-node-1}\${vm.host.cluster-node-1}.vmx stop hard" />
		</exec>

		<exec dir="${vm.drive}/${vm.host.cluster-node-2}" executable="${vmware-cmd.executable}">
			<arg line="${vm.drive}\${vm.host.cluster-node-2}\${vm.host.cluster-node-2}.vmx stop hard" />
		</exec>
	</target>
</project>