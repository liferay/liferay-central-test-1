<?xml version="1.0"?>

<project name="portal-test-tomcat" basedir="." default="test" xmlns:antelope="antlib:ise.antelope.tasks">
	<import file="build-test.xml" />

 	<target name="copy-5.1.7-5.2.7-upgrade-dependencies">
		<copy
			file="${hudson.dependencies.dir}${lp.version}_${license.type}/lpe2005.7-ee5207-portal-impl-jdk5.jar"
			todir="${app.server.tomcat.lib.portal.dir}"
		/>

		<copy
			file="${hudson.dependencies.dir}${lp.version}_${license.type}/lpe2005-ee5207-hook-5.2.7.1.war"
			todir="${app.server.parent.dir}/${ee.deploy.dir}"
		/>
	</target>

	<target name="copy-optional-jars">
		<copy
			todir="${app.server.lib.global.dir}">
				<fileset
					dir="${jdbc.drivers.optional.dir}"
					includes="*.jar"
			/>
		</copy>
	</target>

	<target name="prepare-cluster-tomcat-node">
		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} dist/liferay-portal-tomcat-${lp.version}.zip ${vm.username}@${cluster-node.host}:/" />
		</exec>

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${cluster-node.host} cmd.exe /c C:\Progra~1\7-Zip\7z.exe x C:\liferay-portal-tomcat-${lp.version}.zip -oC:\" />
		</exec>

		<antcall target="replace-remote-file">
			<param name="remote.host" value="${cluster-node.host}" />
			<param name="remote.file" value="/liferay-portal-${lp.version}/tomcat-6.0.24/bin/startup.bat" />
			<param name="remote.replace.token" value="set CATALINA_HOME=%cd%" />
			<param name="remote.replace.value" value="set CATALINA_HOME=C:\liferay-portal-${lp.version}\tomcat-6.0.24" />
		</antcall>

		<antcall target="replace-remote-file">
			<param name="remote.host" value="${cluster-node.host}" />
			<param name="remote.file" value="/liferay-portal-${lp.version}/tomcat-6.0.24/bin/shutdown.bat" />
			<param name="remote.replace.token" value="set CATALINA_HOME=%cd%" />
			<param name="remote.replace.value" value="set CATALINA_HOME=C:\liferay-portal-${lp.version}\tomcat-6.0.24" />
		</antcall>

		<antcall target="replace-remote-file">
			<param name="remote.host" value="${cluster-node.host}" />
			<param name="remote.file" value="/liferay-portal-${lp.version}/tomcat-6.0.24/conf/server.xml" />
			<param name="remote.replace.token" value="&lt;Engine name=&quot;Catalina&quot; defaultHost=&quot;localhost&quot;&gt;" />
			<param name="remote.replace.value" value="&lt;Engine name=&quot;Catalina&quot; defaultHost=&quot;localhost&quot; jvmRoute=&quot;${cluster-node.value}&quot;&gt;" />
		</antcall>

		<antcall target="prepare-portal-ext-properties" inheritAll="false" />

		<echo file="portal-impl/src/portal-ext.properties" append="true">

net.sf.ehcache.configurationResourceName=/ehcache/hibernate-clustered.xml

ehcache.multi.vm.config.location=/ehcache/liferay-multi-vm-clustered.xml

cluster.link.enabled=true

web.server.display.node=true</echo>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} portal-impl/src/portal-ext.properties ${vm.username}@${cluster-node.host}:/liferay-portal-${lp.version}/tomcat-6.0.24/webapps/ROOT/WEB-INF/classes" />
		</exec>

		<delete file="portal-impl/src/portal-ext.properties" />
	</target>

	<target name="prepare-vm-tomcat">
		<antcall target="prepare-zip-tomcat" />

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} dist/liferay-portal-tomcat-${lp.version}.zip ${vm.username}@${vm.host}:/" />
		</exec>

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c C:\Progra~1\7-Zip\7z.exe x C:\liferay-portal-tomcat-${lp.version}.zip -oC:\" />
		</exec>

		<antcall target="replace-remote-file">
			<param name="remote.host" value="${vm.host}" />
			<param name="remote.file" value="/liferay-portal-${lp.version}/tomcat-6.0.24/bin/startup.bat" />
			<param name="remote.replace.token" value="set CATALINA_HOME=%cd%" />
			<param name="remote.replace.value" value="set CATALINA_HOME=C:\liferay-portal-${lp.version}\tomcat-6.0.24" />
		</antcall>
	</target>

	<target name="prepare-zip-tomcat">
		<ant antfile="build-dist.xml" target="build-dist-tomcat" />

		<antcall target="revert-test-properties" />

		<mkdir dir="dist" />

		<ant antfile="build-dist.xml" target="zip-tomcat" />
	</target>

	<target name="run-selenium-tomcat">
		<if>
			<equals arg1="${build.app.server}" arg2="$${build.app.server}" />
			<then>
				<ant antfile="build-dist.xml" target="build-dist-tomcat" />
			</then>
		</if>

		<antcall target="revert-test-properties" />

		<antcall target="prepare-virtual-host-name-properties" />

		<antcall target="start-selenium" />

		<antcall target="run-tomcat" inheritAll="false">
			<param name="portlet.plugins.includes" value="${portlet.plugins.includes}" />
			<param name="test.class" value="${test.name}" />
			<param name="theme.plugins.includes" value="${theme.plugins.includes}" />
		</antcall>

		<antcall target="stop-selenium" />
	</target>

	<target name="run-selenium-versioned-tomcat">
		<unzip src="${hudson.dependencies.dir}/${lp.version}_${license.type}/${file.name}" dest="${app.server.parent.dir}" />

		<echo file="app.server.${user.name}.properties">app.server.tomcat.dir=${app.server.parent.dir}/${tomcat.folder.dir}</echo>

		<if>
			<not>
				<equals arg1="${jdbc.drivers.optional.dir}" arg2="$${jdbc.drivers.optional.dir}" />
			</not>
			<then>
				<antcall target="copy-optional-jars" inheritAll="false" />
			</then>
		</if>

		<if>
			<equals arg1="${legacy.config}" arg2="true" />
			<then>
				<if>
					<equals arg1="${db.type}" arg2="mysql" />
					<then>
						<antcall target="prepare-root-xml" inheritAll="false">
							<param name="db.url" value="jdbc:mysql://${db.mysql.host}/lportal?useUnicode=true&amp;amp;characterEncoding=UTF-8&amp;amp;useFastDateParsing=false" />
						</antcall>
					</then>
					<else>
						<antcall target="prepare-root-xml" inheritAll="false"/>
					</else>
				</if>
			</then>
		</if>

		<antcall target="deploy-properties" inheritAll="false"/>

		<if>
			<contains string="${custom.properties}" substring="upgrade.processes=com.liferay.portal.upgrade.UpgradeProcess_5_1_7_to_5_2_7" />
			<then>
				<antcall target="copy-5.1.7-5.2.7-upgrade-dependencies" inheritAll="false" />
			</then>
		</if>

		<if>
			<and>
				<equals arg1="${license.type}" arg2="ee" />
				<equals arg1="${lp.version}" arg2="5.1.7" />
			</and>
				<then>
					<copy
						file="${hudson.dependencies.dir}${lp.version}_${license.type}/license"
						todir="${user.home}/liferay/ee"
					/>
				</then>
			<elseif>
				<equals arg1="${license.type}" arg2="ee" />
				<then>
					<copy
						file="${hudson.dependencies.dir}${lp.version}_${license.type}/license"
						todir="${app.server.parent.dir}/${ee.license.dir}"
					/>
				</then>
			</elseif>
		</if>

		<antcall target="start-selenium" />

		<antcall target="run-tomcat" inheritAll="false">
			<param name="test.class" value="${test.name}" />
		</antcall>

		<antcall target="stop-selenium" />
	</target>

	<target name="run-tomcat">
		<antcall target="run-simple-server">
			<param name="simple.server.dir" value="${app.server.tomcat.dir}" />
			<param name="simple.server.bin.dir" value="${app.server.tomcat.bin.dir}" />
			<param name="simple.server.deploy.dir" value="${app.server.tomcat.deploy.dir}" />
			<param name="simple.server.lib.global.dir" value="${app.server.tomcat.lib.global.dir}" />
			<param name="simple.server.portal.dir" value="${app.server.tomcat.portal.dir}" />
			<param name="simple.server.start.executable" value="catalina${file.suffix.bat}" />
			<param name="simple.server.start.executable.arg.line" value="run" />
			<param name="simple.server.stop.executable" value="shutdown${file.suffix.bat}" />
		</antcall>
	</target>
</project>