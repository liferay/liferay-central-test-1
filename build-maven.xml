<?xml version="1.0"?>

<project name="portal-maven" default="deploy-artifacts" xmlns:antelope="antlib:ise.antelope.tasks">
	<property name="project.dir" value="." />

	<import file="build-common.xml" />

	<taskdef classname="com.oopsconsultancy.xmltask.ant.XmlTask" classpathref="lib.classpath" name="xmltask" />

	<condition property="gpg.extension" value=".exe" else="">
		<contains string="${os.name}" substring="Windows" casesensitive="false" />
	</condition>

	<property name="gpg.executable" value="gpg${gpg.extension}" />

	<condition property="maven.extension" value=".bat" else="">
		<contains string="${os.name}" substring="Windows" casesensitive="false" />
	</condition>

	<property name="maven.executable" value="mvn${maven.extension}" />

	<target name="deploy-artifact">
		<copy file="tools/maven/${artifact.id}.xml" tofile="tools/maven/${artifact.id}.pom">
			<filterset>
				<filter token="version" value="${maven.version}" />
			</filterset>
		</copy>

		<exec dir="." executable="${maven.executable}" failonerror="true">
			<arg value="gpg:sign-and-deploy-file" />
			<arg value="-DartifactId=${artifact.id}" />
			<arg value="-Dfile=${artifact.id}/${artifact.id}.${packaging}" />
			<arg value="-Dgpg.executable=${gpg.executable}" />
			<arg value="-Dgpg.keyname=${gpg.keyname}" />
			<arg value="-Dgpg.passphrase=${gpg.passphrase}" />
			<arg value="-DgroupId=com.liferay.portal" />
			<arg value="-Dpackaging=${packaging}" />
			<arg value="-DpomFile=tools/maven/${artifact.id}.pom" />
			<arg value="-DrepositoryId=${maven.repository.id}" />
			<arg value="-Durl=${maven.url}" />
			<arg value="-Dversion=${maven.version}" />
		</exec>

		<if>
			<not>
				<or>
					<equals arg1="${packaging}" arg2="war" />
					<antelope:endswith string="${maven.version}" with="SNAPSHOT" />
				</or>
			</not>
			<then>
				<exec dir="." executable="${maven.executable}" failonerror="true">
					<arg value="gpg:sign-and-deploy-file" />
					<arg value="-DartifactId=${artifact.id}" />
					<arg value="-Dclassifier=javadoc" />
					<arg value="-Dfile=${artifact.id}/${artifact.id}-javadoc.${packaging}" />
					<arg value="-DgeneratePom=false" />
					<arg value="-Dgpg.executable=${gpg.executable}" />
					<arg value="-Dgpg.keyname=${gpg.keyname}" />
					<arg value="-Dgpg.passphrase=${gpg.passphrase}" />
					<arg value="-DgroupId=com.liferay.portal" />
					<arg value="-Dpackaging=jar" />
					<arg value="-DrepositoryId=${maven.repository.id}" />
					<arg value="-Durl=${maven.url}" />
					<arg value="-Dversion=${maven.version}" />
				</exec>

				<exec dir="." executable="${maven.executable}" failonerror="true">
					<arg value="gpg:sign-and-deploy-file" />
					<arg value="-DartifactId=${artifact.id}" />
					<arg value="-Dfile=${artifact.id}/${artifact.id}-sources.${packaging}" />
					<arg value="-Dclassifier=sources" />
					<arg value="-DgeneratePom=false" />
					<arg value="-Dgpg.executable=${gpg.executable}" />
					<arg value="-Dgpg.keyname=${gpg.keyname}" />
					<arg value="-Dgpg.passphrase=${gpg.passphrase}" />
					<arg value="-DgroupId=com.liferay.portal" />
					<arg value="-Dpackaging=jar" />
					<arg value="-DrepositoryId=${maven.repository.id}" />
					<arg value="-Durl=${maven.url}" />
					<arg value="-Dversion=${maven.version}" />
				</exec>
			</then>
		</if>

		<delete file="tools/maven/${artifact.id}.pom" />
	</target>

	<target name="deploy-artifacts">
		<antcall target="deploy-artifact">
			<param name="artifact.id" value="portal-client" />
			<param name="packaging" value="jar" />
		</antcall>

		<antcall target="deploy-artifact">
			<param name="artifact.id" value="portal-impl" />
			<param name="packaging" value="jar" />
		</antcall>

		<antcall target="deploy-artifact">
			<param name="artifact.id" value="portal-service" />
			<param name="packaging" value="jar" />
		</antcall>

		<antcall target="deploy-artifact">
			<param name="artifact.id" value="portal-web" />
			<param name="packaging" value="war" />
		</antcall>

		<antcall target="deploy-artifact">
			<param name="artifact.id" value="util-bridges" />
			<param name="packaging" value="jar" />
		</antcall>

		<antcall target="deploy-artifact">
			<param name="artifact.id" value="util-java" />
			<param name="packaging" value="jar" />
		</antcall>

		<antcall target="deploy-artifact">
			<param name="artifact.id" value="util-taglib" />
			<param name="packaging" value="jar" />
		</antcall>
	</target>

	<!--<target name="deploy-dependencies">
		<xmltask source="lib/versions.xml">
			<call buffer="maven" path="//library/maven" target="deploy-dependency">
				<param name="artifactId" path="artifactId/text()" />
				<param name="file" path="../file-name/text()" />
				<param name="groupId" path="groupId/text()" />
				<param name="pom" path="pom-file/text()" />
				<param name="version" path="version/text()" />
			</call>
		</xmltask>
	</target>

	<target name="deploy-dependency">
		<exec dir="." executable="${maven.executable}" failonerror="true">
			<arg value="deploy:deploy-file" />
			<arg value="-DartifactId=${artifact.id}" />
			<arg value="-Dfile=lib/${file}" />
			<arg value="-DgeneratePom=true" />
			<arg value="-DgroupId=${groupId}" />
			<arg value="-Dpackaging=jar" />
			<arg value="-DrepositoryId=${maven.repository.id}" />
			<arg value="-Durl=${maven.url}" />
			<arg value="-Dversion=${maven.version}" />
		</exec>
	</target>-->

	<target name="deploy-release-artifacts">
		<antcall target="jar-javadoc" />

		<antcall target="jar-sources" />

		<replace
			dir="support-maven"
			includes="**/pom.xml"
			token="${lp.version}-SNAPSHOT"
			value="${lp.version}"
		/>

		<antcall target="deploy-artifacts">
			<param name="maven.repository.id" value="sonatype-staging" />
			<param name="maven.url" value="http://oss.sonatype.org/service/local/staging/deploy/maven2" />
			<param name="maven.version" value="${lp.version}" />
		</antcall>
	</target>

	<target name="deploy-snapshot-artifacts">
		<antcall target="deploy-artifacts">
			<param name="maven.repository.id" value="sonatype-snapshot" />
			<param name="maven.url" value="http://oss.sonatype.org/content/repositories/snapshots" />
			<param name="maven.version" value="${lp.version}-SNAPSHOT" />
		</antcall>
	</target>

	<target name="install-artifact">
		<copy file="tools/maven/${artifact.id}.xml" tofile="tools/maven/${artifact.id}.pom">
			<filterset>
				<filter token="version" value="${maven.version}" />
			</filterset>
		</copy>

		<exec dir="." executable="${maven.executable}" failonerror="true">
			<arg value="install:install-file" />
			<arg value="-DartifactId=${artifact.id}" />
			<arg value="-Dfile=${artifact.id}/${artifact.id}.${packaging}" />
			<arg value="-DgroupId=com.liferay.portal" />
			<arg value="-Dpackaging=${packaging}" />
			<arg value="-DpomFile=tools/maven/${artifact.id}.pom" />
			<arg value="-Dversion=${maven.version}" />
		</exec>

		<delete file="tools/maven/${artifact.id}.pom" />
	</target>

	<target name="install-artifacts">
		<antcall target="install-artifact">
			<param name="artifact.id" value="portal-client" />
			<param name="packaging" value="jar" />
		</antcall>

		<antcall target="install-artifact">
			<param name="artifact.id" value="portal-impl" />
			<param name="packaging" value="jar" />
		</antcall>

		<antcall target="install-artifact">
			<param name="artifact.id" value="portal-service" />
			<param name="packaging" value="jar" />
		</antcall>

		<antcall target="install-artifact">
			<param name="artifact.id" value="portal-web" />
			<param name="packaging" value="war" />
		</antcall>

		<antcall target="install-artifact">
			<param name="artifact.id" value="util-bridges" />
			<param name="packaging" value="jar" />
		</antcall>

		<antcall target="install-artifact">
			<param name="artifact.id" value="util-java" />
			<param name="packaging" value="jar" />
		</antcall>

		<antcall target="install-artifact">
			<param name="artifact.id" value="util-taglib" />
			<param name="packaging" value="jar" />
		</antcall>
	</target>

	<!--<target name="install-dependencies">
		<xmltask source="lib/versions.xml">
			<call buffer="maven" path="//library/maven" target="install-dependency">
				<param name="artifactId" path="artifactId/text()" />
				<param name="file" path="../file-name/text()" />
				<param name="groupId" path="groupId/text()" />
				<param name="pom" path="pom-file/text()" />
				<param name="version" path="version/text()" />
			</call>
		</xmltask>
	</target>

	<target name="install-dependency">
		<exec dir="." executable="${maven.executable}" failonerror="true">
			<arg value="install:install-file" />
			<arg value="-DartifactId=${artifact.id}" />
			<arg value="-Dfile=lib/${file}" />
			<arg value="-DgeneratePom=true" />
			<arg value="-DgroupId=${groupId}" />
			<arg value="-Dpackaging=jar" />
			<arg value="-Dversion=${maven.version}" />
		</exec>
	</target>-->

	<target name="install-release-artifacts">
		<antcall target="install-artifacts">
			<param name="maven.version" value="${lp.version}" />
		</antcall>
	</target>

	<target name="install-snapshot-artifacts">
		<antcall target="install-artifacts">
			<param name="maven.version" value="${lp.version}-SNAPSHOT" />
		</antcall>
	</target>

	<target name="jar-javadoc">
		<ant dir="portal-client" target="jar-javadoc" inheritAll="false" />
		<ant dir="portal-impl" target="jar-javadoc" inheritAll="false" />
		<ant dir="portal-service" target="jar-javadoc" inheritAll="false" />
		<ant dir="util-bridges" target="jar-javadoc" inheritAll="false" />
		<ant dir="util-java" target="jar-javadoc" inheritAll="false" />
		<ant dir="util-taglib" target="jar-javadoc" inheritAll="false" />
	</target>

	<target name="jar-sources">
		<ant dir="portal-client" target="jar-sources" inheritAll="false" />
		<ant dir="portal-impl" target="jar-sources" inheritAll="false" />
		<ant dir="portal-service" target="jar-sources" inheritAll="false" />
		<ant dir="util-bridges" target="jar-sources" inheritAll="false" />
		<ant dir="util-java" target="jar-sources" inheritAll="false" />
		<ant dir="util-taglib" target="jar-sources" inheritAll="false" />
	</target>

	<target name="zip-maven" depends="">
		<tstamp>
			<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
		</tstamp>

		<mkdir dir="${tstamp.value}/dist" />
		<mkdir dir="${tstamp.value}/lib" />
		<mkdir dir="${tstamp.value}/license" />

		<copy todir="${tstamp.value}">
			<fileset
				dir="tools/maven"
				includes="build.xml,readme.txt"
			/>
		</copy>

		<copy todir="${tstamp.value}/license">
			<fileset
				dir="lib"
				includes="versions.html"
			/>
			<fileset
				dir="."
				includes="copyright.txt"
			/>
		</copy>

		<copy todir="${tstamp.value}/lib">
			<fileset
				dir="lib/development"
				includes="ant-contrib.jar,antelope.jar"
			/>
		</copy>

		<copy file="tools/maven/build.properties" tofile="${tstamp.value}/build.properties">
			<filterset>
				<filter token="version" value="${lp.version.maven}" />
			</filterset>
		</copy>

		<copy todir="${tstamp.value}/dist">
			<fileset
				dir="portal-client"
				includes="portal-client.jar,portal-client-javadoc.jar,portal-client-sources.jar"
			/>
			<fileset
				dir="portal-impl"
				includes="portal-impl.jar,portal-impl-javadoc.jar,portal-impl-sources.jar"
			/>
			<fileset
				dir="portal-service"
				includes="portal-service.jar,portal-service-javadoc.jar,portal-service-sources.jar"
			/>
			<fileset
				dir="portal-web"
				includes="portal-web.war"
			/>
			<fileset
				dir="util-bridges"
				includes="util-bridges.jar,util-bridges-javadoc.jar,util-bridges-sources.jar"
			/>
			<fileset
				dir="util-java"
				includes="util-java.jar,util-java-javadoc.jar,util-java-sources.jar"
			/>
			<fileset
				dir="util-taglib"
				includes="util-taglib.jar,util-taglib-javadoc.jar,util-taglib-sources.jar"
			/>
		</copy>

		<copy file="tools/maven/portal-client.xml" tofile="${tstamp.value}/dist/portal-client.pom">
			<filterset>
				<filter token="version" value="${lp.version.maven}" />
			</filterset>
		</copy>
		<copy file="tools/maven/portal-impl.xml" tofile="${tstamp.value}/dist/portal-impl.pom">
			<filterset>
				<filter token="version" value="${lp.version.maven}" />
			</filterset>
		</copy>
		<copy file="tools/maven/portal-service.xml" tofile="${tstamp.value}/dist/portal-service.pom">
			<filterset>
				<filter token="version" value="${lp.version.maven}" />
			</filterset>
		</copy>
		<copy file="tools/maven/portal-web.xml" tofile="${tstamp.value}/dist/portal-web.pom">
			<filterset>
				<filter token="version" value="${lp.version.maven}" />
			</filterset>
		</copy>
		<copy file="tools/maven/util-bridges.xml" tofile="${tstamp.value}/dist/util-bridges.pom">
			<filterset>
				<filter token="version" value="${lp.version.maven}" />
			</filterset>
		</copy>
		<copy file="tools/maven/util-java.xml" tofile="${tstamp.value}/dist/util-java.pom">
			<filterset>
				<filter token="version" value="${lp.version.maven}" />
			</filterset>
		</copy>
		<copy file="tools/maven/util-taglib.xml" tofile="${tstamp.value}/dist/util-taglib.pom">
			<filterset>
				<filter token="version" value="${lp.version.maven}" />
			</filterset>
		</copy>

		<ant dir="${tstamp.value}" target="install-liferay-artifacts" inheritAll="false" />

		<exec dir="support-maven" executable="${maven.executable}" failonerror="true">
			<arg value="install" />
		</exec>

		<copy
			file="support-maven/target/maven-support-${lp.version.maven}.pom"
			tofile="${tstamp.value}/dist/maven-support.pom" />
		<copy
			file="support-maven/archetypes/liferay-layouttpl-archetype/target/liferay-layouttpl-archetype-${lp.version.maven}.jar"
			tofile="${tstamp.value}/dist/liferay-layouttpl-archetype.jar" />
		<copy
			file="support-maven/archetypes/liferay-layouttpl-archetype/pom.xml"
			tofile="${tstamp.value}/dist/liferay-layouttpl-archetype.pom" />
		<copy
			file="support-maven/archetypes/liferay-portlet-archetype/target/liferay-portlet-archetype-${lp.version.maven}.jar"
			tofile="${tstamp.value}/dist/liferay-portlet-archetype.jar" />
		<copy
			file="support-maven/archetypes/liferay-portlet-archetype/pom.xml"
			tofile="${tstamp.value}/dist/liferay-portlet-archetype.pom" />
		<copy
			file="support-maven/archetypes/liferay-theme-archetype/target/liferay-theme-archetype-${lp.version.maven}.jar"
			tofile="${tstamp.value}/dist/liferay-theme-archetype.jar" />
		<copy
			file="support-maven/archetypes/liferay-theme-archetype/pom.xml"
			tofile="${tstamp.value}/dist/liferay-theme-archetype.pom" />
		<copy
			file="support-maven/plugins/liferay-maven-plugin/target/liferay-maven-plugin-${lp.version.maven}.jar"
			tofile="${tstamp.value}/dist/liferay-maven-plugin.jar" />
		<copy
			file="support-maven/plugins/liferay-maven-plugin/pom.xml"
			tofile="${tstamp.value}/dist/liferay-maven-plugin.pom" />

		<zip destfile="dist/liferay-portal-maven-${lp.version}.zip">
			<zipfileset
				dir="${tstamp.value}"
				excludes="run.sh"
				prefix="liferay-portal-maven-${lp.version}"
			/>
			<zipfileset
				dir="${tstamp.value}"
				filemode="744"
				includes="run.sh"
				prefix="liferay-portal-maven-${lp.version}"
			/>
		</zip>

		<delete dir="${tstamp.value}" />
	</target>

</project>