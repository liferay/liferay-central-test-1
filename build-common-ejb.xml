<?xml version="1.0"?>

<project name="build-common-ejb">
	<import file="build-common-java.xml" />

	<target name="jar" depends="compile">
		<manifest file="classes/META-INF/MANIFEST.MF.JOnAS">
			<attribute name="Class-Path" value="${classpath.manifest.jonas}" />
			<attribute name="Genic-Jonas-Version" value="${app.server.ejbgen.version}" />
			<attribute name="Genic-Jonas-protocols" value="${app.server.ejbgen.protocols}" />
		</manifest>

		<jar
			basedir="classes"
			jarfile="${jar.file}.jar"
		>
			<manifest>
				<attribute name="Class-Path" value="portal-ejb.jar ${classpath.manifest}" />
			</manifest>
		</jar>

		<antcall target="jar-jonas-genic" />
	</target>

	<target name="jar-jonas-genic">
		<if>
			<equals arg1="${app.server.ejbgen.compile}" arg2="on" />
			<then>
				<tstamp>
					<format property="tstamp.dir" pattern="yyyyMMddkkmmssSSS" />
				</tstamp>

				<mkdir dir="${tstamp.dir}" />

				<java
					classname="org.objectweb.jonas.server.Bootstrap"
					classpath="${classpath.jonas.genic}"
					fork="true"
					maxmemory="512m"
				>
					<jvmarg value="-Dinstall.root=${env.JONAS_ROOT}" />
					<jvmarg value="-Djonas.base=${env.JONAS_ROOT}" />
					<jvmarg value="-Djava.security.policy=${env.JONAS_ROOT}/conf/java.policy" />
					<jvmarg value="-Djava.endorsed.dirs=${env.JONAS_ROOT}/lib/endorsed" />
					<jvmarg value="-Djava.io.tmpdir=${tstamp.dir}" />
					<arg value="org.objectweb.jonas_ejb.genic.GenIC" />
					<arg value="-d" />
					<arg value="${tstamp.dir}" />
					<arg value="-nocompil" />
					<arg value="-protocols" />
					<arg value="jrmp" />
					<arg value="-keepgenerated" />
					<arg value="-invokecmd" />
					<arg value="classes/META-INF/ejb-jar.xml" />
				</java>

				<javac
					classpath="${classpath.jonas.compiler}"
					srcdir="${tstamp.dir}"
					fork="true"
					memoryMaximumSize="512m"
				/>

				<rmic
					base="${tstamp.dir}"
					classpath="${classpath.jonas.compiler}"
					excludes="**/*LocalHome.class"
					includes="**/*Home.class,**/*Remote.class"
				/>

				<jar
					duplicate="preserve"
					jarfile="${jar.file}.jar"
					update="yes"
				>
					<fileset
						dir="${tstamp.dir}"
						includes="**/*.class,**/*.xml"
					/>
				</jar>

				<delete dir="${tstamp.dir}" />

				<delete>
					<fileset dir="." includes="jonas*.log*" />
				</delete>
			</then>
		</if>
	</target>

	<target name="deploy" depends="jar">
		<if>
			<or>
				<and>
					<or>
						<equals arg1="${app.server.type}" arg2="jboss-jetty" />
						<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
					</or>
					<equals arg1="${app.server.deploy.archive}" arg2="ear" />
				</and>
				<equals arg1="${app.server.type}" arg2="pramati" />
			</or>
			<then>
				<unjar src="${jar.file}.jar" dest="${app.server.portal.dir}/${jar.file}.jar" />
			</then>
			<elseif>
				<or>
					<equals arg1="${app.server.type}" arg2="jonas-jetty" />
					<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
				</or>
				<then>
					<unjar src="${jar.file}.jar" dest="${app.server.portal.dir}/${jar.file}.jar" />

					<copy
						file="${app.server.portal.dir}/${jar.file}.jar/META-INF/MANIFEST.MF.JOnAS"
						tofile="${app.server.portal.dir}/${jar.file}.jar/META-INF/MANIFEST.MF"
						overwrite="yes"
					/>
				</then>
			</elseif>
			<elseif>
				<equals arg1="${app.server.type}" arg2="orion" />
				<then>
					<copy file="${jar.file}.jar" todir="${app.server.deploy.dir}" />
				</then>
			</elseif>
			<else>
				<copy file="${jar.file}.jar" todir="${app.server.lib.portal.dir}" />
			</else>
		</if>
	</target>
</project>