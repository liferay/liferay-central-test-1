Liferay.Portlet.TagsAdmin=new Class({initialize:function(R){var Q=this;Q._categoriesCount=0;Q._entriesInCurCategoryCount=0;Q._searchFilters={};Q.params=R;var M=jQuery("#"+R.addCategoryNameInput);var E=jQuery("#"+R.addEntryButton);var J=jQuery("#"+R.addEntryNameInput);var F=jQuery("#"+R.addPropertyButton);var L=jQuery("#"+R.addVocabularyButton);var A=jQuery("#"+R.addVocabularyNameInput);var D=jQuery("#"+R.cancelEditEntryButton);var B=jQuery("#"+R.cancelEditVocabularyButton);var I=jQuery("#"+R.deleteEntryButton);var O=jQuery("#"+R.deleteVocabularyButton);var P=jQuery("#"+R.editEntryFields);var N=jQuery("#"+R.editEntryNameInput);var S=jQuery("#"+R.editVocabularyFields);var C=jQuery("#"+R.form);var H=jQuery("#"+R.keywordsInput);var K=jQuery("#"+R.updateEntryButton);var G=jQuery("#"+R.updateVocabularyButton);Q._form=C;Q._getEntries(Q);Q._getVocabularies(Q);P.hide();S.hide();C.submit(function(){return false});M.val("");M.keypress(function(T){if(T.keyCode==13){Q._addEntry(Q)}});J.keypress(function(T){if(T.keyCode==13){Q._addEntry(Q)}});A.keypress(function(T){if(T.keyCode==13){Q._addVocabulary(Q)}});N.keypress(function(T){if(T.keyCode==13){Q._updateEntry(Q)}});H.keyup(function(T){if([16,17,18,35,36,37,38,39,40].indexOf(T.which)==-1){Q._searchEntries(Q)}});H.val("");E.click(function(){Q._addEntry(Q)});F.click(function(){var T=Q._addProperty(Q,"0","","");Q._addProperties(Q,T)});L.click(function(){Q._addVocabulary(Q)});D.click(function(){P.hide()});B.click(function(){S.hide()});I.click(function(){Q._deleteEntry(Q,Q._entryId)});O.click(function(){Q._deleteVocabulary(Q,Q._vocabularyId)});K.click(function(){Q._updateEntry(Q)});G.click(function(){Q._updateVocabulary(Q)})},deleteEntry:function(A,B){A._deleteEntry(A,B)},deleteVocabulary:function(B,A){B._deleteVocabulary(B,A)},editEntry:function(L,E,B,F,G){var C=L.params;L._entryId=E;var J=jQuery("#"+C.editEntryFields);var D=jQuery("#"+C.editEntryNameInput);var I=jQuery("#"+C.editEntryVocabularyInput);var K=jQuery("#"+C.editEntryParentInput);var H=jQuery("#"+C.editEntryParentDiv);var A=jQuery("#"+C.propertiesTable);D.val(B);K.val("");I.val("");if(F!=""){Liferay.Service.Tags.TagsVocabulary.getTagsVocabulary({vocabularyId:F},function(M){I.val(M.name);if(M.folksonomy){H.hide()}else{H.show()}})}if(G!=""){Liferay.Service.Tags.TagsEntry.getEntry({entryId:G},function(M){K.val(M.name)})}A.find("tr").slice(0).remove();Liferay.Service.Tags.TagsProperty.getProperties({entryId:E},function(M){L._editProperties(L,M)});J.show()},editVocabulary:function(B,A,E,C){var G=B.params;B._vocabularyId=A;var H=jQuery("#"+G.editVocabularyFields);var F=jQuery("#"+G.editVocabularyNameInput);var D=jQuery("#"+G.editVocabularyFolksonomyCheck);F.val(E);if(C){D.attr("checked",true)}else{D.attr("checked",false)}setTimeout(function(){B._displayVocabularyEntries(B,E)},500);H.show()},_addEntry:function(J){var D=J.params;var C=D.instanceVar;var E=jQuery("#"+D.addEntryNameInput);var I=jQuery("#"+D.addEntryVocabularyInput);var G=jQuery("#"+C+"categorySel");var A=jQuery("#"+C+"CategoryFilterSel");var B=G.val();if(B=="[new]"){var F=jQuery("#"+D.addCategoryNameInput);B=jQuery.trim(F.val());if(B){J._searchFilters["category"]=B;F.hide()}else{B="no category"}}var H=new Array("0:category:"+B);if(B=="[none]"){H=null}Liferay.Service.Tags.TagsEntry.addEntry({name:E.val(),vocabulary:I.val(),properties:H},function(K){if(!K.exception){J._getEntries(J)}else{if(K.exception.indexOf("com.liferay.portlet.tags.DuplicateEntryException")>-1){J._sendMessage("error","that-tag-already-exists")}else{if(K.exception.indexOf("com.liferay.portlet.tags.EntryNameException")>-1){J._sendMessage("error","one-of-your-fields-contain-invalid-characters")}else{if(K.exception.indexOf("com.liferay.portlet.tags.NoSuchVocabularyException")>-1){J._sendMessage("error","that-vocabulary-does-not-exists")}}}jQuery("#"+D.addCategoryNameInput).show()}});J._resetFields(J);J._displayVocabularyEntries(J,I.val());E.focus()},_addProperties:function(A,D){var E=A.params;var C=E.instanceVar;var B=jQuery("#"+E.propertiesTable);B.append(D);B.find("tr").each(function(F,G){jQuery("input[@name="+C+"deletePropertyButton]",G).click(A._deleteProperty);jQuery("input[@name="+C+"propertyValue]",G).keypress(function(H){if(H.keyCode==13){A._updateEntry(A)}})})},_addProperty:function(A,G,D,E){var F=A.params;var C=F.instanceVar;var B="";B+="<tr><td>";B+="<input name=\""+C+"propertyId\" type=\"hidden\" value=\""+G+"\" />\n";B+="<input";if(D=="category"){B+=" disabled"}B+=" name=\""+C+"propertyKey\" size=\"10\" type=\"text\" value=\""+D+"\" />\n";B+="<input name=\""+C+"propertyValue\" size=\"10\" type=\"text\" value=\""+E+"\" />\n";if(D!="category"){B+="<input name=\""+C+"deletePropertyButton\" type=\"button\" value=\"Delete\" />\n"}B+="</td></tr>";return B},_addVocabulary:function(A){var E=A.params;var C=E.instanceVar;var D=jQuery("#"+E.addVocabularyFolksonomyCheck);var B=jQuery("#"+E.addVocabularyNameInput);Liferay.Service.Tags.TagsVocabulary.addVocabulary({name:B.val(),folksonomy:D.attr("checked")},function(F){if(!F.exception){A._getVocabularies(A)}else{if(F.exception.indexOf("com.liferay.portlet.tags.DuplicateVocabularyException")>-1){A._sendMessage("error","that-vocabulary-already-exists")}else{if(F.exception.indexOf("com.liferay.portlet.tags.VocabularyNameException")>-1){A._sendMessage("error","one-of-your-fields-contain-invalid-characters")}else{if(F.exception.indexOf("com.liferay.portlet.tags.NoSuchVocabularyException")>-1){A._sendMessage("error","that-parent-vocabulary-does-not-exist")}}}}});A._resetFields(A);B.focus()},_deleteEntry:function(A,D){var E=A.params;if(confirm(Liferay.Language.get("are-you-sure-you-want-to-delete-this-tag"))){var C=E.instanceVar;var B=jQuery("#"+E.editEntryFields);var F=jQuery("#"+E.editVocabularyFields);Liferay.Service.Tags.TagsEntry.deleteEntry({entryId:D},function(){if(((A._searchFilters["category"]!="all")||(A._categoriesCount==1))&&(A._entriesInCurCategoryCount==1)){A._searchFilters["category"]="all";jQuery("#"+E.addCategoryNameInput).show()}A._getEntries(A)});B.hide();F.hide()}},_deleteProperty:function(){jQuery(this).parents("tr").eq(0).remove()},_deleteVocabulary:function(B,A){var D=B.params;if(confirm(Liferay.Language.get("are-you-sure-you-want-to-delete-this-vocabulary-and-its-tags"))){var C=D.instanceVar;var E=jQuery("#"+D.editVocabularyFields);Liferay.Service.Tags.TagsVocabulary.deleteVocabulary({vocabularyId:A});B._getVocabularies(B);E.hide()}},_displayEntries:function(A,F,E){var H=A.params;var D=H.instanceVar;var C=jQuery("#"+H.searchResultsDiv);var B=["<br />"];A._categoriesCount=F.length;if(!A._placeHolder){A._placeHolder=jQuery("<div />")}var G=A._placeHolder;C.before(G);C.remove();jQuery.each(F,function(I,J){if(A._searchFilters["category"]==null||A._searchFilters["category"]=="all"||A._searchFilters["category"]==J.value){Liferay.Service.Tags.TagsEntry.search({companyId:themeDisplay.getCompanyId(),name:E,properties:"category:"+J.value},function(K){if(J.value!=""){B.push("<div class=\"tags-category\"><b>");B.push(J.value);B.push("</b></div>")}B.push("<div class=\"tags-container\">");jQuery.each(K,function(N,P){var M=[" ","<a class=\"tag-name\" href=\"javascript: ",D,".editEntry(",D,", ",P.entryId,", '",encodeURIComponent(P.name),"');","\" tagId=\"",P.entryId,"\">",P.name,"</a>"];var O=[" ","<a class=\"ui-tag-delete\" href=\"javascript: ",D,".deleteEntry(",D,", ",P.entryId,")\"><span>x</span></a>"];B.push("<span class=\"ui-tag\">");B.push(M.join(""));B.push(O.join(""));B.push("</span>")});B.push("</div>");if(K.length==0){B.push(Liferay.Language.get("no-tags-found"))}C.html(B.join(""));var L=C.find(".ui-tag");L.draggable({ghosting:false,opacity:0.7,revert:true,zIndex:1000,start:function(M,N){C.addClass("dragging")},stop:function(M,N){C.removeClass("dragging")}});L.droppable({accept:".ui-tag",hoverClass:"active-area",tolerance:"pointer",drop:function(N,R){var V=R.draggable;var Q=jQuery(this);var S=V.find("a.tag-name");var T=Q.find("a.tag-name");var P=S.attr("tagId");var O=T.attr("tagId");var M={SOURCE:S.text(),DESTINATION:T.text()};var U=Liferay.Language.get("are-you-sure-you-want-to-merge-x-into-x",["{SOURCE}","{DESTINATION}"]).replace(/\{(SOURCE|DESTINATION)\}/gm,function(Z,X,W,Y){return M[X]});if(confirm(U)){jQuery.data(V[0],"draggable").options.revert=false;Liferay.Service.Tags.TagsEntry.mergeEntries({fromEntryId:P,toEntryId:O},function(){V.remove();jQuery(".ui-tag[@tagId="+P+"]").remove()})}}});G.after(C);G.remove()})}})},_displayVocabularyEntries:function(A,D){var F=A.params;var C=F.instanceVar;var E=jQuery("#"+F.vocabularyTagsDiv);var B="<br />";Liferay.Service.Tags.TagsEntry.getVocabularyEntries({companyId:themeDisplay.getCompanyId(),name:D},function(G){B+="";jQuery.each(G,function(I,J){var H=C+".editEntry("+C+", "+J.entryId+", '";H+=encodeURIComponent(J.name)+"', '"+J.vocabularyId+"','";H+=J.parentEntryId+"'";H+=");";var K=G.length;B+="<span class=\"ui-tag\">";B+=" <a class=\"tag-name\" href=\"javascript: "+H+"\" tagId=\""+J.entryId+"\">"+J.name+" ("+J.parentEntryId+")</a>";B+=" <a class=\"ui-tag-delete\" href=\"javascript: "+C+".deleteEntry("+C+", "+J.entryId+")\"><span>x</span></a>";B+="</span>"});B+="</div>";if(G.length==0){B+=Liferay.Language.get("no-vocabulary-tags-found")}E.html(B)})},_displayFilters:function(M,F,K){var D=M.params;var C=D.instanceVar;var A=jQuery("#"+D.searchPropertiesSpan);var I=jQuery("#"+D.addToCategorySpan);var L="";var H="";jQuery.each(K,function(O,Q){var P="";if(Q.value==M._searchFilters["category"]){P=" selected"}var N="<option value=\""+Q.value+"\""+P+">"+Q.value+"</option>";L+=N;if(Q.value!="no category"){H+=N}});L="<select id=\""+C+F+"FilterSel\"><option>all</option>"+L+"</select>";var E="";if(M._searchFilters["category"]=="no category"){E="selected"}H="<select id=\""+C+F+"Sel\"><option value=\"[new]\">(New)</option><option value=\"no category\""+E+">(None)</option>"+H+"</select>";A.append("<span style=\"padding: 0px 5px 0px 10px;\">"+F+"</span>");A.append(L);I.append("<span style=\"padding: 0px 5px 0px 10px;\">"+H+"</span>");var G=jQuery("#"+D.addCategoryNameInput);var B=jQuery("#"+C+F+"FilterSel");var J=jQuery("#"+C+"categorySel");B.change(function(){M._searchFilters[F]=this.value;if(this.value=="all"){J.val("[new]");G.show()}else{J.val(this.value);G.hide()}M._searchEntries(M)});J.change(function(){M._searchFilters[F]=this.value;if(this.value=="[new]"){B.val("[all]");G.show()}else{B.val(this.value);G.hide()}M._searchEntries(M)})},_displayVocabularies:function(B){var E=B.params;var D=E.instanceVar;var A=jQuery("#"+E.listVocabulariesDiv);var C="<br />";Liferay.Service.Tags.TagsVocabulary.getVocabularies({companyId:themeDisplay.getCompanyId()},function(F){C+="";jQuery.each(F,function(J,I){var G=D+".editVocabulary("+D+", "+I.vocabularyId+", '"+encodeURIComponent(I.name)+"', "+I.folksonomy+");";var H=F.length;C+="<span class=\"ui-tag\">";C+=" <a class=\"tag-name\" href=\"javascript: "+G+"\" vocabularyId=\""+I.vocabularyId+"\">"+I.name+"</a>";C+=" <a class=\"ui-tag-delete\" href=\"javascript: "+D+".deleteVocabulary("+D+", "+I.vocabularyId+")\"><span>x</span></a>";C+="</span>"});if(F.length==0){C+=Liferay.Language.get("no-vocabularies-found")}A.html(C)})},_editProperties:function(A,C){var B="";jQuery.each(C,function(D,E){B+=A._addProperty(A,E.propertyId,E.key,E.value)});if(C.length==0){B+=A._addProperty("0","","")}A._addProperties(A,B)},_getEntries:function(A){A._resetFields(A);Liferay.Service.Tags.TagsProperty.getPropertyValues({companyId:themeDisplay.getCompanyId(),key:"category"},function(B){A._displayEntries(A,B,"%")});A._getFilters(A)},_getFilters:function(A){var F=A.params;var C=F.instanceVar;var B=jQuery("#"+F.searchPropertiesSpan);var E=jQuery("#"+F.addToCategorySpan);var D=new Array("category");if(D.length>0){B.html("Filter By: ");E.html("Add To: ")}jQuery.each(D,function(G,H){Liferay.Service.Tags.TagsProperty.getPropertyValues({companyId:themeDisplay.getCompanyId(),key:H},function(I){A._displayFilters(A,H,I)})})},_getVocabularies:function(A){A._resetFields(A);A._displayVocabularies(A,"%")},_resetFields:function(A){var H=A.params;var G=jQuery("#"+H.addCategoryNameInput);var E=jQuery("#"+H.addEntryNameInput);var C=jQuery("#"+H.addVocabularyNameInput);var B=jQuery("#"+H.keywordsInput);var F=jQuery("#"+H.editVocabularyFolksonomyCheck);var D=jQuery("#"+H.editVocabularyFolksonomyCheck);G.val("");E.val("");C.val("");F.attr("checked",false);D.attr("checked",false);B.val("")},_searchEntries:function(A){var B=A.params;if(A.showTimer){clearTimeout(A.showTimer);A.showTimer=0}A.showTimer=setTimeout(function(){var C=jQuery("#"+B.keywordsInput);var E="%"+C.val()+"%";var D=jQuery("#"+B.searchResultsDiv);D.html("");Liferay.Service.Tags.TagsProperty.getPropertyValues({companyId:themeDisplay.getCompanyId(),key:"category"},function(F){A._displayEntries(A,F,E)})},250)},_searchVocabularies:function(A){var B=A.params;if(A.showTimerV){clearTimeout(A.showTimerV);A.showTimerV=0}A.showTimerV=setTimeout(function(){A._displayVocabularies(A,keywords)},250)},_sendMessage:function(E,D){var A=this;var B="portlet-msg-error";if(E=="success"){B="portlet-msg-success"}var F=Liferay.Language.get(D);var C=jQuery(".lfr-message-response");if(C.length){C.removeClass("portlet-msg-success").removeClass("portlet-msg-error");C.addClass(B);C.fadeIn("fast")}else{C=jQuery("<div class=\""+B+" lfr-message-response\">"+F+"</div>");A._form.prepend(C)}var G=setTimeout(function(){C.fadeOut("slow");clearTimeout(G)},7000)},_updateEntry:function(I){var C=I.params;var B=C.instanceVar;var D=jQuery("#"+C.editEntryNameInput);var E=jQuery("#"+C.editEntryFields);var H=jQuery("#"+C.editEntryParentInput);var F=jQuery("#"+C.editEntryVocabularyInput);var A=jQuery("#"+C.propertiesTable);var G="";var J=A.find("tr");J.each(function(L,O){var N=jQuery("input[@name="+B+"propertyId]",O).val();var M=jQuery("input[@name="+B+"propertyKey]",O).val();var K=jQuery("input[@name="+B+"propertyValue]",O).val();G+=N+":"+M+":"+K;if((L+1)<J.length){G+=","}});Liferay.Service.Tags.TagsEntry.updateEntry({entryId:I._entryId,name:D.val(),parentCategoryName:H.val(),properties:G,vocabularyName:F.val()},function(K){if(!K.exception){I._displayVocabularyEntries(I,F.val());E.hide()}else{if(K.exception.indexOf("com.liferay.portlet.tags.NoSuchVocabularyException")>-1){I._sendMessage("error","that-vocabulary-does-not-exist")}else{if(K.exception.indexOf("com.liferay.portlet.tags.NoSuchEntryException")>-1){I._sendMessage("error","that-parent-category-does-not-exist")}else{if(K.exception.indexOf("Exception")>-1){I._sendMessage("error","one-of-your-fields-contain-invalid-characters")}}}}})},_updateVocabulary:function(A){var E=A.params;var C=E.instanceVar;var D=jQuery("#"+E.editVocabularyNameInput);var F=jQuery("#"+E.editVocabularyFields);var B=jQuery("#"+E.editVocabularyFolksonomyCheck);Liferay.Service.Tags.TagsVocabulary.updateVocabulary({vocabularyId:A._vocabularyId,name:D.val(),folksonomy:B.attr("checked")},function(G){if(!G.exception){A._getVocabularies(A)}else{if(G.exception.indexOf("Exception")>-1){A._sendMessage("error","one-of-your-fields-contain-invalid-characters")}}});F.hide()}})