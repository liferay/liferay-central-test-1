<?xml version="1.0"?>

<project name="build-common-web">
	<import file="build-common.xml" />

	<target name="clean">
		<delete file="${war.file}.war" failonerror="false" />

		<delete includeemptydirs="true" failonerror="false">
			<fileset dir="docroot/WEB-INF/classes" excludes="${classes.dir.excludes}" />
		</delete>
	</target>

	<target name="compile">
		<if>
			<available file="docroot/WEB-INF/src" />
			<then>
				<mkdir dir="docroot/WEB-INF/classes" />

				<javac
					classpathref="web.classpath"
					compiler="${javac.compiler}"
					debug="${javac.debug}"
					deprecation="${javac.deprecation}"
					destdir="docroot/WEB-INF/classes"
					fork="${javac.fork}"
					memoryMaximumSize="${javac.memoryMaximumSize}"
					nowarn="on"
					srcdir="docroot/WEB-INF/src"
				/>
			</then>
		</if>
	</target>

	<target name="war" depends="compile">
		<if>
			<available file="docroot" />
			<then>
				<war
					basedir="docroot"
					destfile="${war.file}.war"
					excludes="WEB-INF/web.xml"
					webxml="docroot/WEB-INF/web.xml"
				>
					<manifest>
						<attribute name="Class-Path" value="counter-ejb.jar documentlibrary-ejb.jar lock-ejb.jar mail-ejb.jar portal-ejb.jar ${classpath.manifest}" />
					</manifest>
				</war>
			</then>
		</if>
	</target>

	<target name="deploy" depends="war">
		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="jboss-jetty" />
				<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
				<equals arg1="${app.server.type}" arg2="jonas-jetty" />
				<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
			</or>
			<then>
				<property name="war.file.dest" value="${app.server.portal.dir}/${war.file}.war" />
			</then>
			<else>
				<if>
					<equals arg1="${war.file}" arg2="portal-web" />
					<then>
						<if>
							<equals arg1="${app.server.type}" arg2="jetty" />
							<then>
								<property name="war.file.dest" value="${app.server.deploy.dir}/root" />
							</then>
							<elseif>
								<or>
									<equals arg1="${app.server.type}" arg2="resin" />
									<equals arg1="${app.server.type}" arg2="tomcat" />
								</or>
								<then>
									<property name="war.file.dest" value="${app.server.deploy.dir}/ROOT" />
								</then>
							</elseif>
							<else>
								<property name="war.file.dest" value="${app.server.portal.dir}" />
							</else>
						</if>
					</then>
					<else>
						<property name="war.file.dest" value="${app.server.deploy.dir}/${war.file}" />
					</else>
				</if>
			</else>
		</if>

		<if>
			<equals arg1="${app.server.type}" arg2="orion" />
			<then>
				<copy file="${war.file}.war" todir="${app.server.deploy.dir}" />
			</then>
			<else>
				<unwar src="${war.file}.war" dest="${war.file.dest}" />

				<if>
					<equals arg1="${war.file}" arg2="portal-web" />
					<then>
						<copy todir="${war.file.dest}" overwrite="yes">
							<fileset dir="${project.dir}/web-sites/liferay.com-web/docroot" />
						</copy>
					</then>
				</if>
			</else>
		</if>

		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="jetty" />
				<equals arg1="${app.server.type}" arg2="resin" />
				<equals arg1="${app.server.type}" arg2="tomcat" />
			</or>
			<then>
				<java
					classname="com.liferay.portal.tools.WebXMLStripper"
					classpathref="project.classpath"
					fork="true"
					newenvironment="true"
				>
					<arg value="${war.file.dest}/WEB-INF/web.xml" />
				</java>
			</then>
		</if>

		<if>
			<equals arg1="${app.server.type}" arg2="jonas-jetty" />
			<then>
				<copy
					file="${war.file.dest}/WEB-INF/web-jetty.xml.jonas-jetty"
					tofile="${war.file.dest}/WEB-INF/web-jetty.xml"
					overwrite="yes"
					failonerror="false"
				/>
			</then>
			<elseif>
				<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
				<then>
					<delete file="${war.file.dest}/META-INF/context.xml" />
				</then>
			</elseif>
		</if>
	</target>
</project>