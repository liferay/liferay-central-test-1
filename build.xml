<?xml version="1.0"?>

<project name="portal" basedir="." default="compile" xmlns:antelope="antlib:ise.antelope.tasks">
	<property name="project.dir" value="." />

	<import file="build-common.xml" />

	<target name="all">
		<antcall target="clean" />
		<antcall target="start" />
		<antcall target="deploy" />
	</target>

	<target name="start">
		<antcall target="compile" />

		<ant dir="util-taglib" target="jar" inheritAll="false" />

		<ant dir="sql" target="build-db" inheritAll="false" />
		<ant dir="sql" target="rebuild-hypersonic" inheritAll="false" />

		<ant dir="portal-impl" target="build-newscategories" inheritAll="false" />
		<ant dir="portal-impl" target="build-reverendfun" inheritAll="false" />
  		<ant dir="portal-impl" target="build-themes" inheritAll="false" />

		<antcall target="jar" />

		<antcall target="print-current-time" />
	</target>

	<target name="clean">
		<ant dir="classes" target="clean" inheritAll="false" />

		<ant dir="portal-kernel" target="clean" inheritAll="false" />
		<ant dir="portal-service" target="clean" inheritAll="false" />

		<ant dir="util-bridges" target="clean" inheritAll="false" />
		<ant dir="util-java" target="clean" inheritAll="false" />
		<ant dir="util-taglib" target="clean" inheritAll="false" />
		<ant dir="util-wsrp" target="clean" inheritAll="false" />

		<ant dir="applets" target="clean" inheritAll="false" />
		<ant dir="filters" target="clean" inheritAll="false" />

		<ant dir="counter-impl" target="clean" inheritAll="false" />
		<ant dir="documentlibrary-impl" target="clean" inheritAll="false" />
		<ant dir="lock-impl" target="clean" inheritAll="false" />
		<ant dir="mail-impl" target="clean" inheritAll="false" />
		<ant dir="portal-impl" target="clean" inheritAll="false" />

		<ant dir="portal-web" target="clean" inheritAll="false" />
		<ant dir="tunnel-web" target="clean" inheritAll="false" />

		<delete>
			<fileset dir="." includes="*.ear,*.jar,*.war,*.zip" />
		</delete>

		<delete includeemptydirs="true" failonerror="false">
			<fileset dir="${app.server.bin.dir}" includes="*.log*,ActiveMQ/**,alf_data/**,alfresco.*,console.out" />
		</delete>

		<if>
			<equals arg1="${app.server.type}" arg2="glassfish" />
			<then>
				<delete failonerror="false">
					<fileset
						dir="${app.server.dir}/domains/domain1/config"
						includes="${database.name}.*"
					/>
				</delete>
			</then>
			<elseif>
				<or>
					<equals arg1="${app.server.type}" arg2="jonas-jetty" />
					<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
				</or>
				<then>
					<delete failonerror="false">
						<fileset
							dir="${app.server.bin.dir}/nt"
							includes="${database.name}.*"
						/>
					</delete>

					<delete failonerror="false">
						<fileset
							dir="${app.server.bin.dir}/unix"
							includes="${database.name}.*"
						/>
					</delete>

					<delete includeemptydirs="true" failonerror="false">
						<fileset
							dir="${app.server.dir}"
							includes="demoserver/**,examples/**,"
						/>
						<fileset
							dir="${app.server.dir}/apps"
							includes="*.ear,autoload/*.ear"
						/>
						<fileset
							dir="${app.server.dir}/conf"
							includes="db2.properties,FirebirdSQL.properties,HSQL1.properties,InstantDB1.properties,InterBase1.properties,MailMimePartDS1.properties,MailSession1.properties,McKoi1.properties,MySQL.properties,Oracle1.properties,PostgreSQL1.properties,spy.properties,Sybase1.properties"
						/>
						<fileset
							dir="${app.server.dir}/ejbjars"
							includes="*.jar,autoload/*.jar"
						/>
						<fileset
							dir="${app.server.dir}/webapps"
							includes="*.war,autoload/*.war,autoload/jonas-doc-en/**,autoload/jonas-javadoc/**"
						/>
					</delete>
				</then>
			</elseif>
			<elseif>
				<equals arg1="${app.server.type}" arg2="tomcat" />
				<then>
					<ant dir="support-tomcat" target="clean" inheritAll="false" />

					<if>
						<equals arg1="${app.server.version}" arg2="5.5" />
						<then>
							<delete includeemptydirs="true" failonerror="false">
								<fileset
									dir="${app.server.deploy.dir}"
									includes="balancer/**,jsp-examples/**,servlets-examples/**,tomcat-docs/**,webdav/**"
								/>
								<fileset
									dir="${app.server.dir}/conf/Catalina/localhost"
									includes="host-manager.xml,manager.xml"
								/>
								<fileset
									dir="${app.server.dir}/server/webapps"
									includes="host-manager/**,manager/**"
								/>
							</delete>
						</then>
					</if>

					<if>
						<equals arg1="${app.server.version}" arg2="6.0" />
						<then>
							<delete includeemptydirs="true" failonerror="false">
								<fileset
									dir="${app.server.deploy.dir}"
									includes="docs/**,examples/**,host-manager/**,manager/**"
								/>
							</delete>
						</then>
					</if>
				</then>
			</elseif>
			<else>
				<delete failonerror="false">
					<fileset
						dir="${app.server.bin.dir}"
						includes="${database.name}.*"
					/>
				</delete>
			</else>
		</if>

		<delete failonerror="false">
			<fileset
				dir="${app.server.classes.portal.dir}"
				includes="*-ext.properties"
			/>
		</delete>

		<delete includeemptydirs="true" failonerror="false">
			<fileset
				dir="${app.server.deploy.dir}"
				includes="sample*/**,tunnel-web*/**"
			/>
		</delete>

		<delete failonerror="false">
			<fileset
				dir="${app.server.lib.global.dir}"
				excludes="${jdbc.drivers}"
			/>
		</delete>

		<delete failonerror="false">
			<fileset
				dir="${app.server.lib.portal.dir}"
				excludes="${jdbc.drivers}"
			/>
		</delete>

		<if>
			<equals arg1="${clean.log.dir}" arg2="true" />
			<then>
				<delete dir="${app.server.log.dir}" />
			</then>
		</if>

		<if>
			<not>
				<and>
					<equals arg1="${app.server.type}" arg2="tomcat" />
					<antelope:endswith string="${app.server.portal.dir}" with="/portal-web/docroot" />
				</and>
			</not>
			<then>
				<delete dir="${app.server.portal.dir}" />
				<delete file="${app.server.portal.dir}" />
			</then>
		</if>

		<if>
			<equals arg1="${clean.temp.dir}" arg2="true" />
			<then>
				<delete dir="${app.server.temp.dir}" />
			</then>
		</if>

		<if>
			<equals arg1="${clean.work.dir}" arg2="true" />
			<then>
				<delete dir="${app.server.work.dir}" />
			</then>
		</if>

		<antcall target="print-current-time" />
	</target>

	<target name="compile">
		<ant dir="portal-kernel" target="compile" inheritAll="false" />
		<ant dir="portal-service" target="compile" inheritAll="false" />

		<ant dir="util-java" target="compile" inheritAll="false" />
		<ant dir="util-bridges" target="compile" inheritAll="false" />
		<ant dir="util-wsrp" target="compile" inheritAll="false" />

		<ant dir="portal-impl" target="compile-common" inheritAll="false" />

		<ant dir="applets" target="compile" inheritAll="false" />
		<ant dir="filters" target="compile" inheritAll="false" />

		<ant dir="counter-impl" target="compile" inheritAll="false" />
		<ant dir="documentlibrary-impl" target="compile" inheritAll="false" />
		<ant dir="lock-impl" target="compile" inheritAll="false" />
		<ant dir="mail-impl" target="compile" inheritAll="false" />
		<ant dir="portal-impl" target="compile" inheritAll="false" />
	</target>

	<target name="jar">
		<ant dir="portal-kernel" target="jar" inheritAll="false" />
		<ant dir="portal-service" target="jar" inheritAll="false" />

		<ant dir="util-bridges" target="jar" inheritAll="false" />
		<ant dir="util-java" target="jar" inheritAll="false" />
		<ant dir="util-taglib" target="jar" inheritAll="false" />
		<ant dir="util-wsrp" target="jar" inheritAll="false" />

		<ant dir="applets" target="deploy" inheritAll="false" />
		<ant dir="filters" target="jar" inheritAll="false" />

		<ant dir="counter-impl" target="jar" inheritAll="false" />
		<ant dir="documentlibrary-impl" target="jar" inheritAll="false" />
		<ant dir="lock-impl" target="jar" inheritAll="false" />
		<ant dir="mail-impl" target="jar" inheritAll="false" />
		<ant dir="portal-impl" target="jar" inheritAll="false" />

		<ant dir="portal-web" target="war" inheritAll="false" />
		<ant dir="tunnel-web" target="war" inheritAll="false" />

		<ant dir="support-tomcat" target="jar" inheritAll="false" />
	</target>

	<target name="java2html">
		<delete dir="api" />

		<ant dir="portal-kernel" target="java2html" inheritAll="false" />
		<ant dir="portal-service" target="java2html" inheritAll="false" />

		<ant dir="util-bridges" target="java2html" inheritAll="false" />
		<ant dir="util-java" target="java2html" inheritAll="false" />
		<ant dir="util-taglib" target="java2html" inheritAll="false" />
		<ant dir="util-wsrp" target="java2html" inheritAll="false" />

		<ant dir="applets" target="java2html" inheritAll="false" />
		<ant dir="filters" target="java2html" inheritAll="false" />

		<ant dir="counter-impl" target="java2html" inheritAll="false" />
		<ant dir="documentlibrary-impl" target="java2html" inheritAll="false" />
		<ant dir="lock-impl" target="java2html" inheritAll="false" />
		<ant dir="mail-impl" target="java2html" inheritAll="false" />
		<ant dir="portal-impl" target="java2html" inheritAll="false" />

		<ant dir="portal-client" target="java2html" inheritAll="false" />
	</target>

	<target name="javadoc">
		<ant dir="portal-kernel" target="javadoc" inheritAll="false" />
		<ant dir="portal-service" target="javadoc" inheritAll="false" />

		<ant dir="util-bridges" target="javadoc" inheritAll="false" />
		<ant dir="util-java" target="javadoc" inheritAll="false" />
		<ant dir="util-taglib" target="javadoc" inheritAll="false" />
		<ant dir="util-wsrp" target="javadoc" inheritAll="false" />

		<ant dir="applets" target="javadoc" inheritAll="false" />
		<ant dir="filters" target="javadoc" inheritAll="false" />

		<ant dir="counter-impl" target="javadoc" inheritAll="false" />
		<ant dir="documentlibrary-impl" target="javadoc" inheritAll="false" />
		<ant dir="lock-impl" target="javadoc" inheritAll="false" />
		<ant dir="mail-impl" target="javadoc" inheritAll="false" />
		<ant dir="portal-impl" target="javadoc" inheritAll="false" />
	</target>

	<target name="deploy">
		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="glassfish" />
				<equals arg1="${app.server.type}" arg2="pramati" />
			</or>
			<then>
				<delete dir="${app.server.portal.dir}" />
				<delete file="${app.server.portal.dir}" />
			</then>
		</if>

		<ant dir="portal-kernel" target="deploy" inheritAll="false" />
		<ant dir="portal-service" target="deploy" inheritAll="false" />

		<ant dir="util-bridges" target="deploy" inheritAll="false" />
		<ant dir="util-java" target="deploy" inheritAll="false" />
		<ant dir="util-taglib" target="deploy" inheritAll="false" />
		<ant dir="util-wsrp" target="deploy" inheritAll="false" />

		<ant dir="applets" target="deploy" inheritAll="false" />
		<ant dir="filters" target="deploy" inheritAll="false" />

		<ant dir="counter-impl" target="deploy" inheritAll="false" />
		<ant dir="documentlibrary-impl" target="deploy" inheritAll="false" />
		<ant dir="lock-impl" target="deploy" inheritAll="false" />
		<ant dir="mail-impl" target="deploy" inheritAll="false" />
		<ant dir="portal-impl" target="deploy" inheritAll="false" />

		<ant dir="portal-web" target="deploy" inheritAll="false" />
		<ant dir="tunnel-web" target="deploy" inheritAll="false" />

		<if>
			<equals arg1="${app.server.type}" arg2="glassfish" />
			<then>
				<copy todir="${app.server.dir}/domains/domain1/config">
					<fileset dir="sql">
						<include name="${database.name}.properties" />
						<include name="${database.name}.script" />
					</fileset>
				</copy>
			</then>
			<elseif>
				<or>
					<equals arg1="${app.server.type}" arg2="jonas-jetty" />
					<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
				</or>
				<then>
					<copy todir="${app.server.bin.dir}/nt">
						<fileset dir="sql">
							<include name="${database.name}.properties" />
							<include name="${database.name}.script" />
						</fileset>
					</copy>
					<copy todir="${app.server.bin.dir}/unix">
						<fileset dir="sql">
							<include name="${database.name}.properties" />
							<include name="${database.name}.script" />
						</fileset>
					</copy>
				</then>
			</elseif>
			<else>
				<copy todir="${app.server.bin.dir}">
					<fileset dir="sql">
						<include name="${database.name}.properties" />
						<include name="${database.name}.script" />
					</fileset>
				</copy>
			</else>
		</if>

		<antcall target="deploy-properties" />

		<copy todir="${app.server.lib.global.dir}">
			<fileset dir="lib/development" includes="hsql.jar" />
			<fileset dir="lib/global" />
		</copy>

		<copy todir="${app.server.lib.portal.dir}">
			<fileset dir="lib/portal" />
		</copy>

		<if>
			<equals arg1="${app.server.type}" arg2="geronimo-tomcat" />
			<then>
				<copy todir="${app.server.lib.portal.dir}">
					<fileset
						dir="lib/development"
						includes="mail.jar,smtp.jar"
					/>
				</copy>
			</then>
		</if>

		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="jboss-jetty" />
				<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
			</or>
			<then>
				<delete>
					<fileset
						dir="${app.server.lib.portal.dir}"
						includes="log4j.jar"
					/>
				</delete>
			</then>
		</if>

		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="jonas-jetty" />
				<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
			</or>
			<then>
				<copy todir="${app.server.lib.portal.dir}">
					<fileset
						dir="lib/development"
						includes="mail.jar"
					/>
				</copy>

				<copy todir="${app.server.dir}">
					<fileset dir="tools/ext_tmpl/servers/jonas" />
				</copy>
			</then>
		</if>

		<if>
			<equals arg1="${app.server.type}" arg2="jetty" />
			<then>
				<copy todir="${app.server.lib.portal.dir}">
					<fileset
						dir="lib/development"
						includes="jms.jar,jta.jar"
					/>
				</copy>

				<delete>
					<fileset
						dir="${app.server.lib.portal.dir}"
						includes="jmx-remote.jar,jmx-ri.jar,xercesImpl.jar,xml-apis.jar"
					/>
				</delete>
			</then>
		</if>

		<if>
			<equals arg1="${app.server.type}" arg2="resin" />
			<then>

				<!--
				Resin 3.0.19 needs Commons Logging and Log4J in the common
				class loader or else Resin will break when Commons Logging
				from one WAR tries to load Log4J from another WAR.
				-->

				<copy todir="${app.server.lib.global.dir}">
					<fileset
						dir="lib/portal"
						includes="commons-logging.jar,log4j.jar"
					/>
				</copy>

				<copy todir="${app.server.lib.global.dir}">
					<fileset
						dir="lib/development"
						includes="activation.jar,mail.jar"
					/>
				</copy>

				<copy todir="${app.server.dir}/lib">
					<fileset
						dir="lib/portal"
						includes="xercesImpl.jar,xml-apis.jar"
					/>
				</copy>
			</then>
		</if>

		<if>
			<equals arg1="${app.server.type}" arg2="tomcat" />
			<then>
				<copy file="classes/log4j.properties" todir="${app.server.classes.portal.dir}" />

				<ant dir="support-tomcat" target="deploy" inheritAll="false" />

				<copy todir="${app.server.lib.endorsed.dir}" flatten="true">
					<fileset
						dir="lib"
						includes="${endorsed.libraries}"
					/>
				</copy>

				<copy todir="${app.server.lib.global.dir}">
					<fileset
						dir="lib/development"
						includes="activation.jar,jms.jar,jta.jar,mail.jar"
					/>
				</copy>

				<if>
					<equals arg1="${app.server.version}" arg2="5.5" />
					<then>

						<!--
						LEP-2981
						-->

						<copy todir="${app.server.dir}/common/lib">
							<fileset
								dir="lib/development"
								includes="naming-factory.jar"
							/>
						</copy>
					</then>
				</if>

				<move todir="${app.server.lib.endorsed.dir}">
					<fileset
						dir="${app.server.lib.portal.dir}"
						includes="xercesImpl.jar"
					/>
				</move>

				<copy todir="${app.server.temp.dir}/liferay/com/liferay/portal/deploy/dependencies">
					<fileset
						dir="lib/development"
						includes="quercus.jar,resin-util.jar,script-10.jar"
					/>
				</copy>

				<if>
					<not>
						<available file="${app.server.dir}/conf/Catalina/localhost/ROOT.xml" />
					</not>
					<then>
						<copy
							file="tools/ext_tmpl/servers/tomcat/conf/Catalina/localhost/ROOT.xml"
							tofile="${app.server.dir}/conf/Catalina/localhost/ROOT.xml"
							overwrite="yes"
						/>
					</then>
				</if>

				<copy
					file="tools/ext_tmpl/servers/tomcat/conf/catalina.properties.${app.server.version}"
					tofile="${app.server.dir}/conf/catalina.properties"
					overwrite="yes"
				/>

				<copy
					file="tools/ext_tmpl/servers/tomcat/conf/jaas.config"
					tofile="${app.server.dir}/conf/jaas.config"
				/>
			</then>
		</if>

		<mkdir dir="${app.server.log.dir}" />
		<mkdir dir="${app.server.temp.dir}" />
		<mkdir dir="${app.server.work.dir}" />

		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="jboss-jetty" />
				<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
			</or>
			<then>

				<!--
				JBoss 4.0.5 defaults to different versions of dom4j, Commons
				Collections, Commons HttpClient, and Hibernate.
				-->

				<copy todir="${app.server.dir}/lib" overwrite="yes">
					<fileset
						dir="lib/portal"
						includes="commons-codec.jar,commons-httpclient.jar,dom4j.jar,jaxen.jar"
					/>
				</copy>

				<copy todir="${app.server.instance.dir}/lib" overwrite="yes">
					<fileset
						dir="lib/portal"
						includes="commons-codec.jar,commons-collections.jar,commons-httpclient.jar"
					/>
				</copy>

				<delete>
					<fileset
						dir="${app.server.instance.dir}/lib"
						includes="hibernate3.jar,jboss-hibernate.jar"
					/>
				</delete>
			</then>
			<elseif>
				<equals arg1="${app.server.type}" arg2="jetty" />
				<then>

					<!--
					Jetty 5.1.10 defaults to a different version of Commons
					Logging and Hypersonic.
					-->

					<copy todir="${app.server.dir}/ext" overwrite="yes">
						<fileset
							dir="lib/portal"
							includes="commons-logging.jar"
						/>
					</copy>

					<delete file="${app.server.dir}/extra/ext/hsqldb.jar" />
				</then>
			</elseif>
		</if>

		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="glassfish" />
				<equals arg1="${app.server.type}" arg2="pramati" />
			</or>
			<then>
				<tstamp>
					<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
				</tstamp>

				<jar
					basedir="${app.server.portal.dir}"
					jarfile="${tstamp.value}"
				/>

				<delete dir="${app.server.portal.dir}" />

				<move file="${tstamp.value}" tofile="${app.server.portal.dir}" />
			</then>
		</if>

		<antcall target="print-current-time" />
	</target>

	<target name="deploy-properties">
		<copy todir="${app.server.classes.portal.dir}" overwrite="yes">
			<fileset dir="portal-impl/classes">
				<include name="*-ext.properties" />
			</fileset>
		</copy>

		<if>
			<not>
				<available file="${app.server.classes.portal.dir}/portal-ext.properties" />
			</not>
			<then>
				<mkdir dir="${app.server.classes.portal.dir}" />

				<echo file="${app.server.classes.portal.dir}/portal-ext.properties" append="false">auto.deploy.dest.dir=../webapps</echo>
			</then>
		</if>

		<if>
			<equals arg1="${app.server.type}" arg2="geronimo-tomcat" />
			<then>
				<replace file="${app.server.classes.portal.dir}/portal-ext.properties">
					<replacetoken>auto.deploy.dest.dir=../webapps</replacetoken>
					<replacevalue>auto.deploy.dest.dir=../deploy</replacevalue>
				</replace>
			</then>
		</if>

		<if>
			<equals arg1="${app.server.type}" arg2="glassfish" />
			<then>
				<replace file="${app.server.classes.portal.dir}/portal-ext.properties">
					<replacetoken>auto.deploy.dest.dir=../webapps</replacetoken>
					<replacevalue>auto.deploy.dest.dir=../domains/domain1/autodeploy</replacevalue>
				</replace>
			</then>
		</if>

		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="jboss-jetty" />
				<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
			</or>
			<then>
				<replace file="${app.server.classes.portal.dir}/portal-ext.properties">
					<replacetoken>auto.deploy.dest.dir=../webapps</replacetoken>
					<replacevalue>auto.deploy.dest.dir=../server/default/deploy</replacevalue>
				</replace>
			</then>
		</if>

		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="jonas-jetty" />
				<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
			</or>
			<then>
				<replace file="${app.server.classes.portal.dir}/portal-ext.properties">
					<replacetoken>auto.deploy.dest.dir=../webapps</replacetoken>
					<replacevalue>auto.deploy.dest.dir=../../webapps/autoload</replacevalue>
				</replace>
			</then>
		</if>

		<if>
			<equals arg1="${app.server.type}" arg2="pramati" />
			<then>
				<replace file="${app.server.classes.portal.dir}/portal-ext.properties">
					<replacetoken>auto.deploy.dest.dir=../webapps</replacetoken>
					<replacevalue>auto.deploy.dest.dir=../nodes/liferay/archives/autodeploy</replacevalue>
				</replace>
			</then>
		</if>

		<if>
			<equals arg1="${app.server.type}" arg2="resin" />
			<then>
				<replace file="${app.server.classes.portal.dir}/portal-ext.properties">
					<replacetoken>auto.deploy.dest.dir=../webapps</replacetoken>
					<replacevalue>auto.deploy.dest.dir=webapps</replacevalue>
				</replace>
			</then>
		</if>
	</target>

	<target name="build-eclipse">
		<copy todir="${lp.eclipse.dir}" overwrite="yes">
			<fileset dir="tools/eclipse_workspace_tmpl" />
			<filterset>
				<filter token="JAVA_HOME" value="${env.JAVA_HOME}" />
			</filterset>
		</copy>

		<replace file="${lp.eclipse.dir}/.metadata/.plugins/org.eclipse.debug.core/.launches/jboss-jetty.launch">
			<replacefilter
				token="@JBOSS_HOME@"
				value="${app.server.jboss-jetty.dir}"
			/>
		</replace>

		<replace file="${lp.eclipse.dir}/.metadata/.plugins/org.eclipse.debug.core/.launches/jboss-tomcat.launch">
			<replacefilter
				token="@JBOSS_HOME@"
				value="${app.server.jboss-tomcat.dir}"
			/>
		</replace>
	</target>

	<target name="build-ext">
		<available file="${lp.ext.dir}/modules" type="dir" property="lp.ext.dir.available" />

		<antcall target="build-ext-dir" />

		<if>
			<not>
				<available file="${lp.ext.dir}/ext-service" type="dir" />
			</not>
			<then>
				<mkdir dir="${lp.ext.dir}/ext-service" />

				<copy todir="${lp.ext.dir}/ext-service" filtering="true">
					<fileset dir="tools/ext_tmpl/ext-service" />
				</copy>
			</then>
		</if>

		<copy todir="${lp.ext.dir}" preservelastmodified="true">
			<fileset
				dir="."
				includes="app.server.properties"
			/>
			<fileset
				dir="tools/ext_tmpl"
				includes=".classpath,.project,readme.txt,build.properties,**/build-common*.xml,**/build-parent.xml"
			/>
			<filterset>
				<filter token="lp.version" value="${lp.version}" />
				<filter token="lp.version.file.name" value="${lp.version.file.name}" />
				<filter token="lp.eclipse.project.name" value="${lp.eclipse.project.name}" />
			</filterset>
		</copy>

		<mkdir dir="${lp.ext.dir}/downloads" />

		<mkdir dir="${lp.ext.dir}/ext-lib" />
		<mkdir dir="${lp.ext.dir}/ext-lib/development" />
		<mkdir dir="${lp.ext.dir}/ext-lib/global" />
		<mkdir dir="${lp.ext.dir}/ext-lib/portal" />

		<copy file="lib/readme.txt" todir="${lp.ext.dir}/ext-lib" />

		<copy todir="${lp.ext.dir}/lib" preservelastmodified="true">
			<fileset dir="lib" />
		</copy>

		<delete file="${lp.ext.dir}/lib/portal/util-jsf.jar" failonerror="false" />

		<copy todir="${lp.ext.dir}/lib/development" preservelastmodified="true">
			<fileset dir="${project.dir}/support-tomcat" includes="support-tomcat.jar" />
		</copy>

		<copy todir="${lp.ext.dir}/lib/global" preservelastmodified="true">
			<fileset dir="${project.dir}/portal-kernel" includes="portal-kernel.jar" />
			<fileset dir="${project.dir}/portal-service" includes="portal-service.jar" />
		</copy>

		<delete file="${lp.ext.dir}/lib/global/portal-shared.jar" failonerror="false" />

		<copy todir="${lp.ext.dir}/lib/portal" preservelastmodified="true">
			<fileset dir="${project.dir}/filters/compression" includes="compression-filter.jar" />
			<fileset dir="${project.dir}/filters/doubleclick" includes="doubleclick-filter.jar" />
			<fileset dir="${project.dir}/filters/header" includes="header-filter.jar" />
			<fileset dir="${project.dir}/filters/secure" includes="secure-filter.jar" />
			<fileset dir="${project.dir}/filters/strip" includes="strip-filter.jar" />
			<fileset dir="${project.dir}/util-bridges" includes="util-bridges.jar" />
			<fileset dir="${project.dir}/util-java" includes="util-java.jar" />
			<fileset dir="${project.dir}/util-taglib" includes="util-taglib.jar" />
			<fileset dir="${project.dir}/util-wsrp" includes="util-wsrp.jar" />
		</copy>

		<copy todir="${lp.ext.dir}/modules" preservelastmodified="true">
			<fileset dir="${project.dir}/counter-impl" includes="counter-impl.jar" />
			<fileset dir="${project.dir}/documentlibrary-impl" includes="documentlibrary-impl.jar" />
			<fileset dir="${project.dir}/lock-impl" includes="lock-impl.jar" />
			<fileset dir="${project.dir}/mail-impl" includes="mail-impl.jar" />
			<fileset dir="${project.dir}/portal-impl" includes="portal-impl.jar" />
			<fileset dir="${project.dir}/portal-web" includes="portal-web.war" />
			<fileset dir="${project.dir}/tunnel-web" includes="tunnel-web.war" />
		</copy>

		<mkdir dir="${lp.ext.dir}/servers/geronimo-jetty" />
		<mkdir dir="${lp.ext.dir}/servers/geronimo-tomcat" />
		<mkdir dir="${lp.ext.dir}/servers/jboss-jetty" />
		<mkdir dir="${lp.ext.dir}/servers/jboss-tomcat" />
		<mkdir dir="${lp.ext.dir}/servers/jetty" />
		<mkdir dir="${lp.ext.dir}/servers/jonas-jetty" />
		<mkdir dir="${lp.ext.dir}/servers/jonas-tomcat" />
		<mkdir dir="${lp.ext.dir}/servers/resin" />
		<mkdir dir="${lp.ext.dir}/servers/tomcat" />

		<ant dir="sql" target="build-db" inheritAll="false" />
		<ant dir="sql" target="rebuild-hypersonic" inheritAll="false" />

		<copy todir="${lp.ext.dir}/sql" overwrite="yes">
			<fileset dir="sql">
				<exclude name="**/log/**" />
			</fileset>
		</copy>

		<copy todir="${lp.ext.dir}/tools" overwrite="yes">
			<fileset dir="tools" includes="java2html.bat,javadoc.css" />
		</copy>

		<antcall target="print-current-time" />
	</target>

	<target name="build-ext-dir" unless="lp.ext.dir.available">
		<filter token="lp.eclipse.project.name" value="${lp.eclipse.project.name}" />

		<copy todir="${lp.ext.dir}" filtering="true" preservelastmodified="true">
			<fileset dir="tools/ext_tmpl" />
		</copy>
	</target>

	<target name="build-ext-geronimo-tomcat">
		<delete dir="${app.server.geronimo-tomcat.dir}" />

		<unzip src="${app.server.parent.dir}/geronimo-tomcat-1.1.1.zip" dest="${app.server.parent.dir}" />

		<ant dir="sql" target="rebuild-derby" inheritAll="false" />

		<parallel>
			<exec dir="${app.server.geronimo-tomcat.bin.dir}" executable="startup.bat" resolveexecutable="true" />

			<sequential>
				<sleep seconds="20" />

				<ant dir="sql" target="deploy-geronimo-tomcat-derby" inheritAll="false" />

				<sleep seconds="10" />

				<!--<java
					fork="true"
					jar="${app.server.geronimo-tomcat.dir}/bin/deployer.jar"
				>
					<arg line="${app.server.geronimo-tomcat.credentials} deploy dist/liferay-portal-${lp.version.file.name}-with-dependencies.war" />
				</java>

				<sleep seconds="60" />-->

				<exec dir="${app.server.geronimo-tomcat.bin.dir}" executable="shutdown.bat" resolveexecutable="true">
					<arg line="${app.server.geronimo-tomcat.credentials}" />
				</exec>

				<sleep seconds="10" />
			</sequential>
		</parallel>

		<echo file="app.server.${env.COMPUTERNAME}.properties">app.server.type=geronimo-tomcat</echo>

		<antcall target="deploy" inheritAll="false" />

		<delete file="app.server.${env.COMPUTERNAME}.properties" />

		<delete>
			<fileset dir="${app.server.geronimo-tomcat.dir}/var/log" includes="*.log" />
		</delete>
	</target>

	<target name="build-ext-glassfish">
		<delete dir="${app.server.glassfish.dir}" />

		<ant antfile="${lp.ext.dir}/servers/build.xml" target="install-glassfish" inheritAll="false" />

		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=glassfish</echo>

		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />
		<ant dir="${lp.ext.dir}" target="deploy" inheritAll="false" />

		<parallel>
			<exec dir="${app.server.glassfish.bin.dir}" executable="asadmin.bat" resolveexecutable="true">
				<arg value="start-domain" />
				<arg value="domain1" />
			</exec>
			<sequential>
				<waitfor>
					<available file="${app.server.glassfish.portal.dir}_deployed" />
				</waitfor>
				<exec dir="${app.server.glassfish.bin.dir}" executable="asadmin.bat" resolveexecutable="true">
					<arg value="stop-domain" />
					<arg value="domain1" />
				</exec>
			</sequential>
		</parallel>

		<delete dir="${app.server.glassfish.log.dir}" />
		<mkdir dir="${app.server.glassfish.log.dir}" />
	</target>

	<target name="build-ext-jboss-jetty">
		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=jboss-jetty</echo>

		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />
		<ant dir="${lp.ext.dir}" target="deploy" inheritAll="false" />
	</target>

	<target name="build-ext-jboss-tomcat">
		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=jboss-tomcat</echo>

		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />
		<ant dir="${lp.ext.dir}" target="deploy" inheritAll="false" />

		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=jboss-tomcat

app.server.jboss-tomcat.version=4.2
app.server.jboss-tomcat.dir=${app.server.parent.dir}/jboss-tomcat-4.2.0
</echo>

		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />
		<ant dir="${lp.ext.dir}" target="deploy" inheritAll="false" />
	</target>

	<target name="build-ext-jetty">
		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=jetty</echo>

		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />
		<ant dir="${lp.ext.dir}" target="deploy" inheritAll="false" />
	</target>

	<target name="build-ext-jonas-jetty">
		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=jonas-jetty</echo>

		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />
		<ant dir="${lp.ext.dir}" target="deploy" inheritAll="false" />
	</target>

	<target name="build-ext-jonas-tomcat">
		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=jonas-tomcat</echo>

		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />
		<ant dir="${lp.ext.dir}" target="deploy" inheritAll="false" />
	</target>

	<target name="build-ext-pramati">
		<delete dir="${app.server.pramati.dir}" />

		<ant dir="${lp.ext.dir}/servers" target="install-pramati" inheritAll="false" />

		<echo file="app.server.${env.COMPUTERNAME}.properties">app.server.type=pramati</echo>

		<antcall target="deploy" inheritAll="false" />

		<delete file="app.server.${env.COMPUTERNAME}.properties" />

		<parallel>
			<exec dir="${app.server.pramati.bin.dir}" executable="runliferay.bat" resolveexecutable="true" />

			<sequential>
				<sleep seconds="300" />

				<exec dir="${app.server.pramati.bin.dir}" executable="remoteshell.bat" resolveexecutable="true">
					<arg value="-file" />
					<arg value="${lp.ext.dir}/servers/pramati/stop.txt" />
				</exec>

				<sleep seconds="30" />
			</sequential>
		</parallel>

		<delete dir="${app.server.pramati.dir}/server/lf" />

		<copy
			file="tools/ext_tmpl/servers/pramati/server/license.key"
			todir="${app.server.pramati.dir}/server"
			overwrite="yes"
		/>
	</target>

	<target name="build-ext-resin">
		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=resin</echo>

		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />
		<ant dir="${lp.ext.dir}" target="deploy" inheritAll="false" />
	</target>

	<target name="build-ext-tomcat">
		<antcall target="build-ext-tomcat-5.5" />
		<antcall target="build-ext-tomcat-6.0" />
	</target>

	<target name="build-ext-tomcat-5.5">
		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=tomcat</echo>

		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />
		<ant dir="${lp.ext.dir}" target="deploy" inheritAll="false" />
	</target>

	<target name="build-ext-tomcat-6.0">
		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=tomcat

app.server.tomcat.version=6.0
app.server.tomcat.dir=${app.server.parent.dir}/tomcat-6.0.13
app.server.tomcat.classes.global.dir=$${app.server.tomcat.dir}/lib
app.server.tomcat.lib.endorsed.dir=$${app.server.tomcat.dir}/lib/ext
app.server.tomcat.lib.global.dir=$${app.server.tomcat.dir}/lib/ext
app.server.tomcat.lib.support.dir=$${app.server.tomcat.dir}/lib/ext
app.server.tomcat.support.dir=$${app.server.tomcat.dir}/lib/ext
app.server.tomcat.zip.name=liferay-portal-tomcat-6.0-$${downloads.version.file.name}.zip
</echo>

		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />
		<ant dir="${lp.ext.dir}" target="deploy" inheritAll="false" />
	</target>

	<target name="clean-ext">
		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=jboss-jetty</echo>
		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />

		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=jboss-tomcat</echo>
		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />

		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=jetty</echo>
		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />

		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=jonas-jetty</echo>
		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />

		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=jonas-tomcat</echo>
		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />

		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=resin</echo>
		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />

		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=tomcat</echo>
		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />
	</target>

	<target name="sync-ext">
		<copy todir="tools/ext_tmpl/ext-impl" overwrite="yes">
			<fileset
				dir="${lp.ext.dir}/ext-impl"
				includes="**/*.java,**/*.wsdd,**/*.xml,**/*.81"
			/>
		</copy>

		<copy todir="tools/ext_tmpl/ext-service" overwrite="yes">
			<fileset
				dir="${lp.ext.dir}/ext-service"
				includes="**/*.java"
			/>
		</copy>

		<copy todir="tools/ext_tmpl/ext-web/docroot/WEB-INF" overwrite="yes">
			<fileset
				dir="${lp.ext.dir}/ext-web/docroot/WEB-INF"
				includes="*.xml,*.wsdd"
			/>
		</copy>
	</target>

	<target name="zip-api">
		<delete file="dist/liferay-portal-doc-${lp.version.file.name}.zip" failonerror="false" />

		<zip
			basedir="."
			destfile="dist/liferay-portal-doc-${lp.version.file.name}.zip"
			includes="api/**/*.css,api/**/*.gif,api/**/*.html"
		/>
	</target>

	<target name="zip-geronimo-tomcat">
		<delete file="dist/liferay-portal-geronimo-tomcat-${lp.version.file.name}.zip" failonerror="false" />

		<zip
			basedir="${app.server.geronimo-tomcat.dir}"
			destfile="dist/liferay-portal-geronimo-tomcat-${lp.version.file.name}.zip"
		/>
	</target>

	<target name="zip-glassfish">
		<delete file="dist/liferay-portal-glassfish-${lp.version.file.name}.zip" failonerror="false" />

		<zip
			basedir="${app.server.glassfish.dir}"
			destfile="dist/liferay-portal-glassfish-${lp.version.file.name}.zip"
		/>

		<taskdef
			classname="org.tp23.antinstaller.taskdefs.Installer"
			classpathref="project.classpath"
			name="installer"
		/>

		<delete file="dist/liferay-portal-glassfish-${lp.version.file.name}.jar" failonerror="false" />

		<copy file="installer/glassfish/installer-config.xml.template" tofile="installer/glassfish/installer-config.xml" overwrite="yes">
			<filterset>
				<filter token="lp.version.file.name" value="${lp.version.file.name}" />
			</filterset>
		</copy>

		<pathconvert
			property="java.home.path.unix"
			targetos="unix"
		>
			<path>
				<pathelement location="${env.JAVA_HOME}" />
			</path>
		</pathconvert>

		<copy file="installer/glassfish/installer-build.properties.template" tofile="installer/glassfish/installer-build.properties" overwrite="yes">
			<filterset>
				<filter token="app.server.glassfish.dir" value="${app.server.glassfish.dir}" />
				<filter token="java.home" value="${java.home.path.unix}" />
				<filter token="lp.version.file.name" value="${lp.version.file.name}" />
			</filterset>
		</copy>

		<installer
			antInstallLib="${ant.installer.dir}/lib"
			antLib="${env.ANT_HOME}/lib"
			buildFile="installer/glassfish/installer-build.xml"
			compress="true"
			extractType="SelfExtractor"
			failOnError="true"
			file="dist/liferay-portal-glassfish-${lp.version.file.name}.jar"
			installConfig="installer/glassfish/installer-config.xml"
			validateConfig="true"
		>
			<fileset dir="installer/glassfish" includes="installer-build.properties" />
			<fileset dir="dist" includes="liferay-portal-glassfish-${lp.version.file.name}.zip" />
		</installer>

		<jar
			destfile="dist/liferay-portal-glassfish-${lp.version.file.name}.jar"
			update="yes"
		>
			<fileset
				dir="installer"
				includes="resources/extract-image.png"
			/>
		</jar>

		<delete file="dist/liferay-portal-glassfish-${lp.version.file.name}.zip" failonerror="false" />
	</target>

	<target name="zip-jboss">
		<delete file="dist/liferay-portal-jboss-jetty-4.0-${lp.version.file.name}.zip" failonerror="false" />

		<zip
			basedir="${app.server.jboss-jetty.dir}"
			destfile="dist/liferay-portal-jboss-jetty-4.0-${lp.version.file.name}.zip"
		/>

		<delete file="dist/liferay-portal-jboss-tomcat-4.0-${lp.version.file.name}.zip" failonerror="false" />

		<zip
			basedir="${app.server.jboss-tomcat.dir}"
			destfile="dist/liferay-portal-jboss-tomcat-4.0-${lp.version.file.name}.zip"
		/>

		<delete file="dist/liferay-portal-jboss-tomcat-4.2-${lp.version.file.name}.zip" failonerror="false" />

		<zip
			basedir="${app.server.parent.dir}/jboss-tomcat-4.2.0"
			destfile="dist/liferay-portal-jboss-tomcat-4.2-${lp.version.file.name}.zip"
		/>
	</target>

	<target name="zip-jetty">
		<delete file="dist/liferay-portal-jetty-${lp.version.file.name}.zip" failonerror="false" />

		<zip
			basedir="${app.server.jetty.dir}"
			destfile="dist/liferay-portal-jetty-${lp.version.file.name}.zip"
		/>
	</target>

	<target name="zip-jonas">
		<delete file="dist/liferay-portal-jonas-jetty-${lp.version.file.name}.zip" failonerror="false" />

		<zip
			basedir="${app.server.jonas-jetty.dir}"
			destfile="dist/liferay-portal-jonas-jetty-${lp.version.file.name}.zip"
		/>

		<delete file="dist/liferay-portal-jonas-tomcat-${lp.version.file.name}.zip" failonerror="false" />

		<zip
			basedir="${app.server.jonas-tomcat.dir}"
			destfile="dist/liferay-portal-jonas-tomcat-${lp.version.file.name}.zip"
		/>
	</target>

	<target name="zip-portal-client">
		<delete file="dist/liferay-portal-client-${lp.version.file.name}.zip" failonerror="false" />

		<zip
			basedir="."
			destfile="dist/liferay-portal-client-${lp.version.file.name}.zip"
			includes="lib/development/activation.jar,lib/development/mail.jar,lib/portal/axis.jar,lib/portal/commons-discovery.jar,lib/portal/commons-logging.jar,lib/portal/jaxrpc.jar,lib/portal/saaj.jar,lib/portal/wsdl4j.jar,portal-client/portal-client.jar"
		/>
	</target>

	<target name="zip-portal-dependencies">
		<delete file="dist/liferay-portal-dependencies-${lp.version.file.name}.zip" failonerror="false" />

		<zip destfile="dist/liferay-portal-dependencies-${lp.version.file.name}.zip">
			<fileset dir="lib/global" includes="portlet.jar" />
			<fileset dir="portal-kernel" includes="portal-kernel.jar" />
			<fileset dir="portal-service" includes="portal-service.jar" />
		</zip>
	</target>

	<target name="zip-portal-war">
		<delete file="dist/liferay-portal-${lp.version.file.name}.war" failonerror="false" />

		<zip
			basedir="${app.server.portal.dir}"
			destfile="dist/liferay-portal-${lp.version.file.name}.war"
		/>

		<copy
			file="dist/liferay-portal-${lp.version.file.name}.war"
			tofile="dist/liferay-portal-${lp.version.file.name}-with-dependencies.war"
			overwrite="yes"
		/>

		<tstamp>
			<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
		</tstamp>

		<copy todir="${tstamp.value}/WEB-INF/lib">
			<fileset
				dir="${app.server.lib.global.dir}"
				includes="portal-kernel.jar,portal-service.jar,portlet.jar"
			/>
		</copy>

		<zip
			basedir="${tstamp.value}"
			destfile="dist/liferay-portal-${lp.version.file.name}-with-dependencies.war"
			update="yes"
		/>

		<delete dir="${tstamp.value}" />
	</target>

	<target name="zip-pramati">
		<delete file="dist/liferay-portal-pramati-${lp.version.file.name}.zip" failonerror="false" />

		<zip
			basedir="${app.server.pramati.dir}"
			destfile="dist/liferay-portal-pramati-${lp.version.file.name}.zip"
			excludes="server/nodes/liferay/archives/autodeploy/*.war"
		/>

		<taskdef
			classname="org.tp23.antinstaller.taskdefs.Installer"
			classpathref="project.classpath"
			name="installer"
		/>

		<delete file="dist/liferay-portal-pramati-${lp.version.file.name}.jar" failonerror="false" />

		<copy file="installer/pramati/installer-config.xml.template" tofile="installer/pramati/installer-config.xml" overwrite="yes">
			<filterset>
				<filter token="lp.version.file.name" value="${lp.version.file.name}" />
			</filterset>
		</copy>

		<pathconvert
			property="java.home.path.unix"
			targetos="unix"
		>
			<path>
				<pathelement location="${env.JAVA_HOME}" />
			</path>
		</pathconvert>

		<copy file="installer/pramati/installer-build.properties.template" tofile="installer/pramati/installer-build.properties" overwrite="yes">
			<filterset>
				<filter token="app.server.pramati.dir" value="${app.server.pramati.dir}" />
				<filter token="java.home" value="${java.home.path.unix}" />
				<filter token="lp.version.file.name" value="${lp.version.file.name}" />
			</filterset>
		</copy>

		<installer
			antInstallLib="${ant.installer.dir}/lib"
			antLib="${env.ANT_HOME}/lib"
			buildFile="installer/pramati/installer-build.xml"
			compress="true"
			extractType="SelfExtractor"
			failOnError="true"
			file="dist/liferay-portal-pramati-${lp.version.file.name}.jar"
			installConfig="installer/pramati/installer-config.xml"
			validateConfig="true"
		>
			<fileset dir="installer/pramati" includes="installer-build.properties" />
			<fileset dir="dist" includes="liferay-portal-pramati-${lp.version.file.name}.zip" />
		</installer>

		<jar
			destfile="dist/liferay-portal-pramati-${lp.version.file.name}.jar"
			update="yes"
		>
			<fileset
				dir="installer"
				includes="resources/extract-image.png"
			/>
		</jar>

		<delete file="dist/liferay-portal-pramati-${lp.version.file.name}.zip" failonerror="false" />
	</target>

	<target name="zip-resin">
		<delete file="dist/liferay-portal-resin-${lp.version.file.name}.zip" failonerror="false" />

		<zip
			basedir="${app.server.resin.dir}"
			destfile="dist/liferay-portal-resin-${lp.version.file.name}.zip"
		/>
	</target>

	<target name="zip-sql">
		<delete file="dist/liferay-portal-sql-${lp.version.file.name}.zip" failonerror="false" />

		<zip
			basedir="sql"
			destfile="dist/liferay-portal-sql-${lp.version.file.name}.zip"
			includes="**/*.sql"
		/>
	</target>

	<target name="zip-src">
		<delete file="dist/liferay-portal-src-${lp.version.file.name}.zip" failonerror="false" />

		<zip
			basedir="${lp.source.dir}"
			destfile="dist/liferay-portal-src-${lp.version.file.name}.zip"
			excludes="**/CVS/**"
		/>
	</target>

	<target name="zip-tomcat">
		<antcall target="zip-tomcat-5.5" />
		<antcall target="zip-tomcat-6.0" />
	</target>

	<target name="zip-tomcat-5.5">
		<delete file="dist/liferay-portal-tomcat-5.5-${lp.version.file.name}.zip" failonerror="false" />

		<zip
			basedir="${app.server.tomcat.dir}"
			destfile="dist/liferay-portal-tomcat-5.5-${lp.version.file.name}.zip"
		/>

		<delete file="dist/liferay-portal-tomcat-5.5-jdk5-${lp.version.file.name}.zip" failonerror="false" />

		<zip
			basedir="${app.server.tomcat.dir}"
			destfile="dist/liferay-portal-tomcat-5.5-jdk5-${lp.version.file.name}.zip"
			excludes="bin/jmx.jar"
		/>
	</target>

	<target name="zip-tomcat-6.0">
		<delete file="dist/liferay-portal-tomcat-6.0-${lp.version.file.name}.zip" failonerror="false" />

		<zip
			basedir="${app.server.parent.dir}/tomcat-6.0.13"
			destfile="dist/liferay-portal-tomcat-6.0-${lp.version.file.name}.zip"
		/>
	</target>

	<target name="dist">
		<antcall target="clean" />
		<antcall target="start" />
		<antcall target="deploy" />

		<antcall target="java2html" />

		<delete dir="dist" />
		<mkdir dir="dist" />

		<antcall target="zip-portal-war" />

		<antcall target="build-ext" />
		<antcall target="build-ext-geronimo-tomcat" />
		<antcall target="build-ext-jboss-jetty" />
		<antcall target="build-ext-jboss-tomcat" />
		<antcall target="build-ext-jetty" />
		<antcall target="build-ext-jonas-jetty" />
		<antcall target="build-ext-jonas-tomcat" />
		<antcall target="build-ext-resin" />
		<antcall target="build-ext-tomcat" />

		<antcall target="zip-api" />
		<antcall target="zip-geronimo-tomcat" />
		<antcall target="zip-jboss" />
		<antcall target="zip-jetty" />
		<antcall target="zip-jonas" />
		<antcall target="zip-portal-client" />
		<antcall target="zip-portal-dependencies" />
		<antcall target="zip-resin" />
		<antcall target="zip-sql" />
		<antcall target="zip-src" />
		<antcall target="zip-tomcat" />

		<ant dir="cms-web" target="war" inheritAll="false" />
		<ant dir="jbpm-web" target="war" inheritAll="false" />
		<ant dir="mule-web" target="war" inheritAll="false" />
		<ant dir="servicemix-web" target="war" inheritAll="false" />

		<copy file="cas-web/cas-web.war" tofile="dist/liferay-portal-cas-web-${lp.version.file.name}.war" />
		<copy file="cms-web/cms-web.war" tofile="dist/liferay-portal-cms-web-${lp.version.file.name}.war" />
		<copy file="jbpm-web/jbpm-web.war" tofile="dist/liferay-portal-jbpm-web-${lp.version.file.name}.war" />
		<copy file="mule-web/mule-web.war" tofile="dist/liferay-portal-mule-web-${lp.version.file.name}.war" />
		<copy file="servicemix-web/servicemix-web.war" tofile="dist/liferay-portal-servicemix-web-${lp.version.file.name}.war" />
		<copy file="tunnel-web/tunnel-web.war" tofile="dist/liferay-portal-tunnel-web-${lp.version.file.name}.war" />

		<delete includeemptydirs="true" failonerror="false">
			<fileset
				dir="${app.server.tomcat.deploy.dir}"
				includes="cms-web/**,jbpm-web/**,mule-web/**,servicemix-web/**"
			/>
		</delete>

		<ant dir="${lp.plugins.dir}" target="extract-plugins-sdk" inheritAll="false" />

		<copy file="${lp.plugins.dir}/dist/liferay-plugins-sdk-${lp.version}.zip" todir="dist" />
	</target>

	<target name="dist-jdk5">
		<antcall target="build-ext-glassfish" />
		<antcall target="build-ext-pramati" />

		<antcall target="zip-glassfish" />
		<antcall target="zip-pramati" />
	</target>
</project>