<?xml version="1.0"?>

<project name="portal" basedir="." default="compile">
	<property name="project.dir" value="." />

	<import file="build-common.xml" />

	<target name="all" depends="clean,start,deploy" />

	<target name="start">
		<antcall target="compile" />

		<ant dir="sql" target="build-db" inheritAll="false" />
		<ant dir="sql" target="load-db" inheritAll="false" />
		
		<ant dir="portal-ejb" target="build-newscategories" inheritAll="false" />
		<ant dir="portal-ejb" target="build-reverendfun" inheritAll="false" />
  		<ant dir="portal-ejb" target="build-color-scheme" inheritAll="false" />
  		<ant dir="portal-ejb" target="build-common-images" inheritAll="false" />
  		<ant dir="portal-ejb" target="build-website" inheritAll="false" />

		<antcall target="jar" />
	</target>

	<target name="clean">
		<ant dir="classes" target="clean" inheritAll="false" />

		<ant dir="portal-kernel" target="clean" inheritAll="false" />

		<ant dir="util-bridges" target="clean" inheritAll="false" />
		<ant dir="util-java" target="clean" inheritAll="false" />
		<ant dir="util-taglib" target="clean" inheritAll="false" />
		<ant dir="util-wsrp" target="clean" inheritAll="false" />

		<ant dir="applets" target="clean" inheritAll="false" />
		<ant dir="filters" target="clean" inheritAll="false" />

		<ant dir="counter-ejb" target="clean" inheritAll="false" />
		<ant dir="documentlibrary-ejb" target="clean" inheritAll="false" />
		<ant dir="lock-ejb" target="clean" inheritAll="false" />
		<ant dir="mail-ejb" target="clean" inheritAll="false" />
		<ant dir="portal-ejb" target="clean" inheritAll="false" />

		<ant dir="cms-web" target="clean" inheritAll="false" />
		<ant dir="laszlo-web" target="clean" inheritAll="false" />
		<ant dir="portal-web" target="clean" inheritAll="false" />
		<ant dir="tunnel-web" target="clean" inheritAll="false" />
		<ant dir="web-sites" target="clean" inheritAll="false" />

		<ant dir="portlets" target="clean" inheritAll="false" />

		<delete>
			<fileset dir="." includes="*.ear,*.war,*.zip" />
		</delete>

		<delete includeemptydirs="true" failonerror="false">
			<fileset dir="${app.server.bin.dir}" includes="*.log*,ActiveMQ/**,alf_data/**" />
		</delete>

		<if>
			<equals arg1="${app.server.type}" arg2="orion" />
			<then>
				<delete>
					<fileset
						dir="${app.server.dir}"
						includes="**/state.ser,**/transaction.state"
					/>
				</delete>
			</then>
		</if>

		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="jonas-jetty" />
				<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
			</or>
			<then>
				<delete failonerror="false">
					<fileset dir="${app.server.bin.dir}/nt" includes="test.*" />
				</delete>
				<delete failonerror="false">
					<fileset dir="${app.server.bin.dir}/unix" includes="test.*" />
				</delete>
			</then>
			<else>
				<delete failonerror="false">
					<fileset dir="${app.server.bin.dir}" includes="test.*" />
				</delete>
			</else>
		</if>

		<delete failonerror="false">
			<fileset
				dir="${app.server.classes.portal.dir}"
				includes="*-ext.properties"
			/>
		</delete>

		<delete includeemptydirs="true" failonerror="false">
			<fileset
				dir="${app.server.deploy.dir}"
				includes="cms-web*/**,laszlo-web*/**,sample*/**,tunnel-web*/**"
			/>
		</delete>

		<delete failonerror="false">
			<fileset
				dir="${app.server.lib.global.dir}"
				excludes="${jdbc.drivers}"
			/>
		</delete>

		<delete failonerror="false">
			<fileset
				dir="${app.server.lib.portal.dir}"
				excludes="${jdbc.drivers}"
			/>
		</delete>

		<delete dir="${app.server.log.dir}" />
		<delete dir="${app.server.portal.dir}" />
		<delete dir="${app.server.temp.dir}" />
		<delete dir="${app.server.work.dir}" />
	</target>

	<target name="compile">
		<ant dir="portal-kernel" target="compile" inheritAll="false" />

		<ant dir="util-bridges" target="compile" inheritAll="false" />
		<ant dir="util-java" target="compile" inheritAll="false" />
		<ant dir="util-wsrp" target="compile" inheritAll="false" />

		<ant dir="portal-ejb" target="compile-common" inheritAll="false" />

		<ant dir="applets" target="compile" inheritAll="false" />
		<ant dir="filters" target="compile" inheritAll="false" />

		<ant dir="counter-ejb" target="compile" inheritAll="false" />
		<ant dir="documentlibrary-ejb" target="compile" inheritAll="false" />
		<ant dir="lock-ejb" target="compile" inheritAll="false" />
		<ant dir="mail-ejb" target="compile" inheritAll="false" />
		<ant dir="portal-ejb" target="compile" inheritAll="false" />

		<ant dir="portlets" target="compile" inheritAll="false" />
	</target>

	<target name="jar">
		<ant dir="portal-kernel" target="jar" inheritAll="false" />

		<ant dir="util-bridges" target="jar" inheritAll="false" />
		<ant dir="util-java" target="jar" inheritAll="false" />
		<ant dir="util-taglib" target="deploy" inheritAll="false" />
		<ant dir="util-wsrp" target="jar" inheritAll="false" />

		<ant dir="applets" target="deploy" inheritAll="false" />
		<ant dir="filters" target="jar" inheritAll="false" />

		<ant dir="counter-ejb" target="jar" inheritAll="false" />
		<ant dir="documentlibrary-ejb" target="jar" inheritAll="false" />
		<ant dir="lock-ejb" target="jar" inheritAll="false" />
		<ant dir="mail-ejb" target="jar" inheritAll="false" />
		<ant dir="portal-ejb" target="jar" inheritAll="false" />

		<ant dir="cms-web" target="war" inheritAll="false" />
		<ant dir="laszlo-web" target="war" inheritAll="false" />
		<ant dir="portal-web" target="war" inheritAll="false" />
		<ant dir="tunnel-web" target="war" inheritAll="false" />
		<ant dir="web-sites" target="war" inheritAll="false" />

		<ant dir="portlets" target="war" inheritAll="false" />
	</target>

	<target name="java2html">
		<delete dir="api" />

		<ant dir="portal-kernel" target="java2html" inheritAll="false" />

		<ant dir="util-bridges" target="java2html" inheritAll="false" />
		<ant dir="util-java" target="java2html" inheritAll="false" />
		<ant dir="util-taglib" target="java2html" inheritAll="false" />
		<ant dir="util-wsrp" target="java2html" inheritAll="false" />

		<ant dir="applets" target="java2html" inheritAll="false" />
		<ant dir="filters" target="java2html" inheritAll="false" />

		<ant dir="counter-ejb" target="java2html" inheritAll="false" />
		<ant dir="documentlibrary-ejb" target="java2html" inheritAll="false" />
		<ant dir="lock-ejb" target="java2html" inheritAll="false" />
		<ant dir="mail-ejb" target="java2html" inheritAll="false" />
		<ant dir="portal-ejb" target="java2html" inheritAll="false" />

		<ant dir="portal-client" target="java2html" inheritAll="false" />
	</target>

	<target name="javadoc">
		<ant dir="portal-kernel" target="javadoc" inheritAll="false" />

		<ant dir="util-bridges" target="javadoc" inheritAll="false" />
		<ant dir="util-java" target="javadoc" inheritAll="false" />
		<ant dir="util-taglib" target="javadoc" inheritAll="false" />
		<ant dir="util-wsrp" target="javadoc" inheritAll="false" />

		<ant dir="applets" target="javadoc" inheritAll="false" />
		<ant dir="filters" target="javadoc" inheritAll="false" />

		<ant dir="counter-ejb" target="javadoc" inheritAll="false" />
		<ant dir="documentlibrary-ejb" target="javadoc" inheritAll="false" />
		<ant dir="lock-ejb" target="javadoc" inheritAll="false" />
		<ant dir="mail-ejb" target="javadoc" inheritAll="false" />
		<ant dir="portal-ejb" target="javadoc" inheritAll="false" />
	</target>

	<target name="deploy">
		<ant dir="portal-kernel" target="deploy" inheritAll="false" />

		<ant dir="util-bridges" target="deploy" inheritAll="false" />
		<ant dir="util-java" target="deploy" inheritAll="false" />
		<ant dir="util-taglib" target="deploy" inheritAll="false" />
		<ant dir="util-wsrp" target="deploy" inheritAll="false" />

		<ant dir="applets" target="deploy" inheritAll="false" />
		<ant dir="filters" target="deploy" inheritAll="false" />

		<ant dir="portal-ear" target="deploy" inheritAll="false" />

		<ant dir="counter-ejb" target="deploy" inheritAll="false" />
		<ant dir="documentlibrary-ejb" target="deploy" inheritAll="false" />
		<ant dir="lock-ejb" target="deploy" inheritAll="false" />
		<ant dir="mail-ejb" target="deploy" inheritAll="false" />
		<ant dir="portal-ejb" target="deploy" inheritAll="false" />

		<ant dir="cms-web" target="deploy" inheritAll="false" />
		<ant dir="laszlo-web" target="deploy" inheritAll="false" />
		<ant dir="portal-web" target="deploy" inheritAll="false" />
		<ant dir="tunnel-web" target="deploy" inheritAll="false" />

		<ant dir="layouttpl" target="deploy" inheritAll="false" />
		<ant dir="portlets" target="deploy" inheritAll="false" />
		<ant dir="themes" target="deploy" inheritAll="false" />

		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="jonas-jetty" />
				<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
			</or>
			<then>
				<copy todir="${app.server.bin.dir}/nt">
					<fileset dir="sql">
						<include name="test.*" />
					</fileset>
				</copy>
				<copy todir="${app.server.bin.dir}/unix">
					<fileset dir="sql">
						<include name="test.*" />
					</fileset>
				</copy>
			</then>
			<else>
				<copy todir="${app.server.bin.dir}">
					<fileset dir="sql">
						<include name="test.*" />
					</fileset>
				</copy>
			</else>
		</if>

		<if>
			<not>
				<equals arg1="${app.server.type}" arg2="orion" />
			</not>
			<then>
				<copy todir="${app.server.classes.portal.dir}" overwrite="yes">
					<fileset dir="portal-ejb/classes">
						<include name="*-ext.properties" />
					</fileset>
				</copy>

				<if>
					<not>
						<available file="${app.server.classes.portal.dir}/portal-ext.properties" />
					</not>
					<then>
						<mkdir dir="${app.server.classes.portal.dir}" />

						<echo file="${app.server.classes.portal.dir}/portal-ext.properties" append="false">portal.release=enterprise

portal.ctx=/

auto.deploy.dest.dir=../webapps</echo>
					</then>
				</if>

				<if>
					<or>
						<equals arg1="${app.server.type}" arg2="jetty" />
						<equals arg1="${app.server.type}" arg2="resin" />
						<equals arg1="${app.server.type}" arg2="tomcat" />
					</or>
					<then>
						<replace file="${app.server.classes.portal.dir}/portal-ext.properties">
							<replacetoken>portal.release=enterprise</replacetoken>
							<replacevalue>portal.release=professional</replacevalue>
						</replace>
					</then>
				</if>

				<if>
					<or>
						<equals arg1="${app.server.type}" arg2="jboss-jetty" />
						<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
					</or>
					<then>
						<replace file="${app.server.classes.portal.dir}/portal-ext.properties">
							<replacetoken>auto.deploy.dest.dir=../webapps</replacetoken>
							<replacevalue>auto.deploy.dest.dir=../server/default/deploy</replacevalue>
						</replace>
					</then>
					<elseif>
						<or>
							<equals arg1="${app.server.type}" arg2="jonas-jetty" />
							<equals arg1="${app.server.type}" arg2="jonas-tomcat" />
						</or>
						<then>
							<replace file="${app.server.classes.portal.dir}/portal-ext.properties">
								<replacetoken>auto.deploy.dest.dir=../webapps</replacetoken>
								<replacevalue>auto.deploy.dest.dir=../../webapps/autoload</replacevalue>
							</replace>
						</then>
					</elseif>
					<elseif>
						<equals arg1="${app.server.type}" arg2="resin" />
						<then>
							<replace file="${app.server.classes.portal.dir}/portal-ext.properties">
								<replacetoken>auto.deploy.dest.dir=../webapps</replacetoken>
								<replacevalue>auto.deploy.dest.dir=webapps</replacevalue>
							</replace>
						</then>
					</elseif>
				</if>
			</then>
		</if>

		<copy todir="${app.server.lib.global.dir}">
			<fileset dir="lib/development" includes="hsql.jar" />
			<fileset dir="lib/global" />
		</copy>

		<copy todir="${app.server.lib.portal.dir}">
			<fileset dir="lib/portal" />
		</copy>

		<if>
			<equals arg1="${app.server.type}" arg2="jetty" />
			<then>
				<copy todir="${app.server.lib.portal.dir}">
					<fileset
						dir="lib/development"
						includes="jms.jar,jta.jar"
					/>
				</copy>

				<delete>
					<fileset
						dir="${app.server.lib.portal.dir}"
						includes="xercesImpl.jar,xml-apis.jar"
					/>
				</delete>
			</then>
			<elseif>
				<equals arg1="${app.server.type}" arg2="orion" />
				<then>
					<delete>
						<fileset
							dir="${app.server.lib.portal.dir}"
							includes="xercesImpl.jar,xml-apis.jar"
						/>
					</delete>
				</then>
			</elseif>
			<elseif>
				<equals arg1="${app.server.type}" arg2="resin" />
				<then>
					<copy todir="${app.server.lib.global.dir}">
						<fileset
							dir="lib/development"
							includes="activation.jar,mail.jar"
						/>
					</copy>
				</then>
			</elseif>
			<elseif>
				<equals arg1="${app.server.type}" arg2="tomcat" />
				<then>
					<copy todir="${app.server.lib.global.dir}">
						<fileset
							dir="lib/development"
							includes="activation.jar,jms.jar,jta.jar,mail.jar"
						/>
					</copy>
				</then>
			</elseif>
		</if>

		<mkdir dir="${app.server.log.dir}" />
		<mkdir dir="${app.server.temp.dir}" />
		<mkdir dir="${app.server.work.dir}" />

		<if>
			<or>
				<equals arg1="${app.server.type}" arg2="jboss-jetty" />
				<equals arg1="${app.server.type}" arg2="jboss-tomcat" />
			</or>
			<then>

				<!--
				JBoss 4.0.4 defaults to different versions of dom4j, Commons
				Collections, and Hibernate.
				-->

				<copy todir="${app.server.dir}/lib">
					<fileset
						dir="lib/portal"
						includes="dom4j.jar,jaxen.jar"
					/>
				</copy>

				<copy todir="${app.server.dir}/server/default/lib">
					<fileset
						dir="lib/portal"
						includes="commons-collections.jar"
					/>
				</copy>

				<delete>
					<fileset
						dir="${app.server.dir}/server/default/lib"
						includes="hibernate3.jar,jboss-hibernate.jar"
					/>
				</delete>
			</then>
			<elseif>
				<equals arg1="${app.server.type}" arg2="jetty" />
				<then>

					<!--
					Jetty 5.1.10 defaults to a different version of Commons
					Logging and Hypersonic.
					-->

					<copy todir="${app.server.dir}/ext" overwrite="yes">
						<fileset
							dir="lib/portal"
							includes="commons-logging.jar"
						/>
					</copy>

					<delete file="${app.server.dir}/extra/ext/hsqldb.jar" />
				</then>
			</elseif>
		</if>
	</target>

	<target name="build-eclipse">
		<copy todir="${lp.eclipse.dir}" overwrite="yes">
			<fileset dir="tools/eclipse_workspace_tmpl" />
			<filterset>
				<filter token="JAVA_HOME" value="${env.JAVA_HOME}" />
			</filterset>
		</copy>

		<replace file="${lp.eclipse.dir}/.metadata/.plugins/org.eclipse.debug.core/.launches/jboss-jetty.launch">
			<replacefilter
				token="@JBOSS_HOME@"
				value="${app.server.jboss-jetty.dir}"
			/>
		</replace>

		<replace file="${lp.eclipse.dir}/.metadata/.plugins/org.eclipse.debug.core/.launches/jboss-tomcat.launch">
			<replacefilter
				token="@JBOSS_HOME@"
				value="${app.server.jboss-tomcat.dir}"
			/>
		</replace>

		<replace file="${lp.eclipse.dir}/.metadata/.plugins/org.eclipse.debug.core/.launches/orion.launch">
			<replacefilter
				token="@ORION_HOME@"
				value="${app.server.orion.dir}"
			/>
		</replace>
	</target>

	<target name="build-ext">
		<available file="${lp.ext.dir}" type="dir" property="lp.ext.dir.available" />

		<antcall target="build-ext-dir-new" />
		<antcall target="build-ext-dir-update" />

		<copy todir="${lp.ext.dir}" overwrite="yes">
			<fileset
				dir="tools/ext_tmpl"
				includes=".classpath,.project,app.server.properties,readme.txt"
			/>
			<filterset>
				<filter token="lp.version" value="${lp.version}" />
				<filter token="lp.version.file.name" value="${lp.version.file.name}" />
				<filter token="lp.eclipse.project.name" value="${lp.eclipse.project.name}" />
			</filterset>
		</copy>

		<mkdir dir="${lp.ext.dir}/downloads" />

		<copy todir="${lp.ext.dir}/ext-ear/modules" overwrite="yes">
			<fileset dir="${project.dir}/counter-ejb" includes="counter-ejb.jar" />
			<fileset dir="${project.dir}/documentlibrary-ejb" includes="documentlibrary-ejb.jar" />
			<fileset dir="${project.dir}/lock-ejb" includes="lock-ejb.jar" />
			<fileset dir="${project.dir}/mail-ejb" includes="mail-ejb.jar" />
			<fileset dir="${project.dir}/portal-ejb" includes="portal-ejb.jar" />
			<fileset dir="${project.dir}/cms-web" includes="cms-web.war" />
			<fileset dir="${project.dir}/laszlo-web" includes="laszlo-web.war" />
			<fileset dir="${project.dir}/portal-web" includes="portal-web.war" />
			<fileset dir="${project.dir}/tunnel-web" includes="tunnel-web.war" />
		</copy>

		<mkdir dir="${lp.ext.dir}/ext-lib" />
		<mkdir dir="${lp.ext.dir}/ext-lib/development" />
		<mkdir dir="${lp.ext.dir}/ext-lib/global" />
		<mkdir dir="${lp.ext.dir}/ext-lib/portal" />

		<copy file="lib/readme.txt" todir="${lp.ext.dir}/ext-lib" />

		<copy todir="${lp.ext.dir}/lib" overwrite="yes">
			<fileset dir="lib" />
		</copy>

		<delete file="${lp.ext.dir}/lib/portal/util-jsf.jar" failonerror="false" />

		<copy
			file="${project.dir}/portal-kernel/portal-kernel.jar"
			todir="${lp.ext.dir}/lib/global"
			overwrite="yes"
		/>

		<delete file="${lp.ext.dir}/lib/global/portal-shared.jar" failonerror="false" />

		<copy todir="${lp.ext.dir}/lib/portal" overwrite="yes">
			<fileset dir="${project.dir}/filters/compression" includes="compression-filter.jar" />
			<fileset dir="${project.dir}/filters/secure" includes="secure-filter.jar" />
			<fileset dir="${project.dir}/filters/strip" includes="strip-filter.jar" />
			<fileset dir="${project.dir}/util-bridges" includes="util-bridges.jar" />
			<fileset dir="${project.dir}/util-java" includes="util-java.jar" />
			<fileset dir="${project.dir}/util-wsrp" includes="util-wsrp.jar" />
		</copy>

		<mkdir dir="${lp.ext.dir}/servers/geronimo-jetty" />
		<mkdir dir="${lp.ext.dir}/servers/geronimo-tomcat" />
		<mkdir dir="${lp.ext.dir}/servers/jboss-jetty" />
		<mkdir dir="${lp.ext.dir}/servers/jboss-tomcat" />
		<mkdir dir="${lp.ext.dir}/servers/jetty" />
		<mkdir dir="${lp.ext.dir}/servers/jonas-jetty" />
		<mkdir dir="${lp.ext.dir}/servers/jonas-tomcat" />
		<mkdir dir="${lp.ext.dir}/servers/resin" />
		<mkdir dir="${lp.ext.dir}/servers/tomcat" />

		<ant dir="sql" target="build-db" inheritAll="false" />
		<ant dir="sql" target="load-db" inheritAll="false" />

		<copy todir="${lp.ext.dir}/sql" overwrite="yes">
			<fileset dir="sql">
				<exclude name="**/log/**" />
			</fileset>
		</copy>

		<copy todir="${lp.ext.dir}/tools" overwrite="yes">
			<fileset dir="tools" includes="java2html.bat,javadoc.css" />
		</copy>

		<copy
			file="web-sites/liferay.com-web/docroot/WEB-INF/web.xml"
			todir="${lp.ext.dir}/web-sites/liferay.com-web/docroot/WEB-INF"
			overwrite="yes"
		/>

		<replace file="${lp.ext.dir}/web-sites/liferay.com-web/docroot/WEB-INF/web.xml">
			<replacefilter
				token="/WEB-INF/struts-config.xml"
				value="/WEB-INF/struts-config.xml,/WEB-INF/struts-config-ext.xml"
			/>
		</replace>

		<copy todir="${lp.ext.dir}/web-sites/liferay.com-web/docroot">
			<fileset
				dir="web-sites/liferay.com-web/docroot"
				includes="index.html,WEB-INF/lib/*.jar,WEB-INF/tld/*.tld"
			/>
		</copy>
	</target>

	<target name="build-ext-dir-new" unless="lp.ext.dir.available">
		<filter token="lp.eclipse.project.name" value="${lp.eclipse.project.name}" />

		<copy todir="${lp.ext.dir}" filtering="true">
			<fileset dir="tools/ext_tmpl" />
		</copy>
	</target>

	<target name="build-ext-dir-update" if="lp.ext.dir.available">
		<copy todir="${lp.ext.dir}" overwrite="true">
			<fileset
				dir="tools/ext_tmpl"
				includes="app.server.properties,build.properties,**/build-common.xml,**/build-parent.xml"
			/>
		</copy>

		<copy todir="${lp.ext.dir}" overwrite="false">
			<fileset
				dir="tools/ext_tmpl"
				includes="**/build.xml,**/META-INF/application.xml,**/WEB-INF/remoting-servlet-ext.xml,**/WEB-INF/server-config.wsdd"
			/>
		</copy>
	</target>

	<target name="build-ext-jboss-jetty">
		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=jboss-jetty</echo>

		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />
		<ant dir="${lp.ext.dir}" target="deploy" inheritAll="false" />
	</target>

	<target name="build-ext-jboss-tomcat">
		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=jboss-tomcat</echo>

		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />
		<ant dir="${lp.ext.dir}" target="deploy" inheritAll="false" />
	</target>

	<target name="build-ext-jetty">
		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=jetty</echo>
		
		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />
		<ant dir="${lp.ext.dir}" target="deploy" inheritAll="false" />
	</target>

	<target name="build-ext-jonas-jetty">
		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=jonas-jetty

app.server.jonas-jetty.ejbgen.compile=on</echo>

		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />
		<ant dir="${lp.ext.dir}" target="deploy" inheritAll="false" />
	</target>

	<target name="build-ext-jonas-tomcat">
		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=jonas-tomcat

app.server.jonas-jetty.ejbgen.compile=on</echo>
		
		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />
		<ant dir="${lp.ext.dir}" target="deploy" inheritAll="false" />
	</target>

	<target name="build-ext-resin">
		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=resin</echo>
		
		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />
		<ant dir="${lp.ext.dir}" target="deploy" inheritAll="false" />
	</target>

	<target name="build-ext-tomcat">
		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=tomcat</echo>
		
		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />
		<ant dir="${lp.ext.dir}" target="deploy" inheritAll="false" />
	</target>

	<target name="clean-ext">
		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=jboss-jetty</echo>
		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />

		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=jboss-tomcat</echo>
		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />

		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=jetty</echo>
		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />

		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=jonas-jetty</echo>
		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />

		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=jonas-tomcat</echo>
		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />

		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=resin</echo>
		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />

		<echo file="${lp.ext.dir}/app.server.${user.name}.properties">app.server.type=tomcat</echo>
		<ant dir="${lp.ext.dir}" target="clean" inheritAll="false" />
	</target>

	<target name="sync-ext">
		<copy todir="tools/ext_tmpl/ext-ejb" overwrite="yes">
			<fileset
				dir="${lp.ext.dir}/ext-ejb"
				includes="**/*.java,**/*.wsdd,**/*.xml"
			/>
		</copy>

		<copy
			file="${lp.ext.dir}/ext-web/docroot/WEB-INF/remoting-servlet-ext.xml"
			todir="tools/ext_tmpl/ext-web/docroot/WEB-INF"
			overwrite="yes"
		/>

		<copy
			file="${lp.ext.dir}/ext-web/docroot/WEB-INF/server-config.wsdd"
			todir="tools/ext_tmpl/ext-web/docroot/WEB-INF"
			overwrite="yes"
		/>
	</target>

	<target name="zip">
		<antcall target="zip-api" />
		<antcall target="zip-jboss" />
		<antcall target="zip-jetty" />
		<antcall target="zip-jonas" />
		<antcall target="zip-portal-client" />
		<antcall target="zip-portal-dependencies" />
		<antcall target="zip-resin" />
		<antcall target="zip-sql" />
		<antcall target="zip-src" />
		<antcall target="zip-tomcat" />
	</target>

	<target name="zip-api">
		<delete file="liferay-portal-doc-${lp.version.file.name}.zip" failonerror="false" />
		
		<zip zipfile="liferay-portal-doc-${lp.version.file.name}.zip"
			basedir="."
			includes="api/**/*.css,api/**/*.gif,api/**/*.html"
		/>
	</target>

	<target name="zip-jboss">
		<delete file="liferay-portal-jboss-jetty-${lp.version.file.name}.zip" failonerror="false" />
		
		<zip zipfile="liferay-portal-jboss-jetty-${lp.version.file.name}.zip"
			basedir="${app.server.jboss-jetty.dir}"
		/>

		<delete file="liferay-portal-jboss-tomcat-${lp.version.file.name}.zip" failonerror="false" />
		
		<zip zipfile="liferay-portal-jboss-tomcat-${lp.version.file.name}.zip"
			basedir="${app.server.jboss-tomcat.dir}"
		/>
	</target>

	<target name="zip-jetty">
		<delete file="liferay-portal-jetty-${lp.version.file.name}.zip" failonerror="false" />
		
		<zip zipfile="liferay-portal-jetty-${lp.version.file.name}.zip"
			basedir="${app.server.jetty.dir}"
		/>
	</target>

	<target name="zip-jonas">
		<delete file="liferay-portal-jonas-jetty-${lp.version.file.name}.zip" failonerror="false" />
		
		<zip zipfile="liferay-portal-jonas-jetty-${lp.version.file.name}.zip"
			basedir="${app.server.jonas-jetty.dir}"
		/>

		<delete file="liferay-portal-jonas-tomcat-${lp.version.file.name}.zip" failonerror="false" />
		
		<zip zipfile="liferay-portal-jonas-tomcat-${lp.version.file.name}.zip"
			basedir="${app.server.jonas-tomcat.dir}"
		/>
	</target>

	<target name="zip-portal-client">
		<delete file="liferay-portal-client-${lp.version.file.name}.zip" failonerror="false" />

		<zip zipfile="liferay-portal-client-${lp.version.file.name}.zip"
			basedir="."
			includes="lib/development/activation.jar,lib/development/mail.jar,lib/portal/axis.jar,lib/portal/commons-discovery.jar,lib/portal/commons-logging.jar,lib/portal/jaxrpc.jar,lib/portal/saaj.jar,lib/portal/wsdl4j.jar,portal-client/portal-client.jar,portal-client/test/setenv.bat,portal-client/test/Test.java"
		/>		
	</target>

	<target name="zip-portal-dependencies">
		<delete file="liferay-portal-dependencies-${lp.version.file.name}.zip" failonerror="false" />

		<zip zipfile="liferay-portal-dependencies-${lp.version.file.name}.zip">
			<fileset dir="lib/global" includes="portlet.jar" />
			<fileset dir="portal-kernel" includes="portal-kernel.jar" />
		</zip>
	</target>

	<target name="zip-resin">
		<delete file="liferay-portal-resin-${lp.version.file.name}.zip" failonerror="false" />
		
		<zip zipfile="liferay-portal-resin-${lp.version.file.name}.zip"
			basedir="${app.server.resin.dir}"
		/>
	</target>

	<target name="zip-sql">
		<delete file="liferay-portal-sql-${lp.version.file.name}.zip" failonerror="false" />
		
		<zip zipfile="liferay-portal-sql-${lp.version.file.name}.zip"
			basedir="sql"
			includes="**/*.sql"
		/>
	</target>

	<target name="zip-src">
		<delete file="liferay-portal-src-${lp.version.file.name}.zip" failonerror="false" />
		
		<zip zipfile="liferay-portal-src-${lp.version.file.name}.zip"
			basedir="${lp.source.dir}"
			excludes="**/CVS/**"
		/>
	</target>

	<target name="zip-tomcat">
		<delete file="liferay-portal-tomcat-${lp.version.file.name}.zip" failonerror="false" />
		
		<zip zipfile="liferay-portal-tomcat-${lp.version.file.name}.zip"
			basedir="${app.server.tomcat.dir}"
		/>

		<delete file="liferay-portal-tomcat-jdk5-${lp.version.file.name}.zip" failonerror="false" />
		
		<zip zipfile="liferay-portal-tomcat-jdk5-${lp.version.file.name}.zip"
			basedir="${app.server.tomcat.dir}"
			excludes="bin/jmx.jar,common/endorsed/xml-apis.jar"
		/>
	</target>

	<target name="release">
		<delete>
			<fileset dir="${lp.source.dir}" defaultexcludes="no">
				<include name="**/.#*" />
			</fileset>
		</delete>

		<antcall target="clean" />
		<antcall target="start" />
		<antcall target="java2html" />
		<antcall target="build-ext" />
		<antcall target="build-ext-jboss-jetty" />
		<antcall target="build-ext-jboss-tomcat" />
		<antcall target="build-ext-jetty" />
		<antcall target="build-ext-jonas-jetty" />
		<antcall target="build-ext-jonas-tomcat" />
		<antcall target="build-ext-resin" />
		<antcall target="build-ext-tomcat" />
		<antcall target="zip" />

		<copy file="portal-ear/liferay-portal.ear" tofile="liferay-portal-${lp.version.file.name}.ear" />
		<copy file="portal-ear/liferay-portal-jaas.jar" tofile="liferay-portal-jaas-${lp.version.file.name}.jar" />
		<copy file="portal-ear/liferay-portal.war" tofile="liferay-portal-${lp.version.file.name}.war" />

		<ant dir="layouttpl" target="deploy" inheritAll="false" />
		<ant dir="portlets" target="deploy" inheritAll="false" />
		<ant dir="themes" target="deploy" inheritAll="false" />

		<ant dir="layouttpl" target="war" inheritAll="false" />
		<ant dir="portlets" target="war" inheritAll="false" />

		<delete includeemptydirs="true" failonerror="false">
			<fileset
				dir="${app.server.deploy.dir}"
				includes="sample*/**"
			/>
		</delete>
	</target>

	<target name="test-release">
		<antcall target="clean" />
		<antcall target="start" />
		<antcall target="build-ext" />
		<antcall target="build-ext-jboss-jetty" />
		<antcall target="build-ext-jboss-tomcat" />
		<antcall target="build-ext-jetty" />
		<antcall target="build-ext-jonas-jetty" />
		<antcall target="build-ext-jonas-tomcat" />
		<antcall target="build-ext-resin" />
		<antcall target="build-ext-tomcat" />
	</target>
</project>