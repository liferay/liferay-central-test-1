<?xml version="1.0"?>

<project name="portal-test-database-oracle" basedir="." default="test" xmlns:antelope="antlib:ise.antelope.tasks">
	<import file="build-test.xml" />

	<target name="test-database-oracle-10">
		<antcall target="prepare-tomcat-6.0-mysql-5.0" />

		<antcall target="test-database-oracle-10-latest" />
		<antcall target="test-database-oracle-10-5.1.0" />
		<antcall target="test-database-oracle-10-5.1.1" />
		<antcall target="test-database-oracle-10-5.1.2" />
	</target>

	<target name="test-database-oracle-10-5.1.0">
		<antcall target="test-database-oracle-10-common">
			<param name="sql.version" value="5.1.0" />
		</antcall>
	</target>

	<target name="test-database-oracle-10-5.1.1">
		<antcall target="test-database-oracle-10-common">
			<param name="sql.version" value="5.1.1" />
		</antcall>
	</target>

	<target name="test-database-oracle-10-5.1.2">
		<antcall target="test-database-oracle-10-common">
			<param name="sql.version" value="5.1.2" />
		</antcall>
	</target>

	<target name="test-database-oracle-10-common">
		<echo file="test.${user.name}.properties">db.type=oracle-10</echo>

		<antcall target="prepare-portal-ext-properties" inheritAll="false" />

		<ant dir="portal-impl" target="deploy-properties" inheritAll="false" />

		<if>
			<not>
				<equals arg1="${sql.version}" arg2="$${sql.version}" />
			</not>
			<then>
				<property name="sql.dir" value="sql\legacy\${sql.version}\create\" />
				<property name="sql.file" value="create-oracle.sql" />
			</then>
		</if>

		<antcall target="rebuild-database" inheritAll="false">
			<param name="sql.dir" value="${sql.dir}" />
			<param name="sql.file" value="${sql.file}" />
		</antcall>

		<antcall target="start-selenium" />

		<antcall target="run-tomcat-6.0">
			<param name="skip.rebuild-database" value="true" />
			<param name="test.class" value="SmokeTestSuite" />
		</antcall>

		<antcall target="stop-selenium" />

		<delete file="test.${user.name}.properties" />
	</target>

	<target name="test-database-oracle-10-latest">
		<echo file="create-${db.oracle-10.username}.sql"><![CDATA[drop user &1 cascade;
create user &1 identified by &2;
grant connect,resource to &1;
exit;]]></echo>

		<antcall target="test-database-oracle-10-common">
			<param name="sql.dir" value="" />
			<param name="sql.file" value="create-${db.oracle-10.username}.sql" />
		</antcall>

		<delete file="create-${db.oracle-10.username}.sql" />
	</target>
</project>