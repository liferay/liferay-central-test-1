<?xml version="1.0"?>

<project name="portal-test-plugins" basedir="." default="test" xmlns:antelope="antlib:ise.antelope.tasks">
	<import file="build-test.xml" />

	<target name="create-bat-target">
		<script classpathref="project.classpath" language="beanshell">
			String createFolder = project.getProperty("create.folder");

			if(createFolder.endsWith("s"))
				createFolder = createFolder.substring(0, createFolder.length() - 1);

			project.setProperty("create.folder.new", createFolder);
		</script>

		<if>
			<available file="${lp.plugins.dir}/${create.folder}/test-${create.folder.new}" />
			<then>
				<delete dir="${lp.plugins.dir}/${create.folder}/test-${create.folder.new}" />
			</then>
		</if>

		<exec dir="${lp.plugins.dir}/${create.folder}/" executable="create.bat" resolveexecutable="true">
			<arg line="test test" />
			<redirector outputproperty="create.output" />
		</exec>

		<echo>${create.output}</echo>

		<delete dir="${lp.plugins.dir}/${create.folder}/test-${create.folder.new}" />

		<if>
			<contains string="${create.output}" substring="BUILD FAILED" />
			<then>
				<fail>Create ${created.folder} failed.</fail>
			</then>
		</if>
	</target>

	<target name="deploy-simple-server-plugins">
		<if>
			<not>
				<equals arg1="${plugins.deployed}" arg2="true" />
			</not>
			<then>
				<delete dir="${liferay.home}/data" />
				<delete dir="${liferay.home}/deploy" />
			</then>
		</if>

		<exec dir="${lp.plugins.dir}" executable="cmd.exe">
			<arg line="/c svn --username ${svn.username} --password ${svn.password} update" />
		</exec>

		<echo file="${lp.plugins.dir}/build.${user.name}.properties">app.server.dir=${simple.server.dir}
app.server.lib.global.dir=${simple.server.lib.global.dir}
app.server.portal.dir=${simple.server.portal.dir}

plugins.includes=${plugins.includes}</echo>

		<ant dir="${lp.plugins.dir}/${plugin.types}" inheritAll="false">
			<target name="clean" />
			<target name="deploy" />
		</ant>

		<delete dir="${lp.plugins.dir}/dist" />
		<mkdir dir="${lp.plugins.dir}/dist" />
	</target>

	<target name="deploy-upgrade-simple-server-plugins">
		<exec dir="${lp.plugins.dir}" executable="cmd.exe">
			<arg line="/c svn --username ${svn.username} --password ${svn.password} update" />
		</exec>

		<echo file="${lp.plugins.dir}/build.${user.name}.properties">app.server.dir=${simple.server.dir}
app.server.lib.global.dir=${simple.server.lib.global.dir}
app.server.portal.dir=${simple.server.portal.dir}

auto.deploy.dir=$${user.home}/liferay/deploy

plugins.includes=${plugins.includes}</echo>

		<ant dir="${lp.plugins.dir}/${plugin.types}" inheritAll="false">
			<target name="clean" />
			<target name="deploy" />
		</ant>

		<delete dir="${lp.plugins.dir}/dist" />
		<mkdir dir="${lp.plugins.dir}/dist" />
	</target>

	<target name="deploy-versioned-simple-server-plugins">
		<copy todir="${user.home}/liferay/deploy">
			<fileset
				dir="${hudson.plugin.dependencies.dir}/${lp.version}"
				includes="${plugins.includes}"
			/>
		</copy>
	</target>

	<target name="test-create-bat">
		<echo file="${lp.plugins.dir}/build.${user.name}.properties">app.server.dir=${app.server.tomcat.dir}</echo>

		<foreach list="ext,hooks,layouttpl,portlets,themes" delimiter="," trim="true" param="create.folder" target="create-bat-target" />
	</target>

	<target name="test-service-builder">
		<echo file="${lp.plugins.dir}/build.${user.name}.properties">app.server.dir=${app.server.tomcat.dir}</echo>

		<delete dir="${lp.plugins.dir}/portlets/sample-service-builder-portlet/docroot/WEB-INF/service" />
		<delete dir="${lp.plugins.dir}/portlets/sample-service-builder-portlet/docroot/WEB-INF/src/META-INF" />

		<ant antfile="${lp.plugins.dir}/portlets/sample-service-builder-portlet/build.xml" target="build-service" inheritAll="false" />

		<delete dir="${lp.plugins.dir}/portlets/sample-service-builder-portlet/docroot/WEB-INF/service" />
		<delete dir="${lp.plugins.dir}/portlets/sample-service-builder-portlet/docroot/WEB-INF/src/META-INF" />

		<exec executable="cmd.exe">
			<arg line="/c svn --username ${svn.username} --password ${svn.password} update ${lp.plugins.dir}/portlets/sample-service-builder-portlet/docroot/WEB-INF" />
		</exec>

		<exec executable="cmd.exe">
			<arg line="/c svn revert --recursive ${lp.plugins.dir}/portlets/sample-service-builder-portlet" />
		</exec>
	</target>
</project>