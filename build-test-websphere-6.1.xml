<?xml version="1.0"?>

<project name="portal-test-websphere-6.1" basedir="." default="test" xmlns:antelope="antlib:ise.antelope.tasks">
	<import file="build-test.xml" />

	<target name="run-selenium-websphere-6.1">
		<antcall target="prepare-vm-server">
			<param name="vm.vmdk.suffix" value="websphere-6.1.0.27" />
		</antcall>

		<tstamp>
			<format property="tstamp.value" pattern="yyyyMMddkkmmssSSS" />
		</tstamp>

		<unzip src="dist/liferay-portal-dependencies-${lp.version}.zip" dest="${tstamp.value}">
			<mapper type="flatten" />
		</unzip>

		<copy todir="${tstamp.value}">
			<fileset
				dir="lib/development"
				includes="hsql.jar,jtds.jar,mysql.jar,persistence.jar,postgresql.jar"
			/>
		</copy>

		<if>
			<isset property="jdbc.drivers.optional.dir" />
			<then>
				<copy todir="${tstamp.value}">
					<fileset
						dir="${jdbc.drivers.optional.dir}"
						includes="*.jar"
					/>
				</copy>
			</then>
		</if>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} ${tstamp.value}\*.jar ${vm.username}@${vm.host}:/Progra~1/IBM/WebSphere/AppServer/lib/ext" />
		</exec>

		<delete dir="${tstamp.value}" />

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c move C:\Progra~1\IBM\WebSphere\AppServer\lib\ext\portlet.jar C:\Progra~1\IBM\WebSphere\AppServer\java\jre\lib\ext" />
		</exec>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host}:/Progra~1/IBM/WebSphere/AppServer/profiles/AppSrv01/config/cells/liferay-ead7385Node01Cell/nodes/liferay-ead7385Node01/servers/server1/server.xml server.xml" />
		</exec>

		<replace file="server.xml">
			<replacefilter token="genericJvmArguments=&quot;&quot;" value="genericJvmArguments=&quot;-Dfile.encoding=UTF8 -Xk22000 -Xp64k,16k&quot;" />
			<replacefilter token="verboseModeGarbageCollection=&quot;false&quot;" value="verboseModeGarbageCollection=&quot;true&quot;" />
			<replacefilter token="verboseModeJNI=&quot;false&quot;" value="verboseModeJNI=&quot;false&quot; initialHeapSize=&quot;256&quot; maximumHeapSize=&quot;1024&quot;" />
			<replacefilter token="xmi:id=&quot;DynamicCache_1183122130078&quot; enable=&quot;true&quot;" value="xmi:id=&quot;DynamicCache_1183122130078&quot; enable=&quot;true&quot; defaultPriority=&quot;3&quot; hashSize=&quot;0&quot; cacheSize=&quot;3000&quot;" />
		</replace>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} server.xml ${vm.username}@${vm.host}:/Progra~1/IBM/WebSphere/AppServer/profiles/AppSrv01/config/cells/liferay-ead7385Node01Cell/nodes/liferay-ead7385Node01/servers/server1/server.xml" />
		</exec>

		<delete file="server.xml" />

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c C:\Progra~1\IBM\WebSphere\AppServer\profiles\AppSrv01\bin\startServer.bat server1" />
		</exec>

		<echo file="wsadmin.jacl">$AdminApp uninstall DefaultApplication

$AdminConfig save

$AdminApp install "C:/liferay-portal-${lp.version}.war" {-appname liferay-portal -contextroot /}

$AdminConfig save

$AdminApp install "C:/tunnel-web.war" {-appname liferay-tunnel-web -contextroot /tunnel-web}

$AdminConfig save</echo>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} wsadmin.jacl ${vm.username}@${vm.host}:/" />
		</exec>

		<delete file="wsadmin.jacl" />

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c C:\Progra~1\IBM\WebSphere\AppServer\bin\wsadmin.bat -f C:\wsadmin.jacl" />
		</exec>

		<antcall target="revert-test-properties" />

		<if>
			<or>
				<not>
					<available file="${selenium.nanny.executable}" />
				</not>
				<uptodate
					srcfile="${selenium.nanny.executable}"
					targetfile="${selenium.executable.zip}"
				/>
			</or>
			<then>
				<delete>
					<fileset
						dir="${project.dir}/tools/selenium"
						includes="*.exe"
					/>
				</delete>

				<unzip
					dest="${project.dir}/tools/selenium"
					src="${selenium.executable.zip}"
				/>

				<touch file="${selenium.nanny.executable}" />
			</then>
		</if>

		<if>
			<isset property="selenium.output.dir" />
			<then>
				<replace
					file="portal-web/test/test-portal-web.properties"
					token="output.dir=H:\\selenium-output\\"
					value="output.dir=${selenium.output.dir}"
				/>
			</then>
			<else>
				<property name="selenium.output.dir" value="H:\\selenium-output\\" />
			</else>
		</if>

		<if>
			<not>
				<isset property="skip.delete-selenium-output" />
			</not>
			<then>
				<delete dir="${selenium.output.dir}" />

				<mkdir dir="${selenium.output.dir}" />
			</then>
		</if>

		<if>
			<isset property="test.browser" />
			<then>
				<replace
					file="portal-web/test/test-portal-web.properties"
					token="browser.type=*chrome"
					value="browser.type=*${test.browser}"
				/>
			</then>
			<else>
				<property name="test.browser" value="chrome" />
			</else>
		</if>

		<if>
			<or>
				<equals arg1="${test.browser}" arg2="chrome" />
				<equals arg1="${test.browser}" arg2="firefox" />
			</or>
			<then>
				<replace
					file="portal-web/test/test-portal-web.properties"
					token="#selenium.executable.dir="
					value="selenium.executable.dir=${basedir.unix}/tools/selenium/"
				/>
				<replace
					file="portal-web/test/test-portal-web.properties"
					token="#selenium.download.file.executable="
					value="selenium.download.file.executable=selenium_download_file_ff.exe"
				/>
				<replace
					file="portal-web/test/test-portal-web.properties"
					token="#selenium.set.browser.option.executable="
					value="selenium.set.browser.option.executable=selenium_set_browser_option_ff.exe"
				/>
			</then>
			<elseif>
				<or>
					<equals arg1="${test.browser}" arg2="iehta" />
					<equals arg1="${test.browser}" arg2="iexplorer" />
				</or>
				<then>
					<replace
						file="portal-web/test/test-portal-web.properties"
						token="#selenium.executable.dir="
						value="selenium.executable.dir=${basedir.unix}/tools/selenium/"
					/>
					<replace
						file="portal-web/test/test-portal-web.properties"
						token="#selenium.download.file.executable="
						value="selenium.download.file.executable=selenium_download_file_ie.exe"
					/>
				</then>
			</elseif>
		</if>

		<if>
			<isset property="test.database.minimal" />
			<then>
				<replace
					file="portal-web/test/test-portal-web.properties"
					token="test.database.minimal=false"
					value="test.database.minimal=true"
				/>
			</then>
		</if>

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c C:\Progra~1\IBM\WebSphere\AppServer\profiles\AppSrv01\bin\stopServer.bat server1" />
		</exec>

		<if>
			<or>
				<isset property="hook.plugins.includes" />
				<isset property="plugins.version.includes" />
				<isset property="portlet.plugins.includes" />
				<isset property="portlet.plugins.upgrade.includes" />
				<isset property="theme.plugins.includes" />
				<isset property="web.plugins.includes" />
			</or>
			<then>
				<exec executable="${plink.executable}">
					<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c C:\Progra~1\IBM\WebSphere\AppServer\profiles\AppSrv01\bin\startServer.bat server1" />
				</exec>
			</then>
		</if>

		<if>
			<isset property="hook.plugins.includes" />
			<then>
				<ant antfile="build-test-plugins.xml" target="deploy-websphere-6.1-plugins">
					<property name="plugin.types" value="hooks" />
					<property name="plugins.deployed" value="${plugins.deployed}" />
					<property name="plugins.includes" value="${hook.plugins.includes}" />
				</ant>

				<property name="plugins.deployed" value="true" />
			</then>
		</if>

		<if>
			<isset property="plugins.version.includes" />
			<then>
				<ant antfile="build-test-plugins.xml" target="deploy-versioned-websphere-6.1-plugins">
					<property name="plugins.includes" value="${plugins.version.includes}" />
				</ant>
			</then>
		</if>

		<if>
			<isset property="portlet.plugins.includes" />
			<then>
				<ant antfile="build-test-plugins.xml" target="deploy-websphere-6.1-plugins">
					<property name="plugin.types" value="portlets" />
					<property name="plugins.deployed" value="${plugins.deployed}" />
					<property name="plugins.includes" value="${portlet.plugins.includes}" />
				</ant>

				<property name="plugins.deployed" value="true" />
			</then>
		</if>

		<if>
			<isset property="portlet.plugins.upgrade.includes" />
			<then>
				<ant antfile="build-test-plugins.xml" target="deploy-upgrade-websphere-6.1-plugins">
					<property name="plugin.types" value="portlets" />
					<property name="plugins.includes" value="${portlet.plugins.upgrade.includes}" />
				</ant>
			</then>
		</if>

		<if>
			<isset property="theme.plugins.includes" />
			<then>
				<ant antfile="build-test-plugins.xml" target="deploy-websphere-6.1-plugins">
					<property name="plugin.types" value="themes" />
					<property name="plugins.deployed" value="${plugins.deployed}" />
					<property name="plugins.includes" value="${theme.plugins.includes}" />
				</ant>

				<property name="plugins.deployed" value="true" />
			</then>
		</if>

		<if>
			<isset property="web.plugins.includes" />
			<then>
				<ant antfile="build-test-plugins.xml" target="deploy-websphere-6.1-plugins">
					<property name="plugin.types" value="webs" />
					<property name="plugins.deployed" value="${plugins.deployed}" />
					<property name="plugins.includes" value="${web.plugins.includes}" />
				</ant>

				<property name="plugins.deployed" value="true" />
			</then>
		</if>

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c C:\Progra~1\IBM\WebSphere\AppServer\profiles\AppSrv01\bin\stopServer.bat server1" />
		</exec>

		<if>
			<or>
				<isset property="hook.plugins.includes" />
				<isset property="plugins.version.includes" />
				<isset property="portlet.plugins.includes" />
				<isset property="portlet.plugins.upgrade.includes" />
				<isset property="theme.plugins.includes" />
				<isset property="web.plugins.includes" />
			</or>
			<then>
				<exec executable="${plink.executable}">
					<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c C:\Progra~1\IBM\WebSphere\AppServer\profiles\AppSrv01\bin\stopServer.bat server1" />
				</exec>
			</then>
		</if>

		<replace
			file="portal-impl/test/test-portal-impl.properties"
			token="localhost:8080"
			value="${vm.host}:9080"
		/>

		<replace
			file="portal-web/test/test-portal-web.properties"
			token="localhost:8080"
			value="${vm.host}:9080"
		/>

		<antcall target="start-selenium" />

		<antcall target="run-websphere-6.1">
			<param name="test.class" value="${test.name}" />
		</antcall>

		<antcall target="stop-selenium" />

		<exec dir="${vm.drive}/${vm.host}" executable="${vmware-cmd.executable}">
			<arg line="${vm.drive}\${vm.host}\${vm.host}.vmx stop hard" />
		</exec>
	</target>

	<target name="run-websphere-6.1">
		<antcall target="rebuild-database" inheritAll="false" />

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c C:\Progra~1\IBM\WebSphere\AppServer\profiles\AppSrv01\bin\startServer.bat server1" />
		</exec>

		<antcall target="run-selenium-test" />

		<exec executable="${plink.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host} cmd.exe /c C:\Progra~1\IBM\WebSphere\AppServer\profiles\AppSrv01\bin\stopServer.bat server1" />
		</exec>

		<exec executable="${pscp.executable}">
			<arg line="-pw ${vm.password} ${vm.username}@${vm.host}:Progra~1/IBM/WebSphere/AppServer/profiles/AppSrv01/logs/server1/SystemOut.log log" />
		</exec>

		<antcall target="evaluate-logs">
			<param name="print.logs" value="true" />
		</antcall>
	</target>
</project>